#!/usr/bin/env node

/**
 * GAS ãƒ•ã‚¡ã‚¤ãƒ«çµåˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * gas/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®è¤‡æ•°ã® .gs ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ã® Bundle.gs ã«çµåˆã—ã¾ã™ã€‚
 * é–‹ç™ºæ™‚ã¯åˆ†å‰²ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½œæ¥­ã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«çµåˆã™ã‚‹ã“ã¨ã§ã€
 * ã‚³ãƒ¼ãƒ‰ã®è¦‹é€šã—ã¨å®Ÿè¡ŒåŠ¹ç‡ã‚’ä¸¡ç«‹ã•ã›ã¾ã™ã€‚
 */

const fs = require('fs');
const path = require('path');

// ãƒ‘ã‚¹è¨­å®š
const GAS_SOURCE_DIR = path.join(__dirname, '..');  // gas/scripts/.. â†’ gas
const DIST_DIR = path.join(__dirname, '..', '..', 'dist');  // gas/scripts/../../dist â†’ dist
const OUTPUT_FILE = path.join(DIST_DIR, 'Bundle.gs');

// çµåˆé †åºï¼ˆä¾å­˜é–¢ä¿‚é †ï¼‰
const FILE_ORDER = [
  'settings.gs',  // å®šæ•°ãƒ»è¨­å®š
  'forms.gs',     // ãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†ï¼ˆGoogle Driveï¼‰
  'model.gs',     // ãƒ¢ãƒ‡ãƒ«é–¢æ•°
  'sheets.gs',    // Sheetsæ“ä½œ
  'Code.gs',      // ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
];

/**
 * dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
 */
function ensureDistDir() {
  if (!fs.existsSync(DIST_DIR)) {
    fs.mkdirSync(DIST_DIR, { recursive: true });
    console.log(`âœ… Created directory: ${DIST_DIR}`);
  }
}

/**
 * GAS ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆ
 */
function bundleGasFiles() {
  const bundledContent = [];

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
  bundledContent.push('/**');
  bundledContent.push(' * Nested Form Builder - GAS Bundle');
  bundledContent.push(` * Generated: ${new Date().toISOString()}`);
  bundledContent.push(' * DO NOT EDIT THIS FILE DIRECTLY');
  bundledContent.push(' * Edit source files in gas/ directory instead');
  bundledContent.push(' */');
  bundledContent.push('');

  // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«çµåˆ
  FILE_ORDER.forEach((fileName) => {
    const filePath = path.join(GAS_SOURCE_DIR, fileName);

    if (!fs.existsSync(filePath)) {
      console.warn(`âš ï¸  Warning: ${fileName} not found, skipping...`);
      return;
    }

    const content = fs.readFileSync(filePath, 'utf8');

    // ãƒ•ã‚¡ã‚¤ãƒ«åŒºåˆ‡ã‚Šã‚³ãƒ¡ãƒ³ãƒˆ
    bundledContent.push('// ' + '='.repeat(77));
    bundledContent.push(`// ${fileName}`);
    bundledContent.push('// ' + '='.repeat(77));
    bundledContent.push('');
    bundledContent.push(content.trim());
    bundledContent.push('');
  });

  // å‡ºåŠ›
  const finalContent = bundledContent.join('\n');
  fs.writeFileSync(OUTPUT_FILE, finalContent, 'utf8');

  console.log(`âœ… Bundle created: ${OUTPUT_FILE}`);
  console.log(`   Size: ${(finalContent.length / 1024).toFixed(2)} KB`);
  console.log(`   Files bundled: ${FILE_ORDER.length}`);
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
function main() {
  try {
    ensureDistDir();
    bundleGasFiles();
    console.log('ğŸ‰ GAS bundling completed successfully!');
  } catch (error) {
    console.error('âŒ Error during bundling:', error.message);
    process.exit(1);
  }
}

// å®Ÿè¡Œ
main();
