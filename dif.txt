diff --git a/builder/src/app/App.jsx b/builder/src/app/App.jsx
index 9cbd20b..2388356 100644
--- a/builder/src/app/App.jsx
+++ b/builder/src/app/App.jsx
@@ -1,23 +1,24 @@
 import React from "react";
 import { HashRouter, Route, Routes, Navigate } from "react-router-dom";
-import { AppDataProvider } from "./state/AppDataProvider.jsx";
-import { AuthProvider, useAuth } from "./state/authContext.jsx";
-import MainPage from "../pages/MainPage.jsx";
-import SearchPage from "../pages/SearchPage.jsx";
-import FormPage from "../pages/FormPage.jsx";
+import { AppDataProvider } from "./state/AppDataProvider.jsx";
+import { AlertProvider } from "./state/AlertProvider.jsx";
+import { AuthProvider, useAuth } from "./state/authContext.jsx";
+import MainPage from "../pages/MainPage.jsx";
+import SearchPage from "../pages/SearchPage.jsx";
+import FormPage from "../pages/FormPage.jsx";
 import AdminDashboardPage from "../pages/AdminDashboardPage.jsx";
 import AdminFormEditorPage from "../pages/AdminFormEditorPage.jsx";
 import AdminSettingsPage from "../pages/AdminSettingsPage.jsx";
 import ConfigPage from "../pages/ConfigPage.jsx";
 import NotFoundPage from "../pages/NotFoundPage.jsx";
-
-/**
- * 管理者専用ルートのラッパー
- * 管理者でない場合はリダイレクト
- */
-function AdminRoute({ children }) {
-  const { isAdmin, formId } = useAuth();
-
+
+/**
+ * 管理者専用ルートのラッパー
+ * 管理者でない場合はリダイレクト
+ */
+function AdminRoute({ children }) {
+  const { isAdmin, formId } = useAuth();
+
   if (!isAdmin) {
     // 一般ユーザーは指定フォームの検索画面へリダイレクト
     if (formId) {
@@ -26,38 +27,38 @@ function AdminRoute({ children }) {
     // formIdもない場合はアクセス拒否状態としてトップへ戻す
     return <Navigate to="/" replace />;
   }
-
-  return children;
-}
-
-/**
- * フォームが見つからないエラー画面
- */
-function FormNotFoundPage() {
-  return (
-    <div className="app-root">
-      <header className="app-header">
-        <div className="app-header-left">
-          <h1 className="app-header-title">フォームが見つかりません</h1>
-        </div>
-      </header>
-      <div className="app-container">
-        <main className="app-main">
-          <div className="nf-card">
-            <p>指定されたフォームは存在しません。</p>
-            <p className="nf-text-muted nf-text-14 nf-mt-8">
-              URLが正しいか確認してください。
-            </p>
-          </div>
-        </main>
-      </div>
-    </div>
-  );
-}
-
-/**
- * 一般ユーザー用の初期リダイレクト処理
- */
+
+  return children;
+}
+
+/**
+ * フォームが見つからないエラー画面
+ */
+function FormNotFoundPage() {
+  return (
+    <div className="app-root">
+      <header className="app-header">
+        <div className="app-header-left">
+          <h1 className="app-header-title">フォームが見つかりません</h1>
+        </div>
+      </header>
+      <div className="app-container">
+        <main className="app-main">
+          <div className="nf-card">
+            <p>指定されたフォームは存在しません。</p>
+            <p className="nf-text-muted nf-text-14 nf-mt-8">
+              URLが正しいか確認してください。
+            </p>
+          </div>
+        </main>
+      </div>
+    </div>
+  );
+}
+
+/**
+ * 一般ユーザー用の初期リダイレクト処理
+ */
 function UserRedirect() {
   const { authError, formId } = useAuth();
 
@@ -75,66 +76,66 @@ function UserRedirect() {
 
   return <MainPage />;
 }
-
-/**
- * アクセス拒否ページ
- */
-function AccessDeniedPage() {
-  return (
-    <div className="app-root">
-      <header className="app-header">
-        <div className="app-header-left">
-          <h1 className="app-header-title">アクセスできません</h1>
-        </div>
-      </header>
-      <div className="app-container">
-        <main className="app-main">
-          <div className="nf-card">
-            <p>このページにアクセスする権限がありません。</p>
-            <p className="nf-text-muted nf-text-14 nf-mt-8">
-              正しいURLでアクセスしているか確認してください。
-            </p>
-          </div>
-        </main>
-      </div>
-    </div>
-  );
-}
-
-/**
- * ルーティング本体
- */
+
+/**
+ * アクセス拒否ページ
+ */
+function AccessDeniedPage() {
+  return (
+    <div className="app-root">
+      <header className="app-header">
+        <div className="app-header-left">
+          <h1 className="app-header-title">アクセスできません</h1>
+        </div>
+      </header>
+      <div className="app-container">
+        <main className="app-main">
+          <div className="nf-card">
+            <p>このページにアクセスする権限がありません。</p>
+            <p className="nf-text-muted nf-text-14 nf-mt-8">
+              正しいURLでアクセスしているか確認してください。
+            </p>
+          </div>
+        </main>
+      </div>
+    </div>
+  );
+}
+
+/**
+ * ルーティング本体
+ */
 function AppRoutes() {
   return (
-    <Routes>
-      <Route path="/" element={<UserRedirect />} />
-      <Route path="/search" element={<SearchPage />} />
-      <Route path="/form/:formId/new" element={<FormPage />} />
-      <Route path="/form/:formId/entry/:entryId" element={<FormPage />} />
-      <Route
-        path="/forms"
-        element={
-          <AdminRoute>
-            <AdminDashboardPage />
-          </AdminRoute>
-        }
-      />
-      <Route
-        path="/forms/new"
-        element={
-          <AdminRoute>
-            <AdminFormEditorPage />
-          </AdminRoute>
-        }
-      />
-      <Route
-        path="/forms/:formId/edit"
-        element={
-          <AdminRoute>
-            <AdminFormEditorPage />
-          </AdminRoute>
-        }
-      />
+    <Routes>
+      <Route path="/" element={<UserRedirect />} />
+      <Route path="/search" element={<SearchPage />} />
+      <Route path="/form/:formId/new" element={<FormPage />} />
+      <Route path="/form/:formId/entry/:entryId" element={<FormPage />} />
+      <Route
+        path="/forms"
+        element={
+          <AdminRoute>
+            <AdminDashboardPage />
+          </AdminRoute>
+        }
+      />
+      <Route
+        path="/forms/new"
+        element={
+          <AdminRoute>
+            <AdminFormEditorPage />
+          </AdminRoute>
+        }
+      />
+      <Route
+        path="/forms/:formId/edit"
+        element={
+          <AdminRoute>
+            <AdminFormEditorPage />
+          </AdminRoute>
+        }
+      />
       <Route
         path="/config"
         element={<ConfigPage />}
@@ -149,18 +150,20 @@ function AppRoutes() {
       />
       <Route path="/not-found" element={<NotFoundPage />} />
       <Route path="*" element={<NotFoundPage />} />
-    </Routes>
-  );
-}
-
-export default function App() {
-  return (
-    <AuthProvider>
-      <AppDataProvider>
-        <HashRouter>
-          <AppRoutes />
-        </HashRouter>
-      </AppDataProvider>
-    </AuthProvider>
-  );
-}
+    </Routes>
+  );
+}
+
+export default function App() {
+  return (
+    <AuthProvider>
+      <AppDataProvider>
+        <AlertProvider>
+        <HashRouter>
+          <AppRoutes />
+        </HashRouter>
+      </AlertProvider>
+      </AppDataProvider>
+    </AuthProvider>
+  );
+}
diff --git a/builder/src/app/hooks/useAlert.js b/builder/src/app/hooks/useAlert.js
index 95fd86b..db38b0d 100644
--- a/builder/src/app/hooks/useAlert.js
+++ b/builder/src/app/hooks/useAlert.js
@@ -1,15 +1,8 @@
-import { useState, useCallback } from "react";
-
-export function useAlert() {
-  const [alertState, setAlertState] = useState({ open: false, title: "", message: "" });
-
-  const showAlert = useCallback((message, title = "通知") => {
-    setAlertState({ open: true, title, message });
-  }, []);
-
-  const closeAlert = useCallback(() => {
-    setAlertState({ open: false, title: "", message: "" });
-  }, []);
-
-  return { alertState, showAlert, closeAlert };
-}
+import { useContext } from "react";
+import { AlertContext } from "../state/AlertProvider.jsx";
+
+export function useAlert() {
+  const ctx = useContext(AlertContext);
+  if (!ctx) throw new Error("useAlert must be used within AlertProvider");
+  return ctx;
+}
diff --git a/builder/src/features/admin/FormBuilderWorkspace.jsx b/builder/src/features/admin/FormBuilderWorkspace.jsx
index fc101d7..2e0e276 100644
--- a/builder/src/features/admin/FormBuilderWorkspace.jsx
+++ b/builder/src/features/admin/FormBuilderWorkspace.jsx
@@ -1,71 +1,70 @@
-import React, { useCallback, useEffect, useImperativeHandle, useMemo, useRef, useState } from "react";
+import React, { useCallback, useEffect, useImperativeHandle, useMemo, useRef, useState } from "react";
 import EditorPage from "../editor/EditorPage.jsx";
 import PreviewPage from "../preview/PreviewPage.jsx";
 import SearchPreviewPanel from "./SearchPreviewPanel.jsx";
 import { useBuilderSettings } from "../settings/settingsStore.js";
 import { normalizeSchemaIDs, validateMaxDepth, validateRequiredLabels, validateUniqueLabels, MAX_DEPTH } from "../../core/schema.js";
 import { runSelfTests } from "../../core/selfTests.js";
-import AlertDialog from "../../app/components/AlertDialog.jsx";
 import { useAlert } from "../../app/hooks/useAlert.js";
 import { omitThemeSetting } from "../../utils/settings.js";
 import { deepEqual } from "../../utils/deepEqual.js";
-
-const FormBuilderWorkspace = React.forwardRef(function FormBuilderWorkspace(
-  { initialSchema, initialSettings, formTitle, onSave, onDirtyChange, showToolbarSave = true },
-  ref,
-) {
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const [activeTab, setActiveTab] = useState("editor");
-  const [schema, setSchema] = useState(() => normalizeSchemaIDs(initialSchema || []));
-  const [responses, setResponses] = useState({});
-  const { settings, replaceSettings, updateSetting } = useBuilderSettings();
-  const initialSchemaRef = useRef(null);
-  const initialSettingsRef = useRef(null);
-  const [questionControl, setQuestionControl] = useState(null);
-  const [isInitialized, setIsInitialized] = useState(false);
-
-  useEffect(() => {
-    runSelfTests();
-  }, []);
-
-  // initialSchema/initialSettingsが変わったら、リセット
-  useEffect(() => {
-    const normalized = normalizeSchemaIDs(initialSchema || []);
-    setSchema(normalized);
-    // replaceSettingsはマージ後の値を返すので、それを初期値として記録
-    const mergedSettings = replaceSettings(initialSettings || {});
-
-    initialSchemaRef.current = normalized;
-    initialSettingsRef.current = mergedSettings;
-    setIsInitialized(true);
-    onDirtyChange?.(false);
-  }, [initialSchema, initialSettings, replaceSettings, onDirtyChange]);
-
-  // schema/settingsが変わったらdirty判定（初期化完了後のみ）
-  useEffect(() => {
-    if (!isInitialized) {
-      return;
-    }
-    if (initialSchemaRef.current === null || initialSettingsRef.current === null) {
-      return;
-    }
-
+
+const FormBuilderWorkspace = React.forwardRef(function FormBuilderWorkspace(
+  { initialSchema, initialSettings, formTitle, onSave, onDirtyChange, showToolbarSave = true },
+  ref,
+) {
+  const { showAlert } = useAlert();
+const [activeTab, setActiveTab] = useState("editor");
+  const [schema, setSchema] = useState(() => normalizeSchemaIDs(initialSchema || []));
+  const [responses, setResponses] = useState({});
+  const { settings, replaceSettings, updateSetting } = useBuilderSettings();
+  const initialSchemaRef = useRef(null);
+  const initialSettingsRef = useRef(null);
+  const [questionControl, setQuestionControl] = useState(null);
+  const [isInitialized, setIsInitialized] = useState(false);
+
+  useEffect(() => {
+    runSelfTests();
+  }, []);
+
+  // initialSchema/initialSettingsが変わったら、リセット
+  useEffect(() => {
+    const normalized = normalizeSchemaIDs(initialSchema || []);
+    setSchema(normalized);
+    // replaceSettingsはマージ後の値を返すので、それを初期値として記録
+    const mergedSettings = replaceSettings(initialSettings || {});
+
+    initialSchemaRef.current = normalized;
+    initialSettingsRef.current = mergedSettings;
+    setIsInitialized(true);
+    onDirtyChange?.(false);
+  }, [initialSchema, initialSettings, replaceSettings, onDirtyChange]);
+
+  // schema/settingsが変わったらdirty判定（初期化完了後のみ）
+  useEffect(() => {
+    if (!isInitialized) {
+      return;
+    }
+    if (initialSchemaRef.current === null || initialSettingsRef.current === null) {
+      return;
+    }
+
     const schemaDirty = !deepEqual(initialSchemaRef.current, schema);
     const settingsDirty = !deepEqual(omitThemeSetting(initialSettingsRef.current), omitThemeSetting(settings));
-
-    onDirtyChange?.(schemaDirty || settingsDirty);
-  }, [schema, settings, isInitialized, onDirtyChange]);
-
-  const handleSchemaChange = (nextSchema) => {
-    const normalized = normalizeSchemaIDs(nextSchema);
-    const depthCheck = validateMaxDepth(normalized, MAX_DEPTH);
-    if (!depthCheck.ok) {
-      showAlert(`入れ子（キー）の深さは ${MAX_DEPTH} 段までです（現在: ${depthCheck.depth} 段）。`);
-      return;
-    }
-    setSchema(normalized);
-  };
-
+
+    onDirtyChange?.(schemaDirty || settingsDirty);
+  }, [schema, settings, isInitialized, onDirtyChange]);
+
+  const handleSchemaChange = (nextSchema) => {
+    const normalized = normalizeSchemaIDs(nextSchema);
+    const depthCheck = validateMaxDepth(normalized, MAX_DEPTH);
+    if (!depthCheck.ok) {
+      showAlert(`入れ子（キー）の深さは ${MAX_DEPTH} 段までです（現在: ${depthCheck.depth} 段）。`);
+      return;
+    }
+    setSchema(normalized);
+  };
+
   const handleSave = useCallback(() => {
     const labelCheck = validateRequiredLabels(schema);
     if (!labelCheck.ok) {
@@ -77,70 +76,69 @@ const FormBuilderWorkspace = React.forwardRef(function FormBuilderWorkspace(
     const uniqueCheck = validateUniqueLabels(schema);
     if (!uniqueCheck.ok) {
       showAlert(`重複する項目名: ${uniqueCheck.dup}`);
-      return false;
-    }
-
-    initialSchemaRef.current = schema;
-    initialSettingsRef.current = settings;
-    onDirtyChange?.(false);
-    onSave?.({ schema, settings });
-    return true;
-  }, [onSave, schema, settings, onDirtyChange, showAlert]);
-
-  useImperativeHandle(
-    ref,
-    () => ({
-      save: handleSave,
-      getSchema: () => schema,
-      getSettings: () => settings,
-      updateSetting: updateSetting,
-      setMode: setActiveTab,
-      getQuestionControl: () => questionControl,
-    }),
-    [handleSave, schema, settings, updateSetting, questionControl],
-  );
-
-  const previewSettings = useMemo(() => ({ ...settings, formTitle }), [settings, formTitle]);
-
-  return (
-    <div className="form-builder">
-      <div className="form-builder-header">
-        <div className="form-builder-title">{formTitle || "フォーム"}</div>
-        <div className="form-builder-tabs">
-          <button type="button" className="form-builder-tab" data-active={activeTab === "editor" ? "true" : "false"} onClick={() => setActiveTab("editor")}>
-            編集
-          </button>
-          <button type="button" className="form-builder-tab" data-active={activeTab === "preview" ? "true" : "false"} onClick={() => setActiveTab("preview")}>
-            プレビュー
-          </button>
-          {showToolbarSave && (
-            <button type="button" className="form-builder-tab" data-active="false" onClick={handleSave}>
-              保存
-            </button>
-          )}
-        </div>
-      </div>
-
-      {activeTab === "editor" && (
-        <EditorPage schema={schema} onSchemaChange={handleSchemaChange} onQuestionControlChange={setQuestionControl} />
-      )}
-
-      {activeTab === "preview" && (
-        <>
-          <PreviewPage
-            schema={schema}
-            responses={responses}
-            setResponses={setResponses}
-            settings={previewSettings}
-            showOutputJson={false}
-            showSaveButton={false}
-          />
-          <SearchPreviewPanel schema={schema} responses={responses} settings={settings} />
-        </>
-      )}
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </div>
-  );
-});
-
-export default FormBuilderWorkspace;
+      return false;
+    }
+
+    initialSchemaRef.current = schema;
+    initialSettingsRef.current = settings;
+    onDirtyChange?.(false);
+    onSave?.({ schema, settings });
+    return true;
+  }, [onSave, schema, settings, onDirtyChange, showAlert]);
+
+  useImperativeHandle(
+    ref,
+    () => ({
+      save: handleSave,
+      getSchema: () => schema,
+      getSettings: () => settings,
+      updateSetting: updateSetting,
+      setMode: setActiveTab,
+      getQuestionControl: () => questionControl,
+    }),
+    [handleSave, schema, settings, updateSetting, questionControl],
+  );
+
+  const previewSettings = useMemo(() => ({ ...settings, formTitle }), [settings, formTitle]);
+
+  return (
+    <div className="form-builder">
+      <div className="form-builder-header">
+        <div className="form-builder-title">{formTitle || "フォーム"}</div>
+        <div className="form-builder-tabs">
+          <button type="button" className="form-builder-tab" data-active={activeTab === "editor" ? "true" : "false"} onClick={() => setActiveTab("editor")}>
+            編集
+          </button>
+          <button type="button" className="form-builder-tab" data-active={activeTab === "preview" ? "true" : "false"} onClick={() => setActiveTab("preview")}>
+            プレビュー
+          </button>
+          {showToolbarSave && (
+            <button type="button" className="form-builder-tab" data-active="false" onClick={handleSave}>
+              保存
+            </button>
+          )}
+        </div>
+      </div>
+
+      {activeTab === "editor" && (
+        <EditorPage schema={schema} onSchemaChange={handleSchemaChange} onQuestionControlChange={setQuestionControl} />
+      )}
+
+      {activeTab === "preview" && (
+        <>
+          <PreviewPage
+            schema={schema}
+            responses={responses}
+            setResponses={setResponses}
+            settings={previewSettings}
+            showOutputJson={false}
+            showSaveButton={false}
+          />
+          <SearchPreviewPanel schema={schema} responses={responses} settings={settings} />
+        </>
+      )}
+</div>
+  );
+});
+
+export default FormBuilderWorkspace;
diff --git a/builder/src/features/editor/QuestionList.jsx b/builder/src/features/editor/QuestionList.jsx
index d7e6ab1..59d2da7 100644
--- a/builder/src/features/editor/QuestionList.jsx
+++ b/builder/src/features/editor/QuestionList.jsx
@@ -1,191 +1,189 @@
-import React from "react";
-import { deepClone, normalizeSchemaIDs, validateMaxDepth, MAX_DEPTH } from "../../core/schema.js";
-import { genId } from "../../core/ids.js";
-import QuestionCard from "./QuestionCard.jsx";
-import AlertDialog from "../../app/components/AlertDialog.jsx";
-import { useAlert } from "../../app/hooks/useAlert.js";
-
-/**
- * スキーマのバリデーションを実行
- * 入力中は深さチェックのみ行い、重複チェックは保存時のみ実施
- * @returns {object} { ok: boolean, error: string | null }
- */
-function validateSchema(schema) {
-  const depthResult = validateMaxDepth(schema, MAX_DEPTH);
-  if (!depthResult.ok) {
-    return { ok: false, error: `入れ子(キー)の深さは ${MAX_DEPTH} 段までです(現在: ${depthResult.depth} 段)。` };
-  }
-
-  return { ok: true, error: null };
-}
-
-/**
- * 配列の要素を入れ替える
- */
-function swapItems(array, index1, index2) {
-  const next = deepClone(array);
-  [next[index1], next[index2]] = [next[index2], next[index1]];
-  return next;
-}
-
-/**
- * 質問制御情報を生成
- */
-function buildQuestionControlInfo(selectedIndex, normalized, moveUp, moveDown) {
-  if (selectedIndex === null) {
-    return {
-      selectedIndex: null,
-      questionLabel: null,
-      canMoveUp: false,
-      canMoveDown: false,
-      moveUp: () => {},
-      moveDown: () => {},
-      isOption: false
-    };
-  }
-
-  const questionLabel = normalized[selectedIndex]?.label || `質問 ${selectedIndex + 1}`;
-  const canMoveUp = selectedIndex > 0;
-  const canMoveDown = selectedIndex < normalized.length - 1;
-
-  return {
-    selectedIndex,
-    questionLabel,
-    canMoveUp,
-    canMoveDown,
-    moveUp: () => moveUp(selectedIndex),
-    moveDown: () => moveDown(selectedIndex),
-    isOption: false
-  };
-}
-
-/**
- * 選択肢制御情報を生成
- */
-function buildOptionControlInfo(selectedIndex, optionControl, normalized) {
-  const questionLabel = selectedIndex !== null ? normalized[selectedIndex]?.label || `質問 ${selectedIndex + 1}` : null;
-
-  return {
-    selectedIndex,
-    questionLabel,
-    canMoveUp: optionControl.canMoveUp,
-    canMoveDown: optionControl.canMoveDown,
-    moveUp: optionControl.moveUp,
-    moveDown: optionControl.moveDown,
-    isOption: true,
-    optionIndex: optionControl.optionIndex,
-    optionLabel: optionControl.optionLabel
-  };
-}
-
-export default function QuestionList({ fields, onChange, depth = 1, onQuestionControlChange }) {
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const normalized = normalizeSchemaIDs(fields);
-  const [selectedIndex, setSelectedIndex] = React.useState(null);
-  const [optionControl, setOptionControl] = React.useState(null);
-
-  React.useEffect(() => {
-    if (depth === 1 && onQuestionControlChange) {
-      let controlInfo;
-
-      // 選択肢が選択されている場合は、選択肢の制御情報を使う
-      if (optionControl && optionControl.type === 'option') {
-        controlInfo = buildOptionControlInfo(selectedIndex, optionControl, normalized);
-      } else {
-        // 質問が選択されている場合
-        controlInfo = buildQuestionControlInfo(selectedIndex, normalized, moveUp, moveDown);
-      }
-
-      onQuestionControlChange(controlInfo);
-    }
-  }, [selectedIndex, optionControl, normalized.length, depth]);
-
-  const commit = (next) => {
-    const fixed = normalizeSchemaIDs(next);
-    const validation = validateSchema(fixed);
-    if (!validation.ok) {
-      showAlert(validation.error);
-      return;
-    }
-    onChange(fixed);
-  };
-
-  const setOne = (index, field) => {
-    const next = deepClone(normalized);
-    next[index] = field.id ? field : { ...field, id: genId() };
-    commit(next);
-  };
-
-  const insertAfter = (index) => {
-    const next = deepClone(normalized);
-    next.splice(index + 1, 0, { id: genId(), type: "text", label: "" });
-    commit(next);
-  };
-
-  const removeOne = (index) => {
-    const next = deepClone(normalized);
-    next.splice(index, 1);
-    commit(next);
-    if (selectedIndex === index) {
-      setSelectedIndex(null);
-    } else if (selectedIndex > index) {
-      setSelectedIndex(selectedIndex - 1);
-    }
-  };
-
-  const moveUp = (index) => {
-    if (index === 0) return;
-    const next = swapItems(normalized, index - 1, index);
-    commit(next);
-    if (selectedIndex === index) {
-      setSelectedIndex(index - 1);
-    } else if (selectedIndex === index - 1) {
-      setSelectedIndex(index);
-    }
-  };
-
-  const moveDown = (index) => {
-    if (index === normalized.length - 1) return;
-    const next = swapItems(normalized, index, index + 1);
-    commit(next);
-    if (selectedIndex === index) {
-      setSelectedIndex(index + 1);
-    } else if (selectedIndex === index + 1) {
-      setSelectedIndex(index);
-    }
-  };
-
-  const canMoveUp = selectedIndex !== null && selectedIndex > 0;
-  const canMoveDown = selectedIndex !== null && selectedIndex < normalized.length - 1;
-
-  return (
-    <>
+import React from "react";
+import { deepClone, normalizeSchemaIDs, validateMaxDepth, MAX_DEPTH } from "../../core/schema.js";
+import { genId } from "../../core/ids.js";
+import QuestionCard from "./QuestionCard.jsx";
+import { useAlert } from "../../app/hooks/useAlert.js";
+
+/**
+ * スキーマのバリデーションを実行
+ * 入力中は深さチェックのみ行い、重複チェックは保存時のみ実施
+ * @returns {object} { ok: boolean, error: string | null }
+ */
+function validateSchema(schema) {
+  const depthResult = validateMaxDepth(schema, MAX_DEPTH);
+  if (!depthResult.ok) {
+    return { ok: false, error: `入れ子(キー)の深さは ${MAX_DEPTH} 段までです(現在: ${depthResult.depth} 段)。` };
+  }
+
+  return { ok: true, error: null };
+}
+
+/**
+ * 配列の要素を入れ替える
+ */
+function swapItems(array, index1, index2) {
+  const next = deepClone(array);
+  [next[index1], next[index2]] = [next[index2], next[index1]];
+  return next;
+}
+
+/**
+ * 質問制御情報を生成
+ */
+function buildQuestionControlInfo(selectedIndex, normalized, moveUp, moveDown) {
+  if (selectedIndex === null) {
+    return {
+      selectedIndex: null,
+      questionLabel: null,
+      canMoveUp: false,
+      canMoveDown: false,
+      moveUp: () => {},
+      moveDown: () => {},
+      isOption: false
+    };
+  }
+
+  const questionLabel = normalized[selectedIndex]?.label || `質問 ${selectedIndex + 1}`;
+  const canMoveUp = selectedIndex > 0;
+  const canMoveDown = selectedIndex < normalized.length - 1;
+
+  return {
+    selectedIndex,
+    questionLabel,
+    canMoveUp,
+    canMoveDown,
+    moveUp: () => moveUp(selectedIndex),
+    moveDown: () => moveDown(selectedIndex),
+    isOption: false
+  };
+}
+
+/**
+ * 選択肢制御情報を生成
+ */
+function buildOptionControlInfo(selectedIndex, optionControl, normalized) {
+  const questionLabel = selectedIndex !== null ? normalized[selectedIndex]?.label || `質問 ${selectedIndex + 1}` : null;
+
+  return {
+    selectedIndex,
+    questionLabel,
+    canMoveUp: optionControl.canMoveUp,
+    canMoveDown: optionControl.canMoveDown,
+    moveUp: optionControl.moveUp,
+    moveDown: optionControl.moveDown,
+    isOption: true,
+    optionIndex: optionControl.optionIndex,
+    optionLabel: optionControl.optionLabel
+  };
+}
+
+export default function QuestionList({ fields, onChange, depth = 1, onQuestionControlChange }) {
+  const { showAlert } = useAlert();
+const normalized = normalizeSchemaIDs(fields);
+  const [selectedIndex, setSelectedIndex] = React.useState(null);
+  const [optionControl, setOptionControl] = React.useState(null);
+
+  React.useEffect(() => {
+    if (depth === 1 && onQuestionControlChange) {
+      let controlInfo;
+
+      // 選択肢が選択されている場合は、選択肢の制御情報を使う
+      if (optionControl && optionControl.type === 'option') {
+        controlInfo = buildOptionControlInfo(selectedIndex, optionControl, normalized);
+      } else {
+        // 質問が選択されている場合
+        controlInfo = buildQuestionControlInfo(selectedIndex, normalized, moveUp, moveDown);
+      }
+
+      onQuestionControlChange(controlInfo);
+    }
+  }, [selectedIndex, optionControl, normalized.length, depth]);
+
+  const commit = (next) => {
+    const fixed = normalizeSchemaIDs(next);
+    const validation = validateSchema(fixed);
+    if (!validation.ok) {
+      showAlert(validation.error);
+      return;
+    }
+    onChange(fixed);
+  };
+
+  const setOne = (index, field) => {
+    const next = deepClone(normalized);
+    next[index] = field.id ? field : { ...field, id: genId() };
+    commit(next);
+  };
+
+  const insertAfter = (index) => {
+    const next = deepClone(normalized);
+    next.splice(index + 1, 0, { id: genId(), type: "text", label: "" });
+    commit(next);
+  };
+
+  const removeOne = (index) => {
+    const next = deepClone(normalized);
+    next.splice(index, 1);
+    commit(next);
+    if (selectedIndex === index) {
+      setSelectedIndex(null);
+    } else if (selectedIndex > index) {
+      setSelectedIndex(selectedIndex - 1);
+    }
+  };
+
+  const moveUp = (index) => {
+    if (index === 0) return;
+    const next = swapItems(normalized, index - 1, index);
+    commit(next);
+    if (selectedIndex === index) {
+      setSelectedIndex(index - 1);
+    } else if (selectedIndex === index - 1) {
+      setSelectedIndex(index);
+    }
+  };
+
+  const moveDown = (index) => {
+    if (index === normalized.length - 1) return;
+    const next = swapItems(normalized, index, index + 1);
+    commit(next);
+    if (selectedIndex === index) {
+      setSelectedIndex(index + 1);
+    } else if (selectedIndex === index + 1) {
+      setSelectedIndex(index);
+    }
+  };
+
+  const canMoveUp = selectedIndex !== null && selectedIndex > 0;
+  const canMoveDown = selectedIndex !== null && selectedIndex < normalized.length - 1;
+
+  return (
+    <>
       <div className="nf-col nf-gap-12">
-        {normalized.map((field, index) => (
-          <QuestionCard
-            key={field.id}
-            field={field}
-            onChange={(nextField) => setOne(index, nextField)}
-            onAddBelow={() => insertAfter(index)}
-            onDelete={() => removeOne(index)}
-            onFocus={(controlInfo) => {
-              if (controlInfo && typeof controlInfo === 'object') {
-                // 選択肢が選択された場合
-                setSelectedIndex(index);
-                setOptionControl(controlInfo);
-              } else {
-                // 質問が選択された場合
-                setSelectedIndex(index);
-                setOptionControl(null);
-              }
-            }}
-            isSelected={selectedIndex === index}
-            QuestionListComponent={QuestionList}
-            depth={depth}
-          />
-        ))}
-      </div>
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </>
-  );
-}
+        {normalized.map((field, index) => (
+          <QuestionCard
+            key={field.id}
+            field={field}
+            onChange={(nextField) => setOne(index, nextField)}
+            onAddBelow={() => insertAfter(index)}
+            onDelete={() => removeOne(index)}
+            onFocus={(controlInfo) => {
+              if (controlInfo && typeof controlInfo === 'object') {
+                // 選択肢が選択された場合
+                setSelectedIndex(index);
+                setOptionControl(controlInfo);
+              } else {
+                // 質問が選択された場合
+                setSelectedIndex(index);
+                setOptionControl(null);
+              }
+            }}
+            isSelected={selectedIndex === index}
+            QuestionListComponent={QuestionList}
+            depth={depth}
+          />
+        ))}
+      </div>
+</>
+  );
+}
diff --git a/builder/src/features/preview/PreviewPage.jsx b/builder/src/features/preview/PreviewPage.jsx
index 644e657..7c9188c 100644
--- a/builder/src/features/preview/PreviewPage.jsx
+++ b/builder/src/features/preview/PreviewPage.jsx
@@ -5,100 +5,99 @@ import { collectValidationErrors, formatValidationErrors, validateByPattern } fr
 import { submitResponses, hasScriptRun } from "../../services/gasClient.js";
 import { normalizeSpreadsheetId } from "../../utils/spreadsheet.js";
 import { styles as s } from "../editor/styles.js";
-import AlertDialog from "../../app/components/AlertDialog.jsx";
 import { useAlert } from "../../app/hooks/useAlert.js";
 import { collectDefaultNowResponses } from "../../utils/responses.js";
 import { resolveLabelSize } from "../../core/styleSettings.js";
-
-const generateRecordId = () => {
-  if (window.crypto?.getRandomValues) {
-    const bytes = new Uint8Array(12);
-    window.crypto.getRandomValues(bytes);
-    return `r_${Array.from(bytes)
-      .map((b) => (`0${b.toString(16)}`).slice(-2))
-      .join("")}`;
-  }
-  return `r_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
-};
-
-
-const FieldRenderer = ({ field, value, onChange, renderChildrenAll, renderChildrenForOption, readOnly = false }) => {
-  const validation = validateByPattern(field, value);
-
-  const renderReadOnlyValue = () => {
-    if (field.type === "checkboxes" && Array.isArray(value)) return value.join(", ");
-    if (Array.isArray(value)) return value.join(", ");
-    if (value === undefined || value === null || value === "") return "—";
-    if (field.type === "url" && value) {
-      return (
-        <a href={value} target="_blank" rel="noopener noreferrer" className="nf-link">
-          {value}
-        </a>
-      );
-    }
-    return String(value);
-  };
-
-  // スタイル設定を適用
-  const styleSettings = field.styleSettings || {};
-  const labelSize = resolveLabelSize(styleSettings);
-  const labelStyleVars = {
-    ...(labelSize === "smallest" ? { "--label-font-size-offset": "var(--label-size-offset-xs)" } : {}),
-    ...(labelSize === "smaller" ? { "--label-font-size-offset": "var(--label-size-offset-sm)" } : {}),
-    ...(labelSize === "larger" ? { "--label-font-size-offset": "var(--label-size-offset-lg)" } : {}),
-    ...(labelSize === "largest" ? { "--label-font-size-offset": "var(--label-size-offset-xl)" } : {}),
-    ...(styleSettings.textColor ? { "--label-color": styleSettings.textColor } : {}),
-  };
-
-  // メッセージタイプの場合はラベルのみ表示
-  if (field.type === "message") {
-    return (
-      <div className="preview-field">
-        <div className="preview-label" style={labelStyleVars}>
-          {field.label || <span className="nf-text-faded">メッセージ</span>}
-        </div>
-      </div>
-    );
-  }
-
-  if (readOnly) {
-    const childrenForCheckboxes =
-      field.type === "checkboxes" && renderChildrenForOption
-        ? (Array.isArray(value) ? value : []).map((label) => (
-            <div key={`ro_child_${field.id}_${label}`} className={s.child.className}>
-              {renderChildrenForOption(label)}
-            </div>
-          ))
-        : null;
-
-    const childrenCommon =
-      field.type !== "checkboxes" && renderChildrenAll
-        ? <div className={s.child.className}>{renderChildrenAll()}</div>
-        : null;
-
-    const readOnlyClassName =
-      field.type === "textarea" ? "nf-input nf-input--readonly nf-textarea-readonly" : "nf-input nf-input--readonly";
-
-    return (
-      <div className="preview-field">
-        <label className="preview-label" style={labelStyleVars}>
-          {field.label || <span className="nf-text-faded">項目</span>}
-          {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
-        </label>
-        <div className={readOnlyClassName}>{renderReadOnlyValue()}</div>
-        {childrenForCheckboxes}
-        {childrenCommon}
-      </div>
-    );
-  }
-
-  return (
-    <div className="preview-field">
-      <label className="preview-label" style={labelStyleVars}>
-        {field.label || <span className="nf-text-faded">項目</span>}
-        {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
-      </label>
-
+
+const generateRecordId = () => {
+  if (window.crypto?.getRandomValues) {
+    const bytes = new Uint8Array(12);
+    window.crypto.getRandomValues(bytes);
+    return `r_${Array.from(bytes)
+      .map((b) => (`0${b.toString(16)}`).slice(-2))
+      .join("")}`;
+  }
+  return `r_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
+};
+
+
+const FieldRenderer = ({ field, value, onChange, renderChildrenAll, renderChildrenForOption, readOnly = false }) => {
+  const validation = validateByPattern(field, value);
+
+  const renderReadOnlyValue = () => {
+    if (field.type === "checkboxes" && Array.isArray(value)) return value.join(", ");
+    if (Array.isArray(value)) return value.join(", ");
+    if (value === undefined || value === null || value === "") return "—";
+    if (field.type === "url" && value) {
+      return (
+        <a href={value} target="_blank" rel="noopener noreferrer" className="nf-link">
+          {value}
+        </a>
+      );
+    }
+    return String(value);
+  };
+
+  // スタイル設定を適用
+  const styleSettings = field.styleSettings || {};
+  const labelSize = resolveLabelSize(styleSettings);
+  const labelStyleVars = {
+    ...(labelSize === "smallest" ? { "--label-font-size-offset": "var(--label-size-offset-xs)" } : {}),
+    ...(labelSize === "smaller" ? { "--label-font-size-offset": "var(--label-size-offset-sm)" } : {}),
+    ...(labelSize === "larger" ? { "--label-font-size-offset": "var(--label-size-offset-lg)" } : {}),
+    ...(labelSize === "largest" ? { "--label-font-size-offset": "var(--label-size-offset-xl)" } : {}),
+    ...(styleSettings.textColor ? { "--label-color": styleSettings.textColor } : {}),
+  };
+
+  // メッセージタイプの場合はラベルのみ表示
+  if (field.type === "message") {
+    return (
+      <div className="preview-field">
+        <div className="preview-label" style={labelStyleVars}>
+          {field.label || <span className="nf-text-faded">メッセージ</span>}
+        </div>
+      </div>
+    );
+  }
+
+  if (readOnly) {
+    const childrenForCheckboxes =
+      field.type === "checkboxes" && renderChildrenForOption
+        ? (Array.isArray(value) ? value : []).map((label) => (
+            <div key={`ro_child_${field.id}_${label}`} className={s.child.className}>
+              {renderChildrenForOption(label)}
+            </div>
+          ))
+        : null;
+
+    const childrenCommon =
+      field.type !== "checkboxes" && renderChildrenAll
+        ? <div className={s.child.className}>{renderChildrenAll()}</div>
+        : null;
+
+    const readOnlyClassName =
+      field.type === "textarea" ? "nf-input nf-input--readonly nf-textarea-readonly" : "nf-input nf-input--readonly";
+
+    return (
+      <div className="preview-field">
+        <label className="preview-label" style={labelStyleVars}>
+          {field.label || <span className="nf-text-faded">項目</span>}
+          {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
+        </label>
+        <div className={readOnlyClassName}>{renderReadOnlyValue()}</div>
+        {childrenForCheckboxes}
+        {childrenCommon}
+      </div>
+    );
+  }
+
+  return (
+    <div className="preview-field">
+      <label className="preview-label" style={labelStyleVars}>
+        {field.label || <span className="nf-text-faded">項目</span>}
+        {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
+      </label>
+
       {(field.type === "text" || field.type === "userName") && (
         <input
           type="text"
@@ -108,257 +107,257 @@ const FieldRenderer = ({ field, value, onChange, renderChildrenAll, renderChildr
           placeholder={field.type === "userName" ? "入力ユーザー名" : (field.placeholder || "入力")}
         />
       )}
-
-      {field.type === "textarea" && (
-        <textarea
-          value={value ?? ""}
-          onChange={(event) => onChange(event.target.value)}
-          className={`${s.input.className} nf-h-96`}
-          placeholder={field.placeholder || "入力"}
-        />
-      )}
-
-      {field.type === "number" && (
-        <input
-          type="number"
-          value={value ?? ""}
-          onChange={(event) => {
-            const val = event.target.value;
-            onChange(val === "" ? "" : Number(val));
-          }}
-          className={s.input.className}
-          placeholder={field.placeholder || ""}
-        />
-      )}
-
-      {field.type === "regex" && (
-        <>
-          <input
-            type="text"
-            value={value ?? ""}
-            onChange={(event) => onChange(event.target.value)}
-            className={validation.ok ? s.input.className : `${s.input.className} nf-input--error`}
-            placeholder={field.placeholder || "入力"}
-          />
-          {!validation.ok && (
-            <div className="nf-text-danger-ink nf-text-12 nf-mt-4">{validation.message}</div>
-          )}
-        </>
-      )}
-
-      {field.type === "date" && (
-        <input
-          type="date"
-          value={value ?? ""}
-          onChange={(event) => onChange(event.target.value)}
-          className={s.input.className}
-        />
-      )}
-
-      {field.type === "time" && (
-        <input
-          type="time"
-          value={value ?? ""}
-          onChange={(event) => onChange(event.target.value)}
-          className={s.input.className}
-        />
-      )}
-
-      {field.type === "url" && (
-        <input
-          type="url"
-          value={value ?? ""}
-          onChange={(event) => onChange(event.target.value)}
-          className={s.input.className}
-          placeholder={field.placeholder || "https://example.com"}
-        />
-      )}
-
-      {field.type === "radio" && (
-        <div>
-          {(field.options || []).map((opt) => (
-            <label key={opt.id} className="nf-block nf-mb-4">
-              <input type="radio" name={field.id} checked={value === opt.label} onChange={() => onChange(opt.label)} />
-              <span className="nf-ml-6">{opt.label || "選択肢"}</span>
-            </label>
-          ))}
-        </div>
-      )}
-
-      {field.type === "select" && (
-        <select value={value ?? ""} onChange={(event) => onChange(event.target.value)} className={s.input.className}>
-          <option value="">-- 未選択 --</option>
-          {(field.options || []).map((opt) => (
-            <option key={opt.id} value={opt.label}>
-              {opt.label || "選択肢"}
-            </option>
-          ))}
-        </select>
-      )}
-
-      {field.type === "checkboxes" && (
-        <div>
-          {(field.options || []).map((opt) => {
-            const arr = Array.isArray(value) ? value : [];
-            const checked = arr.includes(opt.label);
-            return (
-              <div key={opt.id} className="nf-mb-4">
-                <label>
-                  <input
-                    type="checkbox"
-                    checked={checked}
-                    onChange={(event) => {
-                      const next = new Set(arr);
-                      event.target.checked ? next.add(opt.label) : next.delete(opt.label);
-                      onChange(Array.from(next));
-                    }}
-                  />
-                  <span className="nf-ml-6">{opt.label || "選択肢"}</span>
-                </label>
-                {checked && renderChildrenForOption && (
-                  <div className={s.child.className}>{renderChildrenForOption(opt.label)}</div>
-                )}
-              </div>
-            );
-          })}
-        </div>
-      )}
-
-      {renderChildrenAll && field.type !== "checkboxes" && <div className={s.child.className}>{renderChildrenAll()}</div>}
-    </div>
-  );
-};
-
-const RendererRecursive = ({ fields, responses, onChange, depth = 0, readOnly = false }) => {
-  const renderChildrenAll = (field, fid) => () => {
-    if (!field?.childrenByValue) return null;
-    if (["radio", "select"].includes(field.type)) {
-      const selected = (responses || {})[fid];
-      if (!selected) return null;
-      return (
-        <RendererRecursive
-          fields={field.childrenByValue[selected] || []}
-          responses={responses}
-          onChange={onChange}
-          depth={depth + 1}
-          readOnly={readOnly}
-        />
-      );
-    }
-    if (field.type === "checkboxes") {
-      const arr = Array.isArray((responses || {})[fid]) ? (responses || {})[fid] : [];
-      return arr.map((label) => (
-        <RendererRecursive
-          key={`child_${fid}_${label}`}
-          fields={field.childrenByValue[label] || []}
-          responses={responses}
-          onChange={onChange}
-          depth={depth + 1}
-          readOnly={readOnly}
-        />
-      ));
-    }
-    return null;
-  };
-
-  const renderChildrenForOption = (field, fid, optionLabel) => {
-    if (!field?.childrenByValue) return null;
-    return (
-      <RendererRecursive
-        fields={field.childrenByValue[optionLabel] || []}
-        responses={responses}
-        onChange={onChange}
-        depth={depth + 1}
-      />
-    );
-  };
-
-  return (
-    <div>
-      {(fields || []).map((field, index) => {
-        const fid = field?.id || `tmp_${depth}_${index}_${field?.label || ""}`;
-        const value = (responses || {})[fid] ?? (responses || {})[field?.id];
-        const cardAttrs = s.card(depth, false);
-        return (
-          <div key={`node_${fid}`} className={cardAttrs.className} data-depth={cardAttrs["data-depth"]}>
-            <FieldRenderer
-              field={{ ...field, id: fid }}
-              value={value}
-              onChange={(nextValue) => onChange((prev) => ({ ...(prev || {}), [fid]: nextValue }))}
-              renderChildrenAll={renderChildrenAll(field, fid)}
-              renderChildrenForOption={(label) => renderChildrenForOption(field, fid, label)}
-              readOnly={readOnly}
-            />
-          </div>
-        );
-      })}
-    </div>
-  );
-};
-
-const PreviewPage = React.forwardRef(function PreviewPage(
-  {
-    schema,
-    responses,
-    setResponses,
-    settings = {},
-    showOutputJson = true,
-    onSave,
-    saveButtonLabel = "回答保存",
-    showSaveButton = true,
-    readOnly = false,
-  },
-  ref,
+
+      {field.type === "textarea" && (
+        <textarea
+          value={value ?? ""}
+          onChange={(event) => onChange(event.target.value)}
+          className={`${s.input.className} nf-h-96`}
+          placeholder={field.placeholder || "入力"}
+        />
+      )}
+
+      {field.type === "number" && (
+        <input
+          type="number"
+          value={value ?? ""}
+          onChange={(event) => {
+            const val = event.target.value;
+            onChange(val === "" ? "" : Number(val));
+          }}
+          className={s.input.className}
+          placeholder={field.placeholder || ""}
+        />
+      )}
+
+      {field.type === "regex" && (
+        <>
+          <input
+            type="text"
+            value={value ?? ""}
+            onChange={(event) => onChange(event.target.value)}
+            className={validation.ok ? s.input.className : `${s.input.className} nf-input--error`}
+            placeholder={field.placeholder || "入力"}
+          />
+          {!validation.ok && (
+            <div className="nf-text-danger-ink nf-text-12 nf-mt-4">{validation.message}</div>
+          )}
+        </>
+      )}
+
+      {field.type === "date" && (
+        <input
+          type="date"
+          value={value ?? ""}
+          onChange={(event) => onChange(event.target.value)}
+          className={s.input.className}
+        />
+      )}
+
+      {field.type === "time" && (
+        <input
+          type="time"
+          value={value ?? ""}
+          onChange={(event) => onChange(event.target.value)}
+          className={s.input.className}
+        />
+      )}
+
+      {field.type === "url" && (
+        <input
+          type="url"
+          value={value ?? ""}
+          onChange={(event) => onChange(event.target.value)}
+          className={s.input.className}
+          placeholder={field.placeholder || "https://example.com"}
+        />
+      )}
+
+      {field.type === "radio" && (
+        <div>
+          {(field.options || []).map((opt) => (
+            <label key={opt.id} className="nf-block nf-mb-4">
+              <input type="radio" name={field.id} checked={value === opt.label} onChange={() => onChange(opt.label)} />
+              <span className="nf-ml-6">{opt.label || "選択肢"}</span>
+            </label>
+          ))}
+        </div>
+      )}
+
+      {field.type === "select" && (
+        <select value={value ?? ""} onChange={(event) => onChange(event.target.value)} className={s.input.className}>
+          <option value="">-- 未選択 --</option>
+          {(field.options || []).map((opt) => (
+            <option key={opt.id} value={opt.label}>
+              {opt.label || "選択肢"}
+            </option>
+          ))}
+        </select>
+      )}
+
+      {field.type === "checkboxes" && (
+        <div>
+          {(field.options || []).map((opt) => {
+            const arr = Array.isArray(value) ? value : [];
+            const checked = arr.includes(opt.label);
+            return (
+              <div key={opt.id} className="nf-mb-4">
+                <label>
+                  <input
+                    type="checkbox"
+                    checked={checked}
+                    onChange={(event) => {
+                      const next = new Set(arr);
+                      event.target.checked ? next.add(opt.label) : next.delete(opt.label);
+                      onChange(Array.from(next));
+                    }}
+                  />
+                  <span className="nf-ml-6">{opt.label || "選択肢"}</span>
+                </label>
+                {checked && renderChildrenForOption && (
+                  <div className={s.child.className}>{renderChildrenForOption(opt.label)}</div>
+                )}
+              </div>
+            );
+          })}
+        </div>
+      )}
+
+      {renderChildrenAll && field.type !== "checkboxes" && <div className={s.child.className}>{renderChildrenAll()}</div>}
+    </div>
+  );
+};
+
+const RendererRecursive = ({ fields, responses, onChange, depth = 0, readOnly = false }) => {
+  const renderChildrenAll = (field, fid) => () => {
+    if (!field?.childrenByValue) return null;
+    if (["radio", "select"].includes(field.type)) {
+      const selected = (responses || {})[fid];
+      if (!selected) return null;
+      return (
+        <RendererRecursive
+          fields={field.childrenByValue[selected] || []}
+          responses={responses}
+          onChange={onChange}
+          depth={depth + 1}
+          readOnly={readOnly}
+        />
+      );
+    }
+    if (field.type === "checkboxes") {
+      const arr = Array.isArray((responses || {})[fid]) ? (responses || {})[fid] : [];
+      return arr.map((label) => (
+        <RendererRecursive
+          key={`child_${fid}_${label}`}
+          fields={field.childrenByValue[label] || []}
+          responses={responses}
+          onChange={onChange}
+          depth={depth + 1}
+          readOnly={readOnly}
+        />
+      ));
+    }
+    return null;
+  };
+
+  const renderChildrenForOption = (field, fid, optionLabel) => {
+    if (!field?.childrenByValue) return null;
+    return (
+      <RendererRecursive
+        fields={field.childrenByValue[optionLabel] || []}
+        responses={responses}
+        onChange={onChange}
+        depth={depth + 1}
+      />
+    );
+  };
+
+  return (
+    <div>
+      {(fields || []).map((field, index) => {
+        const fid = field?.id || `tmp_${depth}_${index}_${field?.label || ""}`;
+        const value = (responses || {})[fid] ?? (responses || {})[field?.id];
+        const cardAttrs = s.card(depth, false);
+        return (
+          <div key={`node_${fid}`} className={cardAttrs.className} data-depth={cardAttrs["data-depth"]}>
+            <FieldRenderer
+              field={{ ...field, id: fid }}
+              value={value}
+              onChange={(nextValue) => onChange((prev) => ({ ...(prev || {}), [fid]: nextValue }))}
+              renderChildrenAll={renderChildrenAll(field, fid)}
+              renderChildrenForOption={(label) => renderChildrenForOption(field, fid, label)}
+              readOnly={readOnly}
+            />
+          </div>
+        );
+      })}
+    </div>
+  );
+};
+
+const PreviewPage = React.forwardRef(function PreviewPage(
+  {
+    schema,
+    responses,
+    setResponses,
+    settings = {},
+    showOutputJson = true,
+    onSave,
+    saveButtonLabel = "回答保存",
+    showSaveButton = true,
+    readOnly = false,
+  },
+  ref,
 ) {
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const initialRecordId = settings.recordId;
+  const { showAlert } = useAlert();
+const initialRecordId = settings.recordId;
   const recordIdRef = useRef(initialRecordId || generateRecordId());
   const currentUserName = typeof settings.userName === "string" ? settings.userName : "";
   const defaultNowMap = useMemo(
     () => collectDefaultNowResponses(schema, new Date(), { userName: currentUserName }),
     [schema, currentUserName],
   );
-
-  useEffect(() => {
-    if (initialRecordId && recordIdRef.current !== initialRecordId) {
-      recordIdRef.current = initialRecordId;
-    }
-  }, [initialRecordId]);
-
+
+  useEffect(() => {
+    if (initialRecordId && recordIdRef.current !== initialRecordId) {
+      recordIdRef.current = initialRecordId;
+    }
+  }, [initialRecordId]);
+
   useEffect(() => {
     // 既往データ編集時は日付・時間・入力ユーザー名の自動初期値設定をスキップ
     if (settings.recordId) return;
-
-    if (!defaultNowMap || Object.keys(defaultNowMap).length === 0) return;
-    setResponses((prev) => {
-      const current = prev || {};
-      let changed = false;
-      const next = { ...current };
-      Object.keys(defaultNowMap).forEach((key) => {
-        const currentValue = next[key];
-        if (currentValue === undefined || currentValue === null || currentValue === "") {
-          next[key] = defaultNowMap[key];
-          changed = true;
-        }
-      });
-      return changed ? next : current;
-    });
+
+    if (!defaultNowMap || Object.keys(defaultNowMap).length === 0) return;
+    setResponses((prev) => {
+      const current = prev || {};
+      let changed = false;
+      const next = { ...current };
+      Object.keys(defaultNowMap).forEach((key) => {
+        const currentValue = next[key];
+        if (currentValue === undefined || currentValue === null || currentValue === "") {
+          next[key] = defaultNowMap[key];
+          changed = true;
+        }
+      });
+      return changed ? next : current;
+    });
   }, [defaultNowMap, setResponses, settings.recordId]);
-
-  const sortedData = useMemo(() => {
-    const raw = collectResponses(schema, responses);
-    return sortResponses(raw, schema, responses);
-  }, [schema, responses]);
-  const output = sortedData.map;
-  const sortedKeys = sortedData.keys;
-  const formTitle = settings.formTitle || "受付フォーム";
-
-  const [isSaving, setIsSaving] = useState(false);
-
-  const handleSaveToSheet = async (options = {}) => {
-    let alertShown = false;
-    setIsSaving(true);
-    try {
+
+  const sortedData = useMemo(() => {
+    const raw = collectResponses(schema, responses);
+    return sortResponses(raw, schema, responses);
+  }, [schema, responses]);
+  const output = sortedData.map;
+  const sortedKeys = sortedData.keys;
+  const formTitle = settings.formTitle || "受付フォーム";
+
+  const [isSaving, setIsSaving] = useState(false);
+
+  const handleSaveToSheet = async (options = {}) => {
+    let alertShown = false;
+    setIsSaving(true);
+    try {
       if (readOnly) {
         throw new Error("read_only_mode");
       }
@@ -368,112 +367,111 @@ const PreviewPage = React.forwardRef(function PreviewPage(
         alertShown = true;
         throw new Error("validation_failed");
       }
-
-      let spreadsheetId = null;
-      if (!onSave) {
-        const scriptRunAvailable = hasScriptRun();
-        spreadsheetId = normalizeSpreadsheetId(settings.spreadsheetId || "");
-        if (!spreadsheetId) {
-          showAlert("Spreadsheet ID / URL が未入力です");
-          alertShown = true;
-          throw new Error("missing_spreadsheet_id");
-        }
-        if (!scriptRunAvailable) {
-          showAlert("この機能はGoogle Apps Script環境でのみ利用可能です");
-          alertShown = true;
-          throw new Error("missing_script_run");
-        }
-      }
-
-      const payload = {
-        version: 1,
-        formTitle,
-        schemaHash: computeSchemaHash(schema),
-        id: recordIdRef.current,
-        responses: output,
-        order: sortedKeys,
-      };
-
-      if (onSave) {
-        const result = await onSave({
-          payload,
-          sortedKeys,
-          recordId: recordIdRef.current,
-          responses,
-          options,
-        });
-        return result ?? payload;
-      }
-      const res = await submitResponses({
-        spreadsheetId,
-        sheetName: settings.sheetName || "Data",
-        payload,
-      });
-      const msg = res?.spreadsheetUrl
-        ? `送信しました（${res.sheetName} に追記 / 行: ${res.rowNumber}）`
-        : "送信しました";
-      showAlert(msg);
-      return res;
-    } catch (error) {
-      console.error("[PreviewPage] Error in handleSaveToSheet:", error);
-      const suppressAlert = alertShown
-        || error?.message === "validation_failed"
-        || error?.message === "missing_spreadsheet_id"
-        || error?.message === "missing_script_run"
-        || error?.message === "read_only_mode";
-      if (!options?.silent && !suppressAlert) {
-        showAlert(`送信に失敗しました: ${error?.message || error}`);
-      }
-      throw error;
-    } finally {
-      setIsSaving(false);
-    }
-  };
-
-  useImperativeHandle(
-    ref,
-    () => ({
-      submit: handleSaveToSheet,
-      getRecordId: () => recordIdRef.current,
-      getOutput: () => ({ map: output, keys: sortedKeys }),
-    }),
-    [handleSaveToSheet, output, sortedKeys],
-  );
-
-  return (
-    <div className="nf-card" data-depth="0">
-      <h2 className="preview-title">{formTitle}</h2>
-      {settings.showRecordNo !== false && (
-        <div className="nf-mb-12">
-          <label className="preview-label">No.</label>
-          <input type="text" value={settings.recordNo || ""} readOnly className="nf-input nf-input--readonly" />
-        </div>
-      )}
-      <div className="nf-mb-12">
-        <label className="preview-label">回答ID</label>
-        <input type="text" value={recordIdRef.current} readOnly className="nf-input nf-input--readonly" />
-      </div>
-      <RendererRecursive fields={schema} responses={responses} onChange={setResponses} readOnly={readOnly} />
-      {showOutputJson && (
-        <div className="nf-mt-12">
-          <label className="preview-label">回答JSON</label>
-          <textarea
-            readOnly
-            value={JSON.stringify(output, null, 2)}
-            className={`${s.input.className} preview-json`}
-          />
-        </div>
-      )}
-      {showSaveButton && !readOnly && (
-        <div className="nf-row nf-gap-8 nf-mt-12 nf-justify-end">
-          <button type="button" className={s.btn.className} onClick={handleSaveToSheet} disabled={isSaving}>
-            {isSaving ? "保存中..." : saveButtonLabel}
-          </button>
-        </div>
-      )}
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </div>
-  );
-});
-
-export default PreviewPage;
+
+      let spreadsheetId = null;
+      if (!onSave) {
+        const scriptRunAvailable = hasScriptRun();
+        spreadsheetId = normalizeSpreadsheetId(settings.spreadsheetId || "");
+        if (!spreadsheetId) {
+          showAlert("Spreadsheet ID / URL が未入力です");
+          alertShown = true;
+          throw new Error("missing_spreadsheet_id");
+        }
+        if (!scriptRunAvailable) {
+          showAlert("この機能はGoogle Apps Script環境でのみ利用可能です");
+          alertShown = true;
+          throw new Error("missing_script_run");
+        }
+      }
+
+      const payload = {
+        version: 1,
+        formTitle,
+        schemaHash: computeSchemaHash(schema),
+        id: recordIdRef.current,
+        responses: output,
+        order: sortedKeys,
+      };
+
+      if (onSave) {
+        const result = await onSave({
+          payload,
+          sortedKeys,
+          recordId: recordIdRef.current,
+          responses,
+          options,
+        });
+        return result ?? payload;
+      }
+      const res = await submitResponses({
+        spreadsheetId,
+        sheetName: settings.sheetName || "Data",
+        payload,
+      });
+      const msg = res?.spreadsheetUrl
+        ? `送信しました（${res.sheetName} に追記 / 行: ${res.rowNumber}）`
+        : "送信しました";
+      showAlert(msg);
+      return res;
+    } catch (error) {
+      console.error("[PreviewPage] Error in handleSaveToSheet:", error);
+      const suppressAlert = alertShown
+        || error?.message === "validation_failed"
+        || error?.message === "missing_spreadsheet_id"
+        || error?.message === "missing_script_run"
+        || error?.message === "read_only_mode";
+      if (!options?.silent && !suppressAlert) {
+        showAlert(`送信に失敗しました: ${error?.message || error}`);
+      }
+      throw error;
+    } finally {
+      setIsSaving(false);
+    }
+  };
+
+  useImperativeHandle(
+    ref,
+    () => ({
+      submit: handleSaveToSheet,
+      getRecordId: () => recordIdRef.current,
+      getOutput: () => ({ map: output, keys: sortedKeys }),
+    }),
+    [handleSaveToSheet, output, sortedKeys],
+  );
+
+  return (
+    <div className="nf-card" data-depth="0">
+      <h2 className="preview-title">{formTitle}</h2>
+      {settings.showRecordNo !== false && (
+        <div className="nf-mb-12">
+          <label className="preview-label">No.</label>
+          <input type="text" value={settings.recordNo || ""} readOnly className="nf-input nf-input--readonly" />
+        </div>
+      )}
+      <div className="nf-mb-12">
+        <label className="preview-label">回答ID</label>
+        <input type="text" value={recordIdRef.current} readOnly className="nf-input nf-input--readonly" />
+      </div>
+      <RendererRecursive fields={schema} responses={responses} onChange={setResponses} readOnly={readOnly} />
+      {showOutputJson && (
+        <div className="nf-mt-12">
+          <label className="preview-label">回答JSON</label>
+          <textarea
+            readOnly
+            value={JSON.stringify(output, null, 2)}
+            className={`${s.input.className} preview-json`}
+          />
+        </div>
+      )}
+      {showSaveButton && !readOnly && (
+        <div className="nf-row nf-gap-8 nf-mt-12 nf-justify-end">
+          <button type="button" className={s.btn.className} onClick={handleSaveToSheet} disabled={isSaving}>
+            {isSaving ? "保存中..." : saveButtonLabel}
+          </button>
+        </div>
+      )}
+</div>
+  );
+});
+
+export default PreviewPage;
diff --git a/builder/src/pages/AdminDashboardPage.jsx b/builder/src/pages/AdminDashboardPage.jsx
index b984b48..bed745c 100644
--- a/builder/src/pages/AdminDashboardPage.jsx
+++ b/builder/src/pages/AdminDashboardPage.jsx
@@ -1,10 +1,9 @@
-import React, { useCallback, useEffect, useMemo, useState } from "react";
-import { useNavigate } from "react-router-dom";
-import JSZip from "jszip";
-import { saveAs } from "file-saver";
+import React, { useCallback, useEffect, useMemo, useState } from "react";
+import { useNavigate } from "react-router-dom";
+import JSZip from "jszip";
+import { saveAs } from "file-saver";
 import AppLayout from "../app/components/AppLayout.jsx";
 import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
 import { useAppData } from "../app/state/AppDataProvider.jsx";
 import { dataStore } from "../app/state/dataStore.js";
 import { useAlert } from "../app/hooks/useAlert.js";
@@ -12,7 +11,7 @@ import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
 import { useBuilderSettings } from "../features/settings/settingsStore.js";
 import { importFormsFromDrive, hasScriptRun } from "../services/gasClient.js";
 import { formatUnixMsDateTime, toUnixMs } from "../utils/dateTime.js";
-
+
 const formatDisplayFieldsSummary = (form) => {
   if (!form) return "";
   const settings = Array.isArray(form.displayFieldSettings) && form.displayFieldSettings.length
@@ -20,37 +19,37 @@ const formatDisplayFieldsSummary = (form) => {
     : (Array.isArray(form.importantFields) ? form.importantFields.map((path) => ({ path })) : []);
   if (!settings.length) return "";
   return settings
-    .filter((item) => item?.path)
-    .map((item) => item.path)
-    .join(", ");
-};
-
-const formatDate = (value) => {
-  const ms = Number.isFinite(value) ? value : toUnixMs(value);
-  if (!Number.isFinite(ms)) return "---";
-  return formatUnixMsDateTime(ms);
-};
-
-const buildImportDetail = (skipped = 0, parseFailed = 0, { useRegisteredLabel = false } = {}) => {
-  const parts = [];
-  if (skipped > 0) {
-    const label = useRegisteredLabel ? "登録済みスキップ" : "スキップ";
-    parts.push(`${label} ${skipped} 件`);
-  }
-  if (parseFailed > 0) parts.push(`読込失敗 ${parseFailed} 件`);
-  return parts.length > 0 ? `（${parts.join("、")}）` : "";
-};
-
+    .filter((item) => item?.path)
+    .map((item) => item.path)
+    .join(", ");
+};
+
+const formatDate = (value) => {
+  const ms = Number.isFinite(value) ? value : toUnixMs(value);
+  if (!Number.isFinite(ms)) return "---";
+  return formatUnixMsDateTime(ms);
+};
+
+const buildImportDetail = (skipped = 0, parseFailed = 0, { useRegisteredLabel = false } = {}) => {
+  const parts = [];
+  if (skipped > 0) {
+    const label = useRegisteredLabel ? "登録済みスキップ" : "スキップ";
+    parts.push(`${label} ${skipped} 件`);
+  }
+  if (parseFailed > 0) parts.push(`読込失敗 ${parseFailed} 件`);
+  return parts.length > 0 ? `（${parts.join("、")}）` : "";
+};
+
 export default function AdminDashboardPage() {
   const { forms, loadFailures, loadingForms, archiveForm, unarchiveForm, archiveForms, unarchiveForms, deleteForms, refreshForms, exportForms, registerImportedForm } = useAppData();
   const { settings } = useBuilderSettings();
   const navigate = useNavigate();
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const [selected, setSelected] = useState(() => new Set());
-  const [confirmArchive, setConfirmArchive] = useState({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false });
-  const [confirmDelete, setConfirmDelete] = useState({ open: false, formId: null, targetIds: [], multiple: false });
-  const [importDialogOpen, setImportDialogOpen] = useState(false);
-  const [importUrl, setImportUrl] = useState("");
+  const { showAlert } = useAlert();
+const [selected, setSelected] = useState(() => new Set());
+  const [confirmArchive, setConfirmArchive] = useState({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false });
+  const [confirmDelete, setConfirmDelete] = useState({ open: false, formId: null, targetIds: [], multiple: false });
+  const [importDialogOpen, setImportDialogOpen] = useState(false);
+  const [importUrl, setImportUrl] = useState("");
   const [importing, setImporting] = useState(false);
   const [copiedId, setCopiedId] = useState(null);
 
@@ -58,153 +57,153 @@ export default function AdminDashboardPage() {
     const globalTheme = settings?.theme || DEFAULT_THEME;
     void applyThemeWithFallback(globalTheme, { persist: false });
   }, [settings?.theme]);
-
-  const sortedForms = useMemo(() => {
-    const list = forms.slice();
-    list.sort(
-      (a, b) => (Number.isFinite(b.modifiedAtUnixMs) ? b.modifiedAtUnixMs : toUnixMs(b.modifiedAt)) -
-        (Number.isFinite(a.modifiedAtUnixMs) ? a.modifiedAtUnixMs : toUnixMs(a.modifiedAt))
-    );
-    return list;
-  }, [forms]);
-
-  const loadFailureRows = useMemo(() => {
-    const rows = (loadFailures || []).map((item) => ({
-      id: item.id,
-      archived: true,
-      settings: {},
-      description: "",
-      modifiedAt: item.lastTriedAt,
-      loadError: item,
-    }));
-    rows.sort(
-      (a, b) => (Number.isFinite(b.modifiedAtUnixMs) ? b.modifiedAtUnixMs : toUnixMs(b.modifiedAt || 0)) -
-        (Number.isFinite(a.modifiedAtUnixMs) ? a.modifiedAtUnixMs : toUnixMs(a.modifiedAt || 0))
-    );
-    return rows;
-  }, [loadFailures]);
-
-  const adminForms = useMemo(() => [...sortedForms, ...loadFailureRows], [sortedForms, loadFailureRows]);
-
-  const toggleSelect = (formId) => {
-    setSelected((prev) => {
-      const next = new Set(prev);
-      if (next.has(formId)) next.delete(formId);
-      else next.add(formId);
-      return next;
-    });
-  };
-
-  const selectAll = (checked) => {
-    if (checked) setSelected(new Set(adminForms.map((form) => form.id)));
-    else setSelected(new Set());
-  };
-
-  const clearSelectionByIds = useCallback((ids = []) => {
-    if (!Array.isArray(ids) || ids.length === 0) return;
-    setSelected((prev) => {
-      const next = new Set(prev);
-      ids.forEach((id) => next.delete(id));
-      return next;
-    });
-  }, []);
-
-  const handleArchiveSelected = () => {
-    const selectedForms = sortedForms.filter((form) => selected.has(form.id));
-    if (!selectedForms.length) {
-      showAlert("アーカイブ可能なフォームを選択してください。（読み込みエラーの項目は削除のみ可能です）");
-      return;
-    }
-
-    const allArchived = selectedForms.every((form) => form.archived);
-    const hasPublished = selectedForms.some((form) => !form.archived);
-
-    const targetIds = selectedForms.map((form) => form.id);
-    const firstId = targetIds[0];
-    setConfirmArchive({
-      open: true,
-      formId: firstId,
-      targetIds,
-      multiple: targetIds.length > 1,
-      allArchived,
-      hasPublished,
-    });
-  };
-
-  const handleDeleteSelected = () => {
-    if (!selected.size) {
-      showAlert("削除するフォームを選択してください。");
-      return;
-    }
-    const targetIds = Array.from(selected);
-    const firstId = targetIds[0];
-    setConfirmDelete({ open: true, formId: firstId, multiple: targetIds.length > 1, targetIds });
-  };
-
-  const handleExport = async () => {
-    if (!selected.size) {
-      showAlert("スキーマをエクスポートするフォームを選択してください。");
-      return;
-    }
-    const targets = await exportForms(Array.from(selected));
-    if (!targets.length) {
-      showAlert("エクスポート可能なデータがありません");
-      return;
-    }
-
-    if (targets.length === 1) {
-      // 1個の場合は.jsonファイルとして保存
-      const form = targets[0];
-      const filename = `${form.settings?.formTitle || form.id}.json`;
-      const { id, ...formWithoutId } = form;
-      const blob = new Blob([JSON.stringify(formWithoutId, null, 2)], { type: "application/json" });
-      saveAs(blob, filename);
-    } else {
-      // 複数の場合はZIPファイルとして保存
-      const zip = new JSZip();
-      targets.forEach((form) => {
-        const filename = `${form.settings?.formTitle || form.id}.json`;
-        const { id, ...formWithoutId } = form;
-        zip.file(filename, JSON.stringify(formWithoutId, null, 2));
-      });
-      const blob = await zip.generateAsync({ type: "blob" });
-      saveAs(blob, `forms_${new Date().toISOString().replace(/[:.-]/g, "")}.zip`);
-    }
-  };
-
-  const handleImport = () => {
-    if (importing) return;
-    if (!hasScriptRun()) {
-      showAlert("インポート機能はGoogle Apps Script環境でのみ利用可能です");
-      return;
-    }
-    setImportUrl("");
-    setImportDialogOpen(true);
-  };
-  const sanitizeImportedForm = (raw) => {
-    if (!raw || typeof raw !== "object") return null;
-    const schema = Array.isArray(raw.schema) ? raw.schema : [];
-    const settings = raw && typeof raw.settings === "object" && !Array.isArray(raw.settings) ? raw.settings : {};
-
-    // 旧形式のnameフィールドがある場合、settings.formTitleに移行
-    if (!settings.formTitle && typeof raw.name === "string") {
-      settings.formTitle = raw.name;
-    }
-
-    return {
-      id: raw.id, // IDを保持（重要）
-      description: typeof raw.description === "string" ? raw.description : "",
-      schema,
-      settings,
-      archived: !!raw.archived,
-      schemaVersion: Number.isFinite(raw.schemaVersion) ? raw.schemaVersion : 1,
-      createdAt: raw.createdAt, // 作成日時を保持
-      modifiedAt: raw.modifiedAt, // 更新日時を保持
-      createdAtUnixMs: Number.isFinite(raw.createdAtUnixMs) ? raw.createdAtUnixMs : toUnixMs(raw.createdAt),
-      modifiedAtUnixMs: Number.isFinite(raw.modifiedAtUnixMs) ? raw.modifiedAtUnixMs : toUnixMs(raw.modifiedAt),
-    };
-  };
-
+
+  const sortedForms = useMemo(() => {
+    const list = forms.slice();
+    list.sort(
+      (a, b) => (Number.isFinite(b.modifiedAtUnixMs) ? b.modifiedAtUnixMs : toUnixMs(b.modifiedAt)) -
+        (Number.isFinite(a.modifiedAtUnixMs) ? a.modifiedAtUnixMs : toUnixMs(a.modifiedAt))
+    );
+    return list;
+  }, [forms]);
+
+  const loadFailureRows = useMemo(() => {
+    const rows = (loadFailures || []).map((item) => ({
+      id: item.id,
+      archived: true,
+      settings: {},
+      description: "",
+      modifiedAt: item.lastTriedAt,
+      loadError: item,
+    }));
+    rows.sort(
+      (a, b) => (Number.isFinite(b.modifiedAtUnixMs) ? b.modifiedAtUnixMs : toUnixMs(b.modifiedAt || 0)) -
+        (Number.isFinite(a.modifiedAtUnixMs) ? a.modifiedAtUnixMs : toUnixMs(a.modifiedAt || 0))
+    );
+    return rows;
+  }, [loadFailures]);
+
+  const adminForms = useMemo(() => [...sortedForms, ...loadFailureRows], [sortedForms, loadFailureRows]);
+
+  const toggleSelect = (formId) => {
+    setSelected((prev) => {
+      const next = new Set(prev);
+      if (next.has(formId)) next.delete(formId);
+      else next.add(formId);
+      return next;
+    });
+  };
+
+  const selectAll = (checked) => {
+    if (checked) setSelected(new Set(adminForms.map((form) => form.id)));
+    else setSelected(new Set());
+  };
+
+  const clearSelectionByIds = useCallback((ids = []) => {
+    if (!Array.isArray(ids) || ids.length === 0) return;
+    setSelected((prev) => {
+      const next = new Set(prev);
+      ids.forEach((id) => next.delete(id));
+      return next;
+    });
+  }, []);
+
+  const handleArchiveSelected = () => {
+    const selectedForms = sortedForms.filter((form) => selected.has(form.id));
+    if (!selectedForms.length) {
+      showAlert("アーカイブ可能なフォームを選択してください。（読み込みエラーの項目は削除のみ可能です）");
+      return;
+    }
+
+    const allArchived = selectedForms.every((form) => form.archived);
+    const hasPublished = selectedForms.some((form) => !form.archived);
+
+    const targetIds = selectedForms.map((form) => form.id);
+    const firstId = targetIds[0];
+    setConfirmArchive({
+      open: true,
+      formId: firstId,
+      targetIds,
+      multiple: targetIds.length > 1,
+      allArchived,
+      hasPublished,
+    });
+  };
+
+  const handleDeleteSelected = () => {
+    if (!selected.size) {
+      showAlert("削除するフォームを選択してください。");
+      return;
+    }
+    const targetIds = Array.from(selected);
+    const firstId = targetIds[0];
+    setConfirmDelete({ open: true, formId: firstId, multiple: targetIds.length > 1, targetIds });
+  };
+
+  const handleExport = async () => {
+    if (!selected.size) {
+      showAlert("スキーマをエクスポートするフォームを選択してください。");
+      return;
+    }
+    const targets = await exportForms(Array.from(selected));
+    if (!targets.length) {
+      showAlert("エクスポート可能なデータがありません");
+      return;
+    }
+
+    if (targets.length === 1) {
+      // 1個の場合は.jsonファイルとして保存
+      const form = targets[0];
+      const filename = `${form.settings?.formTitle || form.id}.json`;
+      const { id, ...formWithoutId } = form;
+      const blob = new Blob([JSON.stringify(formWithoutId, null, 2)], { type: "application/json" });
+      saveAs(blob, filename);
+    } else {
+      // 複数の場合はZIPファイルとして保存
+      const zip = new JSZip();
+      targets.forEach((form) => {
+        const filename = `${form.settings?.formTitle || form.id}.json`;
+        const { id, ...formWithoutId } = form;
+        zip.file(filename, JSON.stringify(formWithoutId, null, 2));
+      });
+      const blob = await zip.generateAsync({ type: "blob" });
+      saveAs(blob, `forms_${new Date().toISOString().replace(/[:.-]/g, "")}.zip`);
+    }
+  };
+
+  const handleImport = () => {
+    if (importing) return;
+    if (!hasScriptRun()) {
+      showAlert("インポート機能はGoogle Apps Script環境でのみ利用可能です");
+      return;
+    }
+    setImportUrl("");
+    setImportDialogOpen(true);
+  };
+  const sanitizeImportedForm = (raw) => {
+    if (!raw || typeof raw !== "object") return null;
+    const schema = Array.isArray(raw.schema) ? raw.schema : [];
+    const settings = raw && typeof raw.settings === "object" && !Array.isArray(raw.settings) ? raw.settings : {};
+
+    // 旧形式のnameフィールドがある場合、settings.formTitleに移行
+    if (!settings.formTitle && typeof raw.name === "string") {
+      settings.formTitle = raw.name;
+    }
+
+    return {
+      id: raw.id, // IDを保持（重要）
+      description: typeof raw.description === "string" ? raw.description : "",
+      schema,
+      settings,
+      archived: !!raw.archived,
+      schemaVersion: Number.isFinite(raw.schemaVersion) ? raw.schemaVersion : 1,
+      createdAt: raw.createdAt, // 作成日時を保持
+      modifiedAt: raw.modifiedAt, // 更新日時を保持
+      createdAtUnixMs: Number.isFinite(raw.createdAtUnixMs) ? raw.createdAtUnixMs : toUnixMs(raw.createdAt),
+      modifiedAtUnixMs: Number.isFinite(raw.modifiedAtUnixMs) ? raw.modifiedAtUnixMs : toUnixMs(raw.modifiedAt),
+    };
+  };
+
   const flattenImportedContents = (contents) => {
     const list = [];
     let invalidPayloadCount = 0;
@@ -249,420 +248,419 @@ export default function AdminDashboardPage() {
             imported += 1;
           } catch (error) {
             saveFailed += 1;
-            console.warn("[DriveImport] failed to import one form", {
-              formId: item?.form?.id,
-              title: item?.form?.settings?.formTitle,
-              error: error?.message || error,
-            });
-          }
-        }
-
-        setSelected(new Set());
-        const saveFailedDetail = saveFailed > 0 ? `（保存失敗 ${saveFailed} 件）` : "";
-
-        // 結果メッセージ
-        if (imported > 0) {
-          showAlert(`${imported} 件のフォームを取り込みました${detail}${saveFailedDetail}。`);
-        } else {
-          showAlert(`取り込めるフォームはありませんでした${detail}${saveFailedDetail}。`);
-        }
+            console.warn("[DriveImport] failed to import one form", {
+              formId: item?.form?.id,
+              title: item?.form?.settings?.formTitle,
+              error: error?.message || error,
+            });
+          }
+        }
+
+        setSelected(new Set());
+        const saveFailedDetail = saveFailed > 0 ? `（保存失敗 ${saveFailed} 件）` : "";
+
+        // 結果メッセージ
+        if (imported > 0) {
+          showAlert(`${imported} 件のフォームを取り込みました${detail}${saveFailedDetail}。`);
+        } else {
+          showAlert(`取り込めるフォームはありませんでした${detail}${saveFailedDetail}。`);
+        }
         console.log(
           `[DriveImport] success=${imported}, alreadyRegistered=${skipped}, parseFailed=${parseFailed}, saveFailed=${saveFailed}`,
         );
       } catch (error) {
-        console.error("[DriveImport] import workflow failed", error);
-        showAlert(error?.message || "スキーマの取り込み中にエラーが発生しました");
-      } finally {
-        setImporting(false);
-      }
+        console.error("[DriveImport] import workflow failed", error);
+        showAlert(error?.message || "スキーマの取り込み中にエラーが発生しました");
+      } finally {
+        setImporting(false);
+      }
     },
     [registerImportedForm, showAlert],
   );
-
-  const handleImportFromDrive = async () => {
-    const url = importUrl?.trim();
-    if (!url) {
-      showAlert("Google Drive URLを入力してください");
-      return;
-    }
-
-    setImportDialogOpen(false);
-    setImporting(true);
-
-    try {
-      // Google DriveからフォームデータをAPI経由で取得
-      const result = await importFormsFromDrive(url);
-      const { forms: importedForms, skipped = 0, parseFailed = 0 } = result;
-      const detail = buildImportDetail(skipped, parseFailed);
-
-      if (!importedForms || importedForms.length === 0) {
-        showAlert(`有効なフォームがありませんでした${detail}。`);
-        setImporting(false);
-        return;
-      }
-
-      // インポートワークフローを実行
-      await startImportWorkflow(importedForms, { skipped, parseFailed });
-    } catch (error) {
-      console.error("[DriveImport] import from Drive failed", error);
-      showAlert(error?.message || "Google Driveからのインポートに失敗しました");
-      setImporting(false);
-    }
-  };
-
-  const confirmArchiveAction = () => {
-    const targetIds = (confirmArchive.targetIds && confirmArchive.targetIds.length
-      ? confirmArchive.targetIds
-      : confirmArchive.formId
-        ? [confirmArchive.formId]
-        : []);
-    if (!targetIds.length) return;
-
-    // アーカイブ状態を保持
-    const shouldUnarchive = confirmArchive.allArchived;
-
-    // ダイアログを即座に閉じて選択をクリア
-    clearSelectionByIds(targetIds);
-    setConfirmArchive({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false });
-
-    // バックグラウンドで一括処理を実行
-    (async () => {
-      try {
-        if (shouldUnarchive) {
-          await unarchiveForms(targetIds);
-        } else {
-          await archiveForms(targetIds);
-        }
-      } catch (error) {
-        console.error("[AdminDashboard] Archive action failed:", error);
-        showAlert(`アーカイブ処理中にエラーが発生しました: ${error.message}`);
-      }
-    })();
-  };
-
-  const confirmDeleteAction = async () => {
-    const targetIds = (confirmDelete.targetIds && confirmDelete.targetIds.length
-      ? confirmDelete.targetIds
-      : confirmDelete.formId
-        ? [confirmDelete.formId]
-        : []);
-    if (!targetIds.length) return;
-
-    try {
-      await deleteForms(targetIds);
-      clearSelectionByIds(targetIds);
-      setConfirmDelete({ open: false, formId: null, targetIds: [], multiple: false });
-    } catch (error) {
-      console.error("[AdminDashboard] Delete action failed:", error);
-      showAlert(error?.message || "フォームの削除中にエラーが発生しました");
-    }
-  };
-
-  const goToEditor = (formId) => {
-    navigate(`/forms/${formId}/edit`);
-  };
-
-  const handleCopyId = useCallback((formId, event) => {
-    event.stopPropagation();
-    const baseUrl = window.__GAS_WEBAPP_URL__ || window.location.origin;
-    const fullUrl = `${baseUrl}?form=${formId}`;
-    navigator.clipboard.writeText(fullUrl).then(() => {
-      setCopiedId(formId);
-      setTimeout(() => setCopiedId(null), 2000);
-    }).catch((error) => {
-      console.error("Failed to copy:", error);
-      showAlert("URLのコピーに失敗しました");
-    });
-  }, [showAlert]);
-
-  const handleCreateNew = () => {
-    navigate("/forms/new");
-  };
-
-  return (
-    <AppLayout
-      title="フォーム管理"
-      badge="フォーム一覧"
-      fallbackPath="/"
-      actions={null}
-      sidebarActions={
-        <>
-          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleCreateNew}>
-            新規作成
-          </button>
-          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleImport}>
-            {importing ? "インポート中..." : "インポート"}
-          </button>
-          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleExport} disabled={selected.size === 0}>
-            エクスポート
-          </button>
-          <button
-            type="button"
-            className="nf-btn-outline nf-btn-sidebar nf-text-13"
-            onClick={handleArchiveSelected}
-            disabled={selected.size === 0}
-          >
-            アーカイブ
-          </button>
-          <button
-            type="button"
-            className="nf-btn-outline nf-btn-sidebar nf-text-13 admin-danger-btn"
-            onClick={handleDeleteSelected}
-            disabled={selected.size === 0}
-          >
-            削除
-          </button>
-          <button
-            type="button"
-            className={`nf-btn-outline nf-btn-sidebar nf-text-13${!loadingForms ? " admin-refresh-btn" : ""}`}
-            onClick={() => refreshForms("manual:admin-dashboard")}
-            disabled={loadingForms}
-          >
-            {loadingForms ? "🔄 更新中..." : "🔄 更新"}
-          </button>
-        </>
-      }
-    >
-      {loadingForms ? (
-        <p className="nf-text-subtle">読み込み中...</p>
-      ) : (
-        <div className="search-table-wrap">
-          <table className="search-table">
-            <thead>
-              <tr>
-                <th className="search-th">
-                  <input type="checkbox" checked={adminForms.length > 0 && selected.size === adminForms.length} onChange={(event) => selectAll(event.target.checked)} />
-                </th>
-                <th className="search-th">名称</th>
-                <th className="search-th">フォームID</th>
-                <th className="search-th">更新日時</th>
-                <th className="search-th">表示項目</th>
-                <th className="search-th">状態</th>
-              </tr>
-            </thead>
-            <tbody>
-              {adminForms.map((form) => {
-                const isLoadError = !!form.loadError;
-                const summary = isLoadError ? "" : formatDisplayFieldsSummary(form);
-                const loadError = form.loadError || null;
-                const lastUpdated = isLoadError ? formatDate(loadError?.lastTriedAt) : formatDate(form.modifiedAt);
-                return (
-                  <tr
-                    key={form.id}
-                    className="admin-row"
-                    data-clickable={isLoadError ? "false" : "true"}
-                    data-error={isLoadError ? "true" : "false"}
-                    onClick={() => {
-                      if (!isLoadError) {
-                        goToEditor(form.id);
-                      }
-                    }}
-                  >
-                    <td className="search-td" onClick={(e) => e.stopPropagation()}>
-                      <input type="checkbox" checked={selected.has(form.id)} onChange={() => toggleSelect(form.id)} />
-                      {isLoadError && <div className="nf-text-danger-ink nf-text-11 nf-mt-4">削除のみ可能</div>}
-                    </td>
-                    <td className="search-td">
-                      {isLoadError ? (
-                        <>
-                          <div className="nf-fw-600 nf-text-danger-ink">{loadError?.fileName || "(名称不明)"}</div>
-                          <div className="nf-text-danger-ink-strong nf-text-12">フォームID: {form.id}</div>
-                          {loadError?.fileId && <div className="nf-text-danger-ink-strong nf-text-12">ファイルID: {loadError.fileId}</div>}
-                          {loadError?.driveFileUrl && (
-                            <div className="nf-mt-6">
-                              <a
-                                href={loadError.driveFileUrl}
-                                target="_blank"
-                                rel="noreferrer"
-                                onClick={(event) => event.stopPropagation()}
-                                className="admin-link"
-                              >
-                                Driveで確認
-                              </a>
-                            </div>
-                          )}
-                        </>
-                      ) : (
-                        <>
-                          <div className="nf-fw-600">{form.settings?.formTitle || "(無題)"}</div>
-                          {form.description && <div className="nf-text-muted nf-text-12">{form.description}</div>}
-                        </>
-                      )}
-                    </td>
-                    <td className="search-td" onClick={(e) => e.stopPropagation()}>
-                      <div className="nf-row nf-gap-6">
-                        <span className="admin-form-id">{form.id}</span>
-                        <button
-                          type="button"
-                          className="admin-copy-btn"
-                          onClick={(e) => handleCopyId(form.id, e)}
-                          title="URLをコピー"
-                        >
-                          {copiedId === form.id ? "✓" : "📋"}
-                        </button>
-                      </div>
-                    </td>
-                    <td className="search-td">{lastUpdated}</td>
-                    <td className="search-td">
-                      {isLoadError ? (
-                        <>
-                          <div className="nf-text-danger-ink nf-fw-600">読み込みエラー</div>
-                          <div className="nf-text-danger-ink-strong nf-text-12">{loadError?.errorMessage || "読み込みに失敗しました"}</div>
-                          {loadError?.errorStage && <div className="nf-text-danger-ink-strong nf-text-11 nf-mt-4">ステージ: {loadError.errorStage}</div>}
-                        </>
-                      ) : summary ? (
-                        summary
-                      ) : (
-                        <span className="nf-text-subtle nf-text-12">設定なし</span>
-                      )}
-                    </td>
-                    <td className="search-td">
-                      {isLoadError ? (
-                        <span className="nf-text-danger-strong nf-fw-600">読み込みエラー</span>
-                      ) : form.archived ? (
-                        <span className="nf-text-danger-strong">アーカイブ済み</span>
-                      ) : (
-                        <span className="nf-text-success">公開中</span>
-                      )}
-                    </td>
-                  </tr>
-                );
-              })}
-              {adminForms.length === 0 && (
-                <tr>
-                  <td className="search-td nf-text-center" colSpan={6}>
-                    フォームが登録されていません。
-                  </td>
-                </tr>
-              )}
-            </tbody>
-          </table>
-        </div>
-      )}
-
-      <ConfirmDialog
-        open={confirmArchive.open}
-        title={confirmArchive.allArchived ? "アーカイブを解除" : "フォームをアーカイブ"}
-        message={
-          confirmArchive.allArchived
-            ? "このフォームのアーカイブを解除して公開中に戻します。よろしいですか？"
-            : "このフォームをアーカイブします。検索画面には表示されなくなります。よろしいですか？"
-        }
-        options={[
-          {
-            label: "キャンセル",
-            value: "cancel",
-            onSelect: () => setConfirmArchive({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false }),
-          },
-          {
-            label: confirmArchive.allArchived ? "解除" : "アーカイブ",
-            value: "archive",
-            variant: "primary",
-            onSelect: confirmArchiveAction,
-          },
-        ]}
-      />
-
-      <ConfirmDialog
-        open={confirmDelete.open}
-        title="フォームを削除"
-        message={
-          confirmDelete.multiple
-            ? "選択したフォームをまとめて削除します。元に戻すことはできません。よろしいですか？"
-            : "このフォームを削除します。元に戻すことはできません。よろしいですか？"
-        }
-        options={[
-          {
-            label: "キャンセル",
-            value: "cancel",
-            onSelect: () => setConfirmDelete({ open: false, formId: null, targetIds: [], multiple: false }),
-          },
-          {
-            label: "削除",
-            value: "delete",
-            variant: "danger",
-            onSelect: confirmDeleteAction,
-          },
-        ]}
-      />
-
-      <ImportUrlDialog
-        open={importDialogOpen}
-        url={importUrl}
-        onUrlChange={setImportUrl}
-        onImport={handleImportFromDrive}
-        onCancel={() => setImportDialogOpen(false)}
-      />
-
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
-  );
-}
-
-function ImportUrlDialog({ open, url, onUrlChange, onImport, onCancel }) {
-  const [error, setError] = useState("");
-
-  useEffect(() => {
-    if (!open) {
-      setError("");
-    }
-  }, [open]);
-
-  if (!open) return null;
-
-  const handleImport = () => {
-    const trimmed = (url || "").trim();
-    if (!trimmed) {
-      setError("Google Drive URLを入力してください");
-      return;
-    }
-    setError("");
-    onImport();
-  };
-
-  return (
-    <div className="admin-import-overlay">
-      <div className="admin-import-panel">
-        <h3 className="nf-text-18 nf-fw-700 nf-mb-8">Google Driveからインポート</h3>
-        <p className="nf-mb-16 nf-text-muted nf-text-14">
-          ファイルURLまたはフォルダURLを入力してください。
-        </p>
-
-        <div className="nf-mb-16">
-          <label className="nf-block nf-mb-6 nf-text-13 nf-fw-600">
-            Google Drive URL
-          </label>
-          <input
-            type="text"
-            value={url}
-            onChange={(event) => {
-              onUrlChange(event.target.value);
-              if (error) setError("");
-            }}
-            className="nf-input admin-import-input"
-            placeholder="https://drive.google.com/file/d/... または https://drive.google.com/drive/folders/..."
-          />
-          {error && <p className="nf-mt-6 nf-text-danger-strong nf-text-12">{error}</p>}
-          <p className="nf-mt-6 nf-text-muted nf-text-11">
-            ・ファイルURL: そのフォームのみをインポート<br />
-            ・フォルダURL: フォルダ内の全ての.jsonファイルをインポート<br />
-            ・既にプロパティサービスに存在するフォームIDは自動的にスキップされます
-          </p>
-        </div>
-
-        <div className="nf-row nf-gap-12 nf-mt-24 nf-justify-end">
-          <button type="button" className="nf-btn-outline admin-import-btn" onClick={onCancel}>
-            キャンセル
-          </button>
-          <button
-            type="button"
-            className="admin-import-btn admin-import-btn-primary"
-            onClick={handleImport}
-          >
-            インポート
-          </button>
-        </div>
-      </div>
-    </div>
-  );
-}
+
+  const handleImportFromDrive = async () => {
+    const url = importUrl?.trim();
+    if (!url) {
+      showAlert("Google Drive URLを入力してください");
+      return;
+    }
+
+    setImportDialogOpen(false);
+    setImporting(true);
+
+    try {
+      // Google DriveからフォームデータをAPI経由で取得
+      const result = await importFormsFromDrive(url);
+      const { forms: importedForms, skipped = 0, parseFailed = 0 } = result;
+      const detail = buildImportDetail(skipped, parseFailed);
+
+      if (!importedForms || importedForms.length === 0) {
+        showAlert(`有効なフォームがありませんでした${detail}。`);
+        setImporting(false);
+        return;
+      }
+
+      // インポートワークフローを実行
+      await startImportWorkflow(importedForms, { skipped, parseFailed });
+    } catch (error) {
+      console.error("[DriveImport] import from Drive failed", error);
+      showAlert(error?.message || "Google Driveからのインポートに失敗しました");
+      setImporting(false);
+    }
+  };
+
+  const confirmArchiveAction = () => {
+    const targetIds = (confirmArchive.targetIds && confirmArchive.targetIds.length
+      ? confirmArchive.targetIds
+      : confirmArchive.formId
+        ? [confirmArchive.formId]
+        : []);
+    if (!targetIds.length) return;
+
+    // アーカイブ状態を保持
+    const shouldUnarchive = confirmArchive.allArchived;
+
+    // ダイアログを即座に閉じて選択をクリア
+    clearSelectionByIds(targetIds);
+    setConfirmArchive({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false });
+
+    // バックグラウンドで一括処理を実行
+    (async () => {
+      try {
+        if (shouldUnarchive) {
+          await unarchiveForms(targetIds);
+        } else {
+          await archiveForms(targetIds);
+        }
+      } catch (error) {
+        console.error("[AdminDashboard] Archive action failed:", error);
+        showAlert(`アーカイブ処理中にエラーが発生しました: ${error.message}`);
+      }
+    })();
+  };
+
+  const confirmDeleteAction = async () => {
+    const targetIds = (confirmDelete.targetIds && confirmDelete.targetIds.length
+      ? confirmDelete.targetIds
+      : confirmDelete.formId
+        ? [confirmDelete.formId]
+        : []);
+    if (!targetIds.length) return;
+
+    try {
+      await deleteForms(targetIds);
+      clearSelectionByIds(targetIds);
+      setConfirmDelete({ open: false, formId: null, targetIds: [], multiple: false });
+    } catch (error) {
+      console.error("[AdminDashboard] Delete action failed:", error);
+      showAlert(error?.message || "フォームの削除中にエラーが発生しました");
+    }
+  };
+
+  const goToEditor = (formId) => {
+    navigate(`/forms/${formId}/edit`);
+  };
+
+  const handleCopyId = useCallback((formId, event) => {
+    event.stopPropagation();
+    const baseUrl = window.__GAS_WEBAPP_URL__ || window.location.origin;
+    const fullUrl = `${baseUrl}?form=${formId}`;
+    navigator.clipboard.writeText(fullUrl).then(() => {
+      setCopiedId(formId);
+      setTimeout(() => setCopiedId(null), 2000);
+    }).catch((error) => {
+      console.error("Failed to copy:", error);
+      showAlert("URLのコピーに失敗しました");
+    });
+  }, [showAlert]);
+
+  const handleCreateNew = () => {
+    navigate("/forms/new");
+  };
+
+  return (
+    <AppLayout
+      title="フォーム管理"
+      badge="フォーム一覧"
+      fallbackPath="/"
+      actions={null}
+      sidebarActions={
+        <>
+          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleCreateNew}>
+            新規作成
+          </button>
+          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleImport}>
+            {importing ? "インポート中..." : "インポート"}
+          </button>
+          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-13" onClick={handleExport} disabled={selected.size === 0}>
+            エクスポート
+          </button>
+          <button
+            type="button"
+            className="nf-btn-outline nf-btn-sidebar nf-text-13"
+            onClick={handleArchiveSelected}
+            disabled={selected.size === 0}
+          >
+            アーカイブ
+          </button>
+          <button
+            type="button"
+            className="nf-btn-outline nf-btn-sidebar nf-text-13 admin-danger-btn"
+            onClick={handleDeleteSelected}
+            disabled={selected.size === 0}
+          >
+            削除
+          </button>
+          <button
+            type="button"
+            className={`nf-btn-outline nf-btn-sidebar nf-text-13${!loadingForms ? " admin-refresh-btn" : ""}`}
+            onClick={() => refreshForms("manual:admin-dashboard")}
+            disabled={loadingForms}
+          >
+            {loadingForms ? "🔄 更新中..." : "🔄 更新"}
+          </button>
+        </>
+      }
+    >
+      {loadingForms ? (
+        <p className="nf-text-subtle">読み込み中...</p>
+      ) : (
+        <div className="search-table-wrap">
+          <table className="search-table">
+            <thead>
+              <tr>
+                <th className="search-th">
+                  <input type="checkbox" checked={adminForms.length > 0 && selected.size === adminForms.length} onChange={(event) => selectAll(event.target.checked)} />
+                </th>
+                <th className="search-th">名称</th>
+                <th className="search-th">フォームID</th>
+                <th className="search-th">更新日時</th>
+                <th className="search-th">表示項目</th>
+                <th className="search-th">状態</th>
+              </tr>
+            </thead>
+            <tbody>
+              {adminForms.map((form) => {
+                const isLoadError = !!form.loadError;
+                const summary = isLoadError ? "" : formatDisplayFieldsSummary(form);
+                const loadError = form.loadError || null;
+                const lastUpdated = isLoadError ? formatDate(loadError?.lastTriedAt) : formatDate(form.modifiedAt);
+                return (
+                  <tr
+                    key={form.id}
+                    className="admin-row"
+                    data-clickable={isLoadError ? "false" : "true"}
+                    data-error={isLoadError ? "true" : "false"}
+                    onClick={() => {
+                      if (!isLoadError) {
+                        goToEditor(form.id);
+                      }
+                    }}
+                  >
+                    <td className="search-td" onClick={(e) => e.stopPropagation()}>
+                      <input type="checkbox" checked={selected.has(form.id)} onChange={() => toggleSelect(form.id)} />
+                      {isLoadError && <div className="nf-text-danger-ink nf-text-11 nf-mt-4">削除のみ可能</div>}
+                    </td>
+                    <td className="search-td">
+                      {isLoadError ? (
+                        <>
+                          <div className="nf-fw-600 nf-text-danger-ink">{loadError?.fileName || "(名称不明)"}</div>
+                          <div className="nf-text-danger-ink-strong nf-text-12">フォームID: {form.id}</div>
+                          {loadError?.fileId && <div className="nf-text-danger-ink-strong nf-text-12">ファイルID: {loadError.fileId}</div>}
+                          {loadError?.driveFileUrl && (
+                            <div className="nf-mt-6">
+                              <a
+                                href={loadError.driveFileUrl}
+                                target="_blank"
+                                rel="noreferrer"
+                                onClick={(event) => event.stopPropagation()}
+                                className="admin-link"
+                              >
+                                Driveで確認
+                              </a>
+                            </div>
+                          )}
+                        </>
+                      ) : (
+                        <>
+                          <div className="nf-fw-600">{form.settings?.formTitle || "(無題)"}</div>
+                          {form.description && <div className="nf-text-muted nf-text-12">{form.description}</div>}
+                        </>
+                      )}
+                    </td>
+                    <td className="search-td" onClick={(e) => e.stopPropagation()}>
+                      <div className="nf-row nf-gap-6">
+                        <span className="admin-form-id">{form.id}</span>
+                        <button
+                          type="button"
+                          className="admin-copy-btn"
+                          onClick={(e) => handleCopyId(form.id, e)}
+                          title="URLをコピー"
+                        >
+                          {copiedId === form.id ? "✓" : "📋"}
+                        </button>
+                      </div>
+                    </td>
+                    <td className="search-td">{lastUpdated}</td>
+                    <td className="search-td">
+                      {isLoadError ? (
+                        <>
+                          <div className="nf-text-danger-ink nf-fw-600">読み込みエラー</div>
+                          <div className="nf-text-danger-ink-strong nf-text-12">{loadError?.errorMessage || "読み込みに失敗しました"}</div>
+                          {loadError?.errorStage && <div className="nf-text-danger-ink-strong nf-text-11 nf-mt-4">ステージ: {loadError.errorStage}</div>}
+                        </>
+                      ) : summary ? (
+                        summary
+                      ) : (
+                        <span className="nf-text-subtle nf-text-12">設定なし</span>
+                      )}
+                    </td>
+                    <td className="search-td">
+                      {isLoadError ? (
+                        <span className="nf-text-danger-strong nf-fw-600">読み込みエラー</span>
+                      ) : form.archived ? (
+                        <span className="nf-text-danger-strong">アーカイブ済み</span>
+                      ) : (
+                        <span className="nf-text-success">公開中</span>
+                      )}
+                    </td>
+                  </tr>
+                );
+              })}
+              {adminForms.length === 0 && (
+                <tr>
+                  <td className="search-td nf-text-center" colSpan={6}>
+                    フォームが登録されていません。
+                  </td>
+                </tr>
+              )}
+            </tbody>
+          </table>
+        </div>
+      )}
+
+      <ConfirmDialog
+        open={confirmArchive.open}
+        title={confirmArchive.allArchived ? "アーカイブを解除" : "フォームをアーカイブ"}
+        message={
+          confirmArchive.allArchived
+            ? "このフォームのアーカイブを解除して公開中に戻します。よろしいですか？"
+            : "このフォームをアーカイブします。検索画面には表示されなくなります。よろしいですか？"
+        }
+        options={[
+          {
+            label: "キャンセル",
+            value: "cancel",
+            onSelect: () => setConfirmArchive({ open: false, formId: null, targetIds: [], multiple: false, allArchived: false, hasPublished: false }),
+          },
+          {
+            label: confirmArchive.allArchived ? "解除" : "アーカイブ",
+            value: "archive",
+            variant: "primary",
+            onSelect: confirmArchiveAction,
+          },
+        ]}
+      />
+
+      <ConfirmDialog
+        open={confirmDelete.open}
+        title="フォームを削除"
+        message={
+          confirmDelete.multiple
+            ? "選択したフォームをまとめて削除します。元に戻すことはできません。よろしいですか？"
+            : "このフォームを削除します。元に戻すことはできません。よろしいですか？"
+        }
+        options={[
+          {
+            label: "キャンセル",
+            value: "cancel",
+            onSelect: () => setConfirmDelete({ open: false, formId: null, targetIds: [], multiple: false }),
+          },
+          {
+            label: "削除",
+            value: "delete",
+            variant: "danger",
+            onSelect: confirmDeleteAction,
+          },
+        ]}
+      />
+
+      <ImportUrlDialog
+        open={importDialogOpen}
+        url={importUrl}
+        onUrlChange={setImportUrl}
+        onImport={handleImportFromDrive}
+        onCancel={() => setImportDialogOpen(false)}
+      />
+
+</AppLayout>
+  );
+}
+
+function ImportUrlDialog({ open, url, onUrlChange, onImport, onCancel }) {
+  const [error, setError] = useState("");
+
+  useEffect(() => {
+    if (!open) {
+      setError("");
+    }
+  }, [open]);
+
+  if (!open) return null;
+
+  const handleImport = () => {
+    const trimmed = (url || "").trim();
+    if (!trimmed) {
+      setError("Google Drive URLを入力してください");
+      return;
+    }
+    setError("");
+    onImport();
+  };
+
+  return (
+    <div className="admin-import-overlay">
+      <div className="admin-import-panel">
+        <h3 className="nf-text-18 nf-fw-700 nf-mb-8">Google Driveからインポート</h3>
+        <p className="nf-mb-16 nf-text-muted nf-text-14">
+          ファイルURLまたはフォルダURLを入力してください。
+        </p>
+
+        <div className="nf-mb-16">
+          <label className="nf-block nf-mb-6 nf-text-13 nf-fw-600">
+            Google Drive URL
+          </label>
+          <input
+            type="text"
+            value={url}
+            onChange={(event) => {
+              onUrlChange(event.target.value);
+              if (error) setError("");
+            }}
+            className="nf-input admin-import-input"
+            placeholder="https://drive.google.com/file/d/... または https://drive.google.com/drive/folders/..."
+          />
+          {error && <p className="nf-mt-6 nf-text-danger-strong nf-text-12">{error}</p>}
+          <p className="nf-mt-6 nf-text-muted nf-text-11">
+            ・ファイルURL: そのフォームのみをインポート<br />
+            ・フォルダURL: フォルダ内の全ての.jsonファイルをインポート<br />
+            ・既にプロパティサービスに存在するフォームIDは自動的にスキップされます
+          </p>
+        </div>
+
+        <div className="nf-row nf-gap-12 nf-mt-24 nf-justify-end">
+          <button type="button" className="nf-btn-outline admin-import-btn" onClick={onCancel}>
+            キャンセル
+          </button>
+          <button
+            type="button"
+            className="admin-import-btn admin-import-btn-primary"
+            onClick={handleImport}
+          >
+            インポート
+          </button>
+        </div>
+      </div>
+    </div>
+  );
+}
diff --git a/builder/src/pages/AdminFormEditorPage.jsx b/builder/src/pages/AdminFormEditorPage.jsx
index 0199cf6..d6c2d00 100644
--- a/builder/src/pages/AdminFormEditorPage.jsx
+++ b/builder/src/pages/AdminFormEditorPage.jsx
@@ -1,458 +1,456 @@
-import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";
-import { useLocation, useNavigate, useParams } from "react-router-dom";
-import AppLayout from "../app/components/AppLayout.jsx";
-import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
-import FormBuilderWorkspace from "../features/admin/FormBuilderWorkspace.jsx";
-import { SETTINGS_GROUPS } from "../features/settings/settingsSchema.js";
-import { useAppData } from "../app/state/AppDataProvider.jsx";
-import { useAlert } from "../app/hooks/useAlert.js";
-import { useBeforeUnloadGuard } from "../app/hooks/useBeforeUnloadGuard.js";
-import { normalizeSpreadsheetId } from "../utils/spreadsheet.js";
-import { validateSpreadsheet } from "../services/gasClient.js";
-import { cleanupTempData } from "../core/schema.js";
-import { omitThemeSetting } from "../utils/settings.js";
-import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
-import { useBuilderSettings } from "../features/settings/settingsStore.js";
-
-const fallbackPath = (locationState) => (locationState?.from ? locationState.from : "/forms");
-
-export default function AdminFormEditorPage() {
-  const { formId } = useParams();
-  const isEdit = Boolean(formId);
-  const { forms, getFormById, createForm, updateForm } = useAppData();
-  const form = isEdit ? getFormById(formId) : null;
-  const navigate = useNavigate();
-  const location = useLocation();
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const fallback = useMemo(() => fallbackPath(location.state), [location.state]);
-  const builderRef = useRef(null);
-  const initialMetaRef = useRef({ name: form?.name || "新規フォーム", description: form?.description || "" });
-  const initialSchema = useMemo(() => (form?.schema ? form.schema : []), [form]);
-  const initialSettings = useMemo(() => omitThemeSetting(form?.settings || {}), [form]);
-
-  const { settings } = useBuilderSettings();
-
-  useEffect(() => {
-    const globalTheme = settings?.theme || DEFAULT_THEME;
-    void applyThemeWithFallback(globalTheme, { persist: false });
-  }, [settings?.theme]);
-
-  const [name, setName] = useState(initialMetaRef.current.name);
-  const [description, setDescription] = useState(initialMetaRef.current.description);
-  const [driveUrl, setDriveUrl] = useState(form?.driveFileUrl || "");
-  const [localSettings, setLocalSettings] = useState(initialSettings);
-  const [builderDirty, setBuilderDirty] = useState(false);
-  const [confirmState, setConfirmState] = useState(false);
-  const [isSaving, setIsSaving] = useState(false);
-  const [nameError, setNameError] = useState("");
-  const [questionControl, setQuestionControl] = useState(null);
-
-  // QuestionControlの更新を監視
-  useEffect(() => {
-    const interval = setInterval(() => {
-      if (builderRef.current) {
-        const control = builderRef.current.getQuestionControl?.();
-        if (control !== questionControl) {
-          setQuestionControl(control);
-        }
-      }
-    }, 100);
-    return () => clearInterval(interval);
-  }, [questionControl]);
-
-  useEffect(() => {
-    if (!form) return;
-    const formTitle = form.settings?.formTitle || "";
-    initialMetaRef.current = { name: formTitle, description: form.description || "" };
-    setName(formTitle);
-    setDescription(form.description || "");
-    setDriveUrl(form.driveFileUrl || "");
-    setLocalSettings(omitThemeSetting(form.settings || {}));
-    setNameError("");
-  }, [form]);
-
-  const metaDirty = useMemo(() => name !== initialMetaRef.current.name || description !== initialMetaRef.current.description, [name, description]);
-  const isDirty = builderDirty || metaDirty;
-
-  useBeforeUnloadGuard(isDirty);
-
-  const navigateBack = () => {
-    if (location.state?.from) {
-      navigate(location.state.from, { replace: true });
-      return;
-    }
-    navigate(fallback, { replace: true });
-  };
-
-  const handleSettingsChange = useCallback((key, value) => {
-    setLocalSettings((prev) => ({ ...prev, [key]: value }));
-    builderRef.current?.updateSetting?.(key, value);
-  }, []);
-
-  const checkSpreadsheet = useCallback(async (spreadsheetIdOrUrl) => {
-    const trimmed = (spreadsheetIdOrUrl || "").trim();
-    if (!trimmed) {
-      // 未設定の場合はマイドライブに新規作成されるのでOK
-      return true;
-    }
-    try {
-      const result = await validateSpreadsheet(trimmed);
-      if (!result?.canView) {
-        showAlert("閲覧権限がありません。アクセス権を確認してください");
-        return false;
-      }
-      if (!result.canEdit) {
-        showAlert("閲覧権限のみで続行します。保存に失敗する場合は編集権限を付与してください。");
-      }
-      return true;
-    } catch (error) {
-      console.error("[AdminFormEditorPage] validateSpreadsheet failed", error);
-      showAlert(error?.message || "スプレッドシートを確認できません");
-      return false;
-    }
-  }, [showAlert]);
-
-  const handleSave = async () => {
-    if (!builderRef.current) return;
-    if (isSaving) return;
-    setIsSaving(true);
-
-    const trimmedName = (name || "").trim();
-    if (!trimmedName) {
-      setNameError("フォーム名を入力してください");
-      setIsSaving(false);
-      return;
-    }
-    setNameError("");
-
-    const settingsForCheck = builderRef.current.getSettings?.() || {};
-    const spreadsheetOk = await checkSpreadsheet(settingsForCheck.spreadsheetId || "");
-    if (!spreadsheetOk) {
-      setIsSaving(false);
-      return;
-    }
-
-    // バリデーション実行（失敗時はfalseを返す）
-    const saveResult = builderRef.current.save();
-    if (saveResult === false) {
-      setIsSaving(false);
-      return;
-    }
-
-    const schema = builderRef.current.getSchema();
-    const settings = builderRef.current.getSettings();
-    const trimmedSettings = omitThemeSetting(settings);
-    const preservedTheme = form?.settings?.theme || DEFAULT_THEME;
-    // 一時保存データをクリーンアップ
-    const cleanedSchema = cleanupTempData(schema);
-
-    const collectStyleStats = (schemaArr) => {
-      let totalQuestions = 0;
-      let showStyleSettingsTrue = 0;
-      let styleSettingsPresent = 0;
-      const walk = (arr) => {
-        (arr || []).forEach((field) => {
-          totalQuestions += 1;
-          if (field?.showStyleSettings === true) showStyleSettingsTrue += 1;
-          if (field?.styleSettings) styleSettingsPresent += 1;
-          if (field?.childrenByValue && typeof field.childrenByValue === "object") {
-            Object.values(field.childrenByValue).forEach((children) => walk(children));
-          }
-        });
-      };
-      walk(schemaArr);
-      return { totalQuestions, showStyleSettingsTrue, styleSettingsPresent };
-    };
-
-    console.log("[AdminFormEditorPage] style settings stats", {
-      formId,
-      beforeCleanup: collectStyleStats(schema),
-      afterCleanup: collectStyleStats(cleanedSchema),
-    });
-
-    const payload = {
-      // Include existing form data for fallback when getForm fails
-      ...(isEdit && form ? { id: form.id, createdAt: form.createdAt, driveFileUrl: form.driveFileUrl } : {}),
-      description,
-      schema: cleanedSchema,
-      settings: { ...trimmedSettings, theme: preservedTheme, formTitle: trimmedName },
-      archived: form?.archived ?? false,
-      schemaVersion: form?.schemaVersion ?? 1,
-    };
-
-    const targetUrl = driveUrl?.trim() || null;
-    const isFileUrl = targetUrl ? /\/file\/d\/[a-zA-Z0-9_-]+/.test(targetUrl) : false;
-    const isFolderUrl = targetUrl ? /\/folders\/[a-zA-Z0-9_-]+/.test(targetUrl) : false;
-    let saveMode = "auto";
-
-    if (!targetUrl) {
-      saveMode = isEdit ? "auto" : "copy_to_root";
-    } else if (isFileUrl) {
-      saveMode = "overwrite_existing";
-    } else if (isFolderUrl) {
-      saveMode = "copy_to_folder";
-    }
-
-    // ファイルURLのバリデーション
-    if (targetUrl) {
-      if (!isEdit && isFileUrl) {
-        showAlert("新規作成時はファイルURLは指定できません。フォルダURLまたは空白にしてください。");
-        setIsSaving(false);
-        return;
-      }
-      if (isEdit && isFileUrl) {
-        const originalFileUrl = form?.driveFileUrl || "";
-        if (targetUrl !== originalFileUrl) {
-          showAlert("既存フォームの保存先には、元のファイルURL以外のファイルURLは指定できません。フォルダURLまたは空白にしてください。");
-          setIsSaving(false);
-          return;
-        }
-      }
-    }
-
-    try {
-      if (isEdit) await updateForm(formId, payload, targetUrl, saveMode);
-      else await createForm(payload, targetUrl, saveMode);
-      initialMetaRef.current = { name: trimmedName, description: payload.description || "" };
-      setBuilderDirty(false);
-      setIsSaving(false);
-      navigate("/forms", { replace: true });
-    } catch (error) {
-      console.error(error);
-      setIsSaving(false);
-      showAlert(`保存に失敗しました: ${error?.message || error}`);
-    }
-  };
-
-  const handleBack = () => {
-    if (!isDirty) {
-      navigateBack();
-      return false;
-    }
-    setConfirmState(true);
-    return false;
-  };
-
-  const handleCancel = () => {
-    if (!isDirty) {
-      navigateBack();
-    } else {
-      setConfirmState(true);
-    }
-  };
-
-  const handleOpenSpreadsheet = () => {
-    if (!builderRef.current) return;
-    const settings = builderRef.current.getSettings();
-    const spreadsheetIdOrUrl = settings?.spreadsheetId || "";
-
-    if (!spreadsheetIdOrUrl) {
-      showAlert("スプレッドシートIDが設定されていません");
-      return;
-    }
-
-    // URLまたはIDからスプレッドシートIDを抽出
-    const spreadsheetId = normalizeSpreadsheetId(spreadsheetIdOrUrl);
-
-    // スプレッドシートを新しいタブで開く
-    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
-    window.open(url, "_blank", "noopener,noreferrer");
-  };
-
-  const confirmOptions = [
-    {
-      label: "保存して続行",
-      value: "save",
-      variant: "primary",
-      onSelect: async () => {
-        setConfirmState(false);
-        await handleSave();
-      },
-    },
-    {
-      label: "保存せずに戻る",
-      value: "discard",
-      onSelect: () => {
-        setConfirmState(false);
-        navigateBack();
-      },
-    },
-    {
-      label: "キャンセル",
-      value: "cancel",
-      onSelect: () => setConfirmState(false),
-    },
-  ];
-
-  return (
-    <AppLayout
-      title={isEdit ? "フォーム修正" : "フォーム新規作成"}
-      badge="フォーム管理"
-      fallbackPath={fallback}
-      onBack={handleBack}
-      backHidden={true}
-      sidebarActions={
-        <>
-          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={isSaving} onClick={handleSave}>
-            保存
-          </button>
-          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={handleCancel}>
-            キャンセル
-          </button>
-          <div className="nf-spacer-16" />
-          <button
-            type="button"
-            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-move-btn"
-            disabled={!questionControl?.canMoveUp}
-            onClick={() => questionControl?.moveUp?.()}
-          >
-            ↑ 上へ
-          </button>
-          <button
-            type="button"
-            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-move-btn"
-            disabled={!questionControl?.canMoveDown}
-            onClick={() => questionControl?.moveDown?.()}
-          >
-            ↓ 下へ
-          </button>
-          {questionControl?.selectedIndex !== null && (
-            <div className="nf-text-11 nf-text-muted nf-pad-4-8 nf-text-center nf-word-break">
-              {questionControl?.isOption
-                ? `${questionControl?.questionLabel || `質問 ${(questionControl?.selectedIndex ?? 0) + 1}`} > ${questionControl?.optionLabel || `選択肢 ${(questionControl?.optionIndex ?? 0) + 1}`}`
-                : questionControl?.questionLabel || `質問 ${(questionControl?.selectedIndex ?? 0) + 1}`
-              }
-            </div>
-          )}
-          <div className="nf-flex-1" />
-          <button
-            type="button"
-            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-info-btn"
-            onClick={handleOpenSpreadsheet}
-          >
-            📊 スプレッドシートを開く
-          </button>
-        </>
-      }
-    >
-      <div className="nf-card nf-mb-24">
-        <div className="nf-card nf-mb-16">
-          <h3 className="nf-settings-group-title nf-mb-16">フォームの基本情報</h3>
-
-          <div className="nf-col nf-gap-6 nf-mb-16">
-            <label className="nf-block nf-fw-600 nf-mb-6">フォーム名</label>
-            <input
-              value={name}
-              onChange={(event) => {
-                setName(event.target.value);
-                if (nameError) setNameError("");
-              }}
-              className="nf-input admin-input"
-              placeholder="フォーム名"
-            />
-            {nameError && <p className="nf-text-danger-strong nf-text-12 nf-m-0">{nameError}</p>}
-          </div>
-
-          <div className="nf-col nf-gap-6 nf-mb-16">
-            <label className="nf-block nf-fw-600 nf-mb-6">フォームの説明</label>
-            <textarea value={description} onChange={(event) => setDescription(event.target.value)} className="nf-input admin-input nf-min-h-80" placeholder="説明" />
-          </div>
-
-          <div className="nf-col nf-gap-6">
-            <label className="nf-block nf-fw-600 nf-mb-6">フォーム項目データのGoogle Drive保存先URL</label>
-            <input
-              value={driveUrl}
-              onChange={(event) => setDriveUrl(event.target.value)}
-              className="nf-input admin-input"
-              placeholder={isEdit
-                ? "空白: マイドライブルートに新たにコピー / フォルダURL: 指定フォルダにコピー"
-                : "空白: マイドライブルート / フォルダURL: 指定フォルダに保存"}
-            />
-            <p className="nf-text-11 nf-text-muted nf-mt-4 nf-mb-0">
-              {isEdit
-                ? "現在のファイルURLが表示されています。空白にするとマイドライブルートに新たなコピーを作成します。フォルダURLに変更するとそのフォルダにコピーを作成します。ファイルURLは元のURL以外は指定できません。"
-                : "空白の場合はマイドライブのルートに保存されます。フォルダURLを指定するとそのフォルダに保存されます。ファイルURLは指定できません。"}
-            </p>
-          </div>
-        </div>
-
-        {SETTINGS_GROUPS.map((group) => (
-          <div key={group.key} className="nf-card nf-mb-16">
-            <div className="nf-settings-group-title nf-mb-12">{group.label}</div>
-            {(() => {
-              const checkboxFields = group.fields.filter((f) => f.type === "checkbox");
-              const otherFields = group.fields.filter((f) => f.type !== "checkbox");
-              return (
-                <>
-                  {otherFields.map((field) => {
-                    const isSelect = field.type === "select" || Array.isArray(field.options);
-                    return (
-                      <div key={field.key} className="nf-mb-12">
-                        <label className="nf-block nf-fw-600 nf-mb-6">
-                          {field.label}
-                          {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
-                        </label>
-                        {isSelect ? (
-                          <select
-                            className="nf-input"
-                            value={localSettings[field.key] ?? ""}
-                            onChange={(event) => handleSettingsChange(field.key, event.target.value)}
-                          >
-                            {(field.options || []).map((option) => (
-                              <option key={option.value} value={option.value}>
-                                {option.label}
-                              </option>
-                            ))}
-                          </select>
-                        ) : (
-                          <input
-                            className="nf-input"
-                            type={field.type || "text"}
-                            value={localSettings[field.key] ?? ""}
-                            placeholder={field.placeholder}
-                            onChange={(event) => handleSettingsChange(field.key, event.target.value)}
-                          />
-                        )}
-                        {field.description && (
-                          <p className="nf-text-11 nf-text-muted nf-mt-4 nf-mb-0">{field.description}</p>
-                        )}
-                      </div>
-                    );
-                  })}
-                  {checkboxFields.length > 0 && (
-                    <div className="nf-flex nf-flex-wrap nf-gap-16 nf-mb-12">
-                      {checkboxFields.map((field) => (
-                        <label key={field.key} className="nf-flex nf-items-center nf-gap-8" style={{ cursor: "pointer" }}>
-                          <input
-                            type="checkbox"
-                            checked={localSettings[field.key] !== undefined ? !!localSettings[field.key] : !!field.defaultValue}
-                            onChange={(event) => handleSettingsChange(field.key, event.target.checked)}
-                          />
-                          <span className="nf-fw-600">{field.label}</span>
-                        </label>
-                      ))}
-                    </div>
-                  )}
-                </>
-              );
-            })()}
-          </div>
-        ))}
-
-        <FormBuilderWorkspace
-          ref={builderRef}
-          initialSchema={initialSchema}
-          initialSettings={initialSettings}
-          formTitle={name || "フォーム"}
-          onDirtyChange={setBuilderDirty}
-          showToolbarSave={false}
-        />
-      </div>
-
-      <ConfirmDialog open={confirmState} title="未保存の変更があります" message="保存せずに離れますか？" options={confirmOptions} />
-
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
-  );
-}
+import React, { useCallback, useEffect, useMemo, useRef, useState } from "react";
+import { useLocation, useNavigate, useParams } from "react-router-dom";
+import AppLayout from "../app/components/AppLayout.jsx";
+import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
+import FormBuilderWorkspace from "../features/admin/FormBuilderWorkspace.jsx";
+import { SETTINGS_GROUPS } from "../features/settings/settingsSchema.js";
+import { useAppData } from "../app/state/AppDataProvider.jsx";
+import { useAlert } from "../app/hooks/useAlert.js";
+import { useBeforeUnloadGuard } from "../app/hooks/useBeforeUnloadGuard.js";
+import { normalizeSpreadsheetId } from "../utils/spreadsheet.js";
+import { validateSpreadsheet } from "../services/gasClient.js";
+import { cleanupTempData } from "../core/schema.js";
+import { omitThemeSetting } from "../utils/settings.js";
+import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
+import { useBuilderSettings } from "../features/settings/settingsStore.js";
+
+const fallbackPath = (locationState) => (locationState?.from ? locationState.from : "/forms");
+
+export default function AdminFormEditorPage() {
+  const { formId } = useParams();
+  const isEdit = Boolean(formId);
+  const { forms, getFormById, createForm, updateForm } = useAppData();
+  const form = isEdit ? getFormById(formId) : null;
+  const navigate = useNavigate();
+  const location = useLocation();
+  const { showAlert } = useAlert();
+const fallback = useMemo(() => fallbackPath(location.state), [location.state]);
+  const builderRef = useRef(null);
+  const initialMetaRef = useRef({ name: form?.name || "新規フォーム", description: form?.description || "" });
+  const initialSchema = useMemo(() => (form?.schema ? form.schema : []), [form]);
+  const initialSettings = useMemo(() => omitThemeSetting(form?.settings || {}), [form]);
+
+  const { settings } = useBuilderSettings();
+
+  useEffect(() => {
+    const globalTheme = settings?.theme || DEFAULT_THEME;
+    void applyThemeWithFallback(globalTheme, { persist: false });
+  }, [settings?.theme]);
+
+  const [name, setName] = useState(initialMetaRef.current.name);
+  const [description, setDescription] = useState(initialMetaRef.current.description);
+  const [driveUrl, setDriveUrl] = useState(form?.driveFileUrl || "");
+  const [localSettings, setLocalSettings] = useState(initialSettings);
+  const [builderDirty, setBuilderDirty] = useState(false);
+  const [confirmState, setConfirmState] = useState(false);
+  const [isSaving, setIsSaving] = useState(false);
+  const [nameError, setNameError] = useState("");
+  const [questionControl, setQuestionControl] = useState(null);
+
+  // QuestionControlの更新を監視
+  useEffect(() => {
+    const interval = setInterval(() => {
+      if (builderRef.current) {
+        const control = builderRef.current.getQuestionControl?.();
+        if (control !== questionControl) {
+          setQuestionControl(control);
+        }
+      }
+    }, 100);
+    return () => clearInterval(interval);
+  }, [questionControl]);
+
+  useEffect(() => {
+    if (!form) return;
+    const formTitle = form.settings?.formTitle || "";
+    initialMetaRef.current = { name: formTitle, description: form.description || "" };
+    setName(formTitle);
+    setDescription(form.description || "");
+    setDriveUrl(form.driveFileUrl || "");
+    setLocalSettings(omitThemeSetting(form.settings || {}));
+    setNameError("");
+  }, [form]);
+
+  const metaDirty = useMemo(() => name !== initialMetaRef.current.name || description !== initialMetaRef.current.description, [name, description]);
+  const isDirty = builderDirty || metaDirty;
+
+  useBeforeUnloadGuard(isDirty);
+
+  const navigateBack = () => {
+    if (location.state?.from) {
+      navigate(location.state.from, { replace: true });
+      return;
+    }
+    navigate(fallback, { replace: true });
+  };
+
+  const handleSettingsChange = useCallback((key, value) => {
+    setLocalSettings((prev) => ({ ...prev, [key]: value }));
+    builderRef.current?.updateSetting?.(key, value);
+  }, []);
+
+  const checkSpreadsheet = useCallback(async (spreadsheetIdOrUrl) => {
+    const trimmed = (spreadsheetIdOrUrl || "").trim();
+    if (!trimmed) {
+      // 未設定の場合はマイドライブに新規作成されるのでOK
+      return true;
+    }
+    try {
+      const result = await validateSpreadsheet(trimmed);
+      if (!result?.canView) {
+        showAlert("閲覧権限がありません。アクセス権を確認してください");
+        return false;
+      }
+      if (!result.canEdit) {
+        showAlert("閲覧権限のみで続行します。保存に失敗する場合は編集権限を付与してください。");
+      }
+      return true;
+    } catch (error) {
+      console.error("[AdminFormEditorPage] validateSpreadsheet failed", error);
+      showAlert(error?.message || "スプレッドシートを確認できません");
+      return false;
+    }
+  }, [showAlert]);
+
+  const handleSave = async () => {
+    if (!builderRef.current) return;
+    if (isSaving) return;
+    setIsSaving(true);
+
+    const trimmedName = (name || "").trim();
+    if (!trimmedName) {
+      setNameError("フォーム名を入力してください");
+      setIsSaving(false);
+      return;
+    }
+    setNameError("");
+
+    const settingsForCheck = builderRef.current.getSettings?.() || {};
+    const spreadsheetOk = await checkSpreadsheet(settingsForCheck.spreadsheetId || "");
+    if (!spreadsheetOk) {
+      setIsSaving(false);
+      return;
+    }
+
+    // バリデーション実行（失敗時はfalseを返す）
+    const saveResult = builderRef.current.save();
+    if (saveResult === false) {
+      setIsSaving(false);
+      return;
+    }
+
+    const schema = builderRef.current.getSchema();
+    const settings = builderRef.current.getSettings();
+    const trimmedSettings = omitThemeSetting(settings);
+    const preservedTheme = form?.settings?.theme || DEFAULT_THEME;
+    // 一時保存データをクリーンアップ
+    const cleanedSchema = cleanupTempData(schema);
+
+    const collectStyleStats = (schemaArr) => {
+      let totalQuestions = 0;
+      let showStyleSettingsTrue = 0;
+      let styleSettingsPresent = 0;
+      const walk = (arr) => {
+        (arr || []).forEach((field) => {
+          totalQuestions += 1;
+          if (field?.showStyleSettings === true) showStyleSettingsTrue += 1;
+          if (field?.styleSettings) styleSettingsPresent += 1;
+          if (field?.childrenByValue && typeof field.childrenByValue === "object") {
+            Object.values(field.childrenByValue).forEach((children) => walk(children));
+          }
+        });
+      };
+      walk(schemaArr);
+      return { totalQuestions, showStyleSettingsTrue, styleSettingsPresent };
+    };
+
+    console.log("[AdminFormEditorPage] style settings stats", {
+      formId,
+      beforeCleanup: collectStyleStats(schema),
+      afterCleanup: collectStyleStats(cleanedSchema),
+    });
+
+    const payload = {
+      // Include existing form data for fallback when getForm fails
+      ...(isEdit && form ? { id: form.id, createdAt: form.createdAt, driveFileUrl: form.driveFileUrl } : {}),
+      description,
+      schema: cleanedSchema,
+      settings: { ...trimmedSettings, theme: preservedTheme, formTitle: trimmedName },
+      archived: form?.archived ?? false,
+      schemaVersion: form?.schemaVersion ?? 1,
+    };
+
+    const targetUrl = driveUrl?.trim() || null;
+    const isFileUrl = targetUrl ? /\/file\/d\/[a-zA-Z0-9_-]+/.test(targetUrl) : false;
+    const isFolderUrl = targetUrl ? /\/folders\/[a-zA-Z0-9_-]+/.test(targetUrl) : false;
+    let saveMode = "auto";
+
+    if (!targetUrl) {
+      saveMode = isEdit ? "auto" : "copy_to_root";
+    } else if (isFileUrl) {
+      saveMode = "overwrite_existing";
+    } else if (isFolderUrl) {
+      saveMode = "copy_to_folder";
+    }
+
+    // ファイルURLのバリデーション
+    if (targetUrl) {
+      if (!isEdit && isFileUrl) {
+        showAlert("新規作成時はファイルURLは指定できません。フォルダURLまたは空白にしてください。");
+        setIsSaving(false);
+        return;
+      }
+      if (isEdit && isFileUrl) {
+        const originalFileUrl = form?.driveFileUrl || "";
+        if (targetUrl !== originalFileUrl) {
+          showAlert("既存フォームの保存先には、元のファイルURL以外のファイルURLは指定できません。フォルダURLまたは空白にしてください。");
+          setIsSaving(false);
+          return;
+        }
+      }
+    }
+
+    try {
+      if (isEdit) await updateForm(formId, payload, targetUrl, saveMode);
+      else await createForm(payload, targetUrl, saveMode);
+      initialMetaRef.current = { name: trimmedName, description: payload.description || "" };
+      setBuilderDirty(false);
+      setIsSaving(false);
+      navigate("/forms", { replace: true });
+    } catch (error) {
+      console.error(error);
+      setIsSaving(false);
+      showAlert(`保存に失敗しました: ${error?.message || error}`);
+    }
+  };
+
+  const handleBack = () => {
+    if (!isDirty) {
+      navigateBack();
+      return false;
+    }
+    setConfirmState(true);
+    return false;
+  };
+
+  const handleCancel = () => {
+    if (!isDirty) {
+      navigateBack();
+    } else {
+      setConfirmState(true);
+    }
+  };
+
+  const handleOpenSpreadsheet = () => {
+    if (!builderRef.current) return;
+    const settings = builderRef.current.getSettings();
+    const spreadsheetIdOrUrl = settings?.spreadsheetId || "";
+
+    if (!spreadsheetIdOrUrl) {
+      showAlert("スプレッドシートIDが設定されていません");
+      return;
+    }
+
+    // URLまたはIDからスプレッドシートIDを抽出
+    const spreadsheetId = normalizeSpreadsheetId(spreadsheetIdOrUrl);
+
+    // スプレッドシートを新しいタブで開く
+    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
+    window.open(url, "_blank", "noopener,noreferrer");
+  };
+
+  const confirmOptions = [
+    {
+      label: "保存して続行",
+      value: "save",
+      variant: "primary",
+      onSelect: async () => {
+        setConfirmState(false);
+        await handleSave();
+      },
+    },
+    {
+      label: "保存せずに戻る",
+      value: "discard",
+      onSelect: () => {
+        setConfirmState(false);
+        navigateBack();
+      },
+    },
+    {
+      label: "キャンセル",
+      value: "cancel",
+      onSelect: () => setConfirmState(false),
+    },
+  ];
+
+  return (
+    <AppLayout
+      title={isEdit ? "フォーム修正" : "フォーム新規作成"}
+      badge="フォーム管理"
+      fallbackPath={fallback}
+      onBack={handleBack}
+      backHidden={true}
+      sidebarActions={
+        <>
+          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={isSaving} onClick={handleSave}>
+            保存
+          </button>
+          <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={handleCancel}>
+            キャンセル
+          </button>
+          <div className="nf-spacer-16" />
+          <button
+            type="button"
+            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-move-btn"
+            disabled={!questionControl?.canMoveUp}
+            onClick={() => questionControl?.moveUp?.()}
+          >
+            ↑ 上へ
+          </button>
+          <button
+            type="button"
+            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-move-btn"
+            disabled={!questionControl?.canMoveDown}
+            onClick={() => questionControl?.moveDown?.()}
+          >
+            ↓ 下へ
+          </button>
+          {questionControl?.selectedIndex !== null && (
+            <div className="nf-text-11 nf-text-muted nf-pad-4-8 nf-text-center nf-word-break">
+              {questionControl?.isOption
+                ? `${questionControl?.questionLabel || `質問 ${(questionControl?.selectedIndex ?? 0) + 1}`} > ${questionControl?.optionLabel || `選択肢 ${(questionControl?.optionIndex ?? 0) + 1}`}`
+                : questionControl?.questionLabel || `質問 ${(questionControl?.selectedIndex ?? 0) + 1}`
+              }
+            </div>
+          )}
+          <div className="nf-flex-1" />
+          <button
+            type="button"
+            className="nf-btn-outline nf-btn-sidebar nf-text-14 admin-info-btn"
+            onClick={handleOpenSpreadsheet}
+          >
+            📊 スプレッドシートを開く
+          </button>
+        </>
+      }
+    >
+      <div className="nf-card nf-mb-24">
+        <div className="nf-card nf-mb-16">
+          <h3 className="nf-settings-group-title nf-mb-16">フォームの基本情報</h3>
+
+          <div className="nf-col nf-gap-6 nf-mb-16">
+            <label className="nf-block nf-fw-600 nf-mb-6">フォーム名</label>
+            <input
+              value={name}
+              onChange={(event) => {
+                setName(event.target.value);
+                if (nameError) setNameError("");
+              }}
+              className="nf-input admin-input"
+              placeholder="フォーム名"
+            />
+            {nameError && <p className="nf-text-danger-strong nf-text-12 nf-m-0">{nameError}</p>}
+          </div>
+
+          <div className="nf-col nf-gap-6 nf-mb-16">
+            <label className="nf-block nf-fw-600 nf-mb-6">フォームの説明</label>
+            <textarea value={description} onChange={(event) => setDescription(event.target.value)} className="nf-input admin-input nf-min-h-80" placeholder="説明" />
+          </div>
+
+          <div className="nf-col nf-gap-6">
+            <label className="nf-block nf-fw-600 nf-mb-6">フォーム項目データのGoogle Drive保存先URL</label>
+            <input
+              value={driveUrl}
+              onChange={(event) => setDriveUrl(event.target.value)}
+              className="nf-input admin-input"
+              placeholder={isEdit
+                ? "空白: マイドライブルートに新たにコピー / フォルダURL: 指定フォルダにコピー"
+                : "空白: マイドライブルート / フォルダURL: 指定フォルダに保存"}
+            />
+            <p className="nf-text-11 nf-text-muted nf-mt-4 nf-mb-0">
+              {isEdit
+                ? "現在のファイルURLが表示されています。空白にするとマイドライブルートに新たなコピーを作成します。フォルダURLに変更するとそのフォルダにコピーを作成します。ファイルURLは元のURL以外は指定できません。"
+                : "空白の場合はマイドライブのルートに保存されます。フォルダURLを指定するとそのフォルダに保存されます。ファイルURLは指定できません。"}
+            </p>
+          </div>
+        </div>
+
+        {SETTINGS_GROUPS.map((group) => (
+          <div key={group.key} className="nf-card nf-mb-16">
+            <div className="nf-settings-group-title nf-mb-12">{group.label}</div>
+            {(() => {
+              const checkboxFields = group.fields.filter((f) => f.type === "checkbox");
+              const otherFields = group.fields.filter((f) => f.type !== "checkbox");
+              return (
+                <>
+                  {otherFields.map((field) => {
+                    const isSelect = field.type === "select" || Array.isArray(field.options);
+                    return (
+                      <div key={field.key} className="nf-mb-12">
+                        <label className="nf-block nf-fw-600 nf-mb-6">
+                          {field.label}
+                          {field.required && <span className="nf-text-danger nf-ml-4">*</span>}
+                        </label>
+                        {isSelect ? (
+                          <select
+                            className="nf-input"
+                            value={localSettings[field.key] ?? ""}
+                            onChange={(event) => handleSettingsChange(field.key, event.target.value)}
+                          >
+                            {(field.options || []).map((option) => (
+                              <option key={option.value} value={option.value}>
+                                {option.label}
+                              </option>
+                            ))}
+                          </select>
+                        ) : (
+                          <input
+                            className="nf-input"
+                            type={field.type || "text"}
+                            value={localSettings[field.key] ?? ""}
+                            placeholder={field.placeholder}
+                            onChange={(event) => handleSettingsChange(field.key, event.target.value)}
+                          />
+                        )}
+                        {field.description && (
+                          <p className="nf-text-11 nf-text-muted nf-mt-4 nf-mb-0">{field.description}</p>
+                        )}
+                      </div>
+                    );
+                  })}
+                  {checkboxFields.length > 0 && (
+                    <div className="nf-flex nf-flex-wrap nf-gap-16 nf-mb-12">
+                      {checkboxFields.map((field) => (
+                        <label key={field.key} className="nf-flex nf-items-center nf-gap-8" style={{ cursor: "pointer" }}>
+                          <input
+                            type="checkbox"
+                            checked={localSettings[field.key] !== undefined ? !!localSettings[field.key] : !!field.defaultValue}
+                            onChange={(event) => handleSettingsChange(field.key, event.target.checked)}
+                          />
+                          <span className="nf-fw-600">{field.label}</span>
+                        </label>
+                      ))}
+                    </div>
+                  )}
+                </>
+              );
+            })()}
+          </div>
+        ))}
+
+        <FormBuilderWorkspace
+          ref={builderRef}
+          initialSchema={initialSchema}
+          initialSettings={initialSettings}
+          formTitle={name || "フォーム"}
+          onDirtyChange={setBuilderDirty}
+          showToolbarSave={false}
+        />
+      </div>
+
+      <ConfirmDialog open={confirmState} title="未保存の変更があります" message="保存せずに離れますか？" options={confirmOptions} />
+
+</AppLayout>
+  );
+}
diff --git a/builder/src/pages/AdminSettingsPage.jsx b/builder/src/pages/AdminSettingsPage.jsx
index 0e3c316..c1bd071 100644
--- a/builder/src/pages/AdminSettingsPage.jsx
+++ b/builder/src/pages/AdminSettingsPage.jsx
@@ -1,6 +1,5 @@
 import React, { useEffect, useMemo, useState } from "react";
 import AppLayout from "../app/components/AppLayout.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
 import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
 import { useAlert } from "../app/hooks/useAlert.js";
 import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
@@ -14,8 +13,8 @@ const normalizeAdminEmailInput = (value) => String(value || "")
   .join(";");
 
 export default function AdminSettingsPage() {
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const { settings } = useBuilderSettings();
+  const { showAlert } = useAlert();
+const { settings } = useBuilderSettings();
   const [deployTime, setDeployTime] = useState("");
 
   const [adminKey, setAdminKeyState] = useState("");
@@ -220,7 +219,6 @@ export default function AdminSettingsPage() {
         options={adminEmailConfirmOptions}
       />
 
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
+</AppLayout>
   );
 }
diff --git a/builder/src/pages/ConfigPage.jsx b/builder/src/pages/ConfigPage.jsx
index 96a3295..34e53ad 100644
--- a/builder/src/pages/ConfigPage.jsx
+++ b/builder/src/pages/ConfigPage.jsx
@@ -1,7 +1,6 @@
 import React, { useCallback, useEffect, useMemo, useState } from "react";
 import { useSearchParams } from "react-router-dom";
 import AppLayout from "../app/components/AppLayout.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
 import { useAlert } from "../app/hooks/useAlert.js";
 import { useBuilderSettings } from "../features/settings/settingsStore.js";
 import { useAppData } from "../app/state/AppDataProvider.jsx";
@@ -39,9 +38,8 @@ export default function ConfigPage() {
 
   const { settings, updateSetting } = useBuilderSettings({ applyGlobalTheme: false });
   const { forms, getFormById, updateForm } = useAppData();
-  const { alertState, showAlert, closeAlert } = useAlert();
-
-  const targetForm = useMemo(
+  const { showAlert } = useAlert();
+const targetForm = useMemo(
     () => (requestedFormId ? getFormById(requestedFormId) : null),
     [requestedFormId, getFormById],
   );
@@ -298,8 +296,7 @@ export default function ConfigPage() {
           <p>指定されたフォームが見つかりません。</p>
           <p className="nf-text-muted nf-text-14 nf-mt-8">メイン画面からフォームを選択してやり直してください。</p>
         </div>
-        <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-      </AppLayout>
+</AppLayout>
     );
   }
 
@@ -405,7 +402,6 @@ export default function ConfigPage() {
         }
         options={removeOptions}
       />
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
+</AppLayout>
   );
 }
diff --git a/builder/src/pages/FormPage.jsx b/builder/src/pages/FormPage.jsx
index 934b18a..a6bf16e 100644
--- a/builder/src/pages/FormPage.jsx
+++ b/builder/src/pages/FormPage.jsx
@@ -2,13 +2,12 @@ import React, { useCallback, useEffect, useMemo, useRef, useState } from "react"
 import { useLocation, useNavigate, useParams } from "react-router-dom";
 import AppLayout from "../app/components/AppLayout.jsx";
 import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
 import PreviewPage from "../features/preview/PreviewPage.jsx";
 import { useAppData } from "../app/state/AppDataProvider.jsx";
 import { dataStore } from "../app/state/dataStore.js";
 import { restoreResponsesFromData, hasDirtyChanges, collectDefaultNowResponses } from "../utils/responses.js";
-import { submitResponses, hasScriptRun } from "../services/gasClient.js";
-import { normalizeSpreadsheetId } from "../utils/spreadsheet.js";
+import { submitResponses, hasScriptRun } from "../services/gasClient.js";
+import { normalizeSpreadsheetId } from "../utils/spreadsheet.js";
 import { useAlert } from "../app/hooks/useAlert.js";
 import { useBeforeUnloadGuard } from "../app/hooks/useBeforeUnloadGuard.js";
 import { normalizeSchemaIDs } from "../core/schema.js";
@@ -16,33 +15,33 @@ import { getCachedEntryWithIndex } from "../app/state/recordsCache.js";
 import { RECORD_CACHE_MAX_AGE_MS } from "../app/state/cachePolicy.js";
 import { useAuth } from "../app/state/authContext.jsx";
 import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
-
+
 const fallbackForForm = (formId, locationState) => {
   if (locationState?.from) return locationState.from;
   if (formId) return `/search?form=${formId}`;
   return "/";
 };
-
+
 export default function FormPage() {
   const { formId, entryId } = useParams();
   const { getFormById } = useAppData();
   const { userName, userEmail } = useAuth();
   const location = useLocation();
   const navigate = useNavigate();
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const form = formId ? getFormById(formId) : null;
-  const normalizedSchema = useMemo(() => normalizeSchemaIDs(form?.schema || []), [form]);
-  const [entry, setEntry] = useState(null);
-  const [loading, setLoading] = useState(true);
-  const [responses, setResponses] = useState({});
-  const [currentRecordId, setCurrentRecordId] = useState(entryId || null);
-  const [confirmState, setConfirmState] = useState({ open: false, intent: null });
-  const [isSaving, setIsSaving] = useState(false);
-  const [mode, setMode] = useState(entryId ? "view" : "edit");
-  const [isReloading, setIsReloading] = useState(false);
-  const initialResponsesRef = useRef({});
-  const previewRef = useRef(null);
-
+  const { showAlert } = useAlert();
+const form = formId ? getFormById(formId) : null;
+  const normalizedSchema = useMemo(() => normalizeSchemaIDs(form?.schema || []), [form]);
+  const [entry, setEntry] = useState(null);
+  const [loading, setLoading] = useState(true);
+  const [responses, setResponses] = useState({});
+  const [currentRecordId, setCurrentRecordId] = useState(entryId || null);
+  const [confirmState, setConfirmState] = useState({ open: false, intent: null });
+  const [isSaving, setIsSaving] = useState(false);
+  const [mode, setMode] = useState(entryId ? "view" : "edit");
+  const [isReloading, setIsReloading] = useState(false);
+  const initialResponsesRef = useRef({});
+  const previewRef = useRef(null);
+
   const fallbackPath = useMemo(() => fallbackForForm(formId, location.state), [formId, location.state]);
 
   useEffect(() => {
@@ -50,12 +49,12 @@ export default function FormPage() {
     const theme = form?.settings?.theme || DEFAULT_THEME;
     void applyThemeWithFallback(theme, { persist: false });
   }, [form?.id, form?.settings?.theme]);
-
-  const entryIds = location.state?.entryIds || [];
-  const currentIndex = entryId ? entryIds.indexOf(entryId) : -1;
-  const hasPrev = currentIndex > 0;
-  const hasNext = currentIndex >= 0 && currentIndex < entryIds.length - 1;
-
+
+  const entryIds = location.state?.entryIds || [];
+  const currentIndex = entryId ? entryIds.indexOf(entryId) : -1;
+  const hasPrev = currentIndex > 0;
+  const hasNext = currentIndex >= 0 && currentIndex < entryIds.length - 1;
+
   useEffect(() => {
     setMode(entryId ? "view" : "edit");
   }, [entryId]);
@@ -79,13 +78,13 @@ export default function FormPage() {
   useEffect(() => {
     let mounted = true;
     const loadEntry = async () => {
-      const tStart = performance.now();
-      console.log(`[PERF] FormPage loadEntry START - formId: ${formId}, entryId: ${entryId}`);
-
-      if (!formId || !form) {
-        setLoading(false);
-        return;
-      }
+      const tStart = performance.now();
+      console.log(`[PERF] FormPage loadEntry START - formId: ${formId}, entryId: ${entryId}`);
+
+      if (!formId || !form) {
+        setLoading(false);
+        return;
+      }
       if (!entryId) {
         const initialResponses = collectDefaultNowResponses(normalizedSchema, new Date(), { userName });
         initialResponsesRef.current = initialResponses;
@@ -93,12 +92,12 @@ export default function FormPage() {
         setLoading(false);
         return;
       }
-      setLoading(true);
-
-      const tBeforeGetEntry = performance.now();
-      console.log(`[PERF] FormPage before dataStore.getEntry - Time from start: ${(tBeforeGetEntry - tStart).toFixed(2)}ms`);
-
-      // まずキャッシュから取得を試みる
+      setLoading(true);
+
+      const tBeforeGetEntry = performance.now();
+      console.log(`[PERF] FormPage before dataStore.getEntry - Time from start: ${(tBeforeGetEntry - tStart).toFixed(2)}ms`);
+
+      // まずキャッシュから取得を試みる
       const { entry: cachedEntry, rowIndex, lastSyncedAt } = await getCachedEntryWithIndex(formId, entryId);
 
       if (cachedEntry && mounted) {
@@ -106,14 +105,14 @@ export default function FormPage() {
         applyEntryToState(cachedEntry, entryId);
         setLoading(false);
         console.log(`[PERF] FormPage cache displayed - Time: ${(performance.now() - tStart).toFixed(2)}ms, rowIndex: ${rowIndex}`);
-
-        // キャッシュ年齢を計算し、5分以上古い場合はバックグラウンド更新
-        const cacheAge = lastSyncedAt ? Date.now() - lastSyncedAt : Infinity;
-        const shouldBackground = cacheAge >= RECORD_CACHE_MAX_AGE_MS;
-
-        if (shouldBackground) {
-          console.log(`[PERF] FormPage starting background refresh (cache age: ${cacheAge}ms, threshold: ${RECORD_CACHE_MAX_AGE_MS}ms, rowIndexHint: ${rowIndex})`);
-          setIsReloading(true);
+
+        // キャッシュ年齢を計算し、5分以上古い場合はバックグラウンド更新
+        const cacheAge = lastSyncedAt ? Date.now() - lastSyncedAt : Infinity;
+        const shouldBackground = cacheAge >= RECORD_CACHE_MAX_AGE_MS;
+
+        if (shouldBackground) {
+          console.log(`[PERF] FormPage starting background refresh (cache age: ${cacheAge}ms, threshold: ${RECORD_CACHE_MAX_AGE_MS}ms, rowIndexHint: ${rowIndex})`);
+          setIsReloading(true);
           dataStore.getEntry(formId, entryId, { rowIndexHint: rowIndex }).then((freshData) => {
             if (!mounted) return;
             if (freshData) {
@@ -121,18 +120,18 @@ export default function FormPage() {
               console.log(`[PERF] FormPage background refresh complete - Total time: ${(performance.now() - tStart).toFixed(2)}ms`);
             }
             setIsReloading(false);
-          }).catch((error) => {
-            console.error("[FormPage] background refresh failed:", error);
-            setIsReloading(false);
-          });
-        } else {
-          console.log(`[PERF] FormPage cache is fresh (age: ${cacheAge}ms, threshold: ${RECORD_CACHE_MAX_AGE_MS}ms), no background refresh`);
-        }
-      } else {
-        // キャッシュがない場合は同期読み取り（rowIndexがある場合は渡す）
-        const data = await dataStore.getEntry(formId, entryId, rowIndex !== undefined ? { rowIndexHint: rowIndex } : {});
-
-        const tAfterGetEntry = performance.now();
+          }).catch((error) => {
+            console.error("[FormPage] background refresh failed:", error);
+            setIsReloading(false);
+          });
+        } else {
+          console.log(`[PERF] FormPage cache is fresh (age: ${cacheAge}ms, threshold: ${RECORD_CACHE_MAX_AGE_MS}ms), no background refresh`);
+        }
+      } else {
+        // キャッシュがない場合は同期読み取り（rowIndexがある場合は渡す）
+        const data = await dataStore.getEntry(formId, entryId, rowIndex !== undefined ? { rowIndexHint: rowIndex } : {});
+
+        const tAfterGetEntry = performance.now();
         console.log(`[PERF] FormPage after dataStore.getEntry - Time: ${(tAfterGetEntry - tBeforeGetEntry).toFixed(2)}ms, rowIndexHint: ${rowIndex}`);
 
         if (!mounted) return;
@@ -145,30 +144,30 @@ export default function FormPage() {
         const tEnd = performance.now();
         console.log(`[PERF] FormPage loadEntry COMPLETE - Total time: ${(tEnd - tStart).toFixed(2)}ms`);
       }
-    };
-    loadEntry();
+    };
+    loadEntry();
     return () => {
       mounted = false;
     };
   }, [formId, entryId, form, normalizedSchema, userName, applyEntryToState]);
-
-  const isDirty = useMemo(() => hasDirtyChanges(initialResponsesRef.current, responses), [responses]);
-
-  useBeforeUnloadGuard(isDirty);
-
-  const navigateBack = ({ saved = false } = {}) => {
-    const state = saved ? { saved: true } : undefined;
-    if (location.state?.from) {
-      navigate(location.state.from, { replace: true, state });
-      return;
-    }
-    if (fallbackPath) {
-      navigate(fallbackPath, { replace: true, state });
-    } else {
-      navigate("/", { replace: true, state });
-    }
-  };
-
+
+  const isDirty = useMemo(() => hasDirtyChanges(initialResponsesRef.current, responses), [responses]);
+
+  useBeforeUnloadGuard(isDirty);
+
+  const navigateBack = ({ saved = false } = {}) => {
+    const state = saved ? { saved: true } : undefined;
+    if (location.state?.from) {
+      navigate(location.state.from, { replace: true, state });
+      return;
+    }
+    if (fallbackPath) {
+      navigate(fallbackPath, { replace: true, state });
+    } else {
+      navigate("/", { replace: true, state });
+    }
+  };
+
   const handleSaveToStore = async ({ payload }) => {
     if (!form) throw new Error("form_not_found");
     const isNewEntry = !entry?.id;
@@ -183,72 +182,72 @@ export default function FormPage() {
       createdBy,
       modifiedBy,
     });
-
-    // スプレッドシート保存はバックグラウンドで継続
-    const settings = form.settings || {};
-    const spreadsheetId = normalizeSpreadsheetId(settings.spreadsheetId || "");
-    const sheetName = settings.sheetName || "Data";
-
-    if (spreadsheetId) {
-      if (!hasScriptRun()) {
-        console.warn("[FormPage] google.script.run unavailable; skipped background spreadsheet save");
-      } else {
-        void submitResponses({
-          spreadsheetId,
-          sheetName,
-          payload: { ...payload, id: saved.id },
-        }).catch((error) => {
-          console.error("[FormPage] Background spreadsheet save failed:", error);
-        });
-      }
+
+    // スプレッドシート保存はバックグラウンドで継続
+    const settings = form.settings || {};
+    const spreadsheetId = normalizeSpreadsheetId(settings.spreadsheetId || "");
+    const sheetName = settings.sheetName || "Data";
+
+    if (spreadsheetId) {
+      if (!hasScriptRun()) {
+        console.warn("[FormPage] google.script.run unavailable; skipped background spreadsheet save");
+      } else {
+        void submitResponses({
+          spreadsheetId,
+          sheetName,
+          payload: { ...payload, id: saved.id },
+        }).catch((error) => {
+          console.error("[FormPage] Background spreadsheet save failed:", error);
+        });
+      }
     } else {
       console.warn("[FormPage] No spreadsheetId configured, skipping spreadsheet save");
     }
     applyEntryToState(saved, saved.id);
     return saved;
   };
-
-  const triggerSave = async ({ redirect } = {}) => {
-    if (!form) {
-      showAlert("フォームが見つかりません");
-      return;
-    }
-    try {
-      setIsSaving(true);
-      const preview = previewRef.current;
-      if (!preview) throw new Error("preview_not_ready");
-      await preview.submit({ silent: true });
-      if (redirect) navigateBack({ saved: true });
-    } catch (error) {
-      console.warn(error);
-      if (error?.message === "validation_failed" || error?.message?.includes("missing_")) {
-        setIsSaving(false);
-        return;
-      }
-      setIsSaving(false);
-      showAlert(`保存に失敗しました: ${error?.message || error}`);
-      return;
-    }
-    setIsSaving(false);
-  };
-
-  const attemptLeave = (intent) => {
-    if (isDirty) {
-      setConfirmState({ open: true, intent });
-      return;
-    }
-    if (intent === "back" || intent === "cancel") {
-      navigateBack();
-      return;
-    }
-  };
-
-  const handleEditMode = async () => {
-    if (!formId || !entryId) return;
-    setIsReloading(true);
-    setMode("edit");
-    try {
-      const data = await dataStore.getEntry(formId, entryId, { forceSync: true });
+
+  const triggerSave = async ({ redirect } = {}) => {
+    if (!form) {
+      showAlert("フォームが見つかりません");
+      return;
+    }
+    try {
+      setIsSaving(true);
+      const preview = previewRef.current;
+      if (!preview) throw new Error("preview_not_ready");
+      await preview.submit({ silent: true });
+      if (redirect) navigateBack({ saved: true });
+    } catch (error) {
+      console.warn(error);
+      if (error?.message === "validation_failed" || error?.message?.includes("missing_")) {
+        setIsSaving(false);
+        return;
+      }
+      setIsSaving(false);
+      showAlert(`保存に失敗しました: ${error?.message || error}`);
+      return;
+    }
+    setIsSaving(false);
+  };
+
+  const attemptLeave = (intent) => {
+    if (isDirty) {
+      setConfirmState({ open: true, intent });
+      return;
+    }
+    if (intent === "back" || intent === "cancel") {
+      navigateBack();
+      return;
+    }
+  };
+
+  const handleEditMode = async () => {
+    if (!formId || !entryId) return;
+    setIsReloading(true);
+    setMode("edit");
+    try {
+      const data = await dataStore.getEntry(formId, entryId, { forceSync: true });
       if (!data) {
         showAlert("レコードが見つかりませんでした。削除された可能性があります。");
         navigateBack();
@@ -258,28 +257,28 @@ export default function FormPage() {
     } catch (error) {
       console.error("[FormPage] handleEditMode error:", error);
       showAlert(`データの読み込みに失敗しました: ${error?.message || error}`);
-    } finally {
-      setIsReloading(false);
-    }
-  };
-
-  const handleBack = () => {
-    if (!isDirty) {
-      navigateBack();
-      return false;
-    }
-    setConfirmState({ open: true, intent: "back" });
-    return false;
-  };
-
-  if (!form) {
-    return (
-      <AppLayout title="フォーム" fallbackPath="/">
-        <p className="nf-text-subtle">フォームが見つかりません。メイン画面からやり直してください。</p>
-      </AppLayout>
-    );
-  }
-
+    } finally {
+      setIsReloading(false);
+    }
+  };
+
+  const handleBack = () => {
+    if (!isDirty) {
+      navigateBack();
+      return false;
+    }
+    setConfirmState({ open: true, intent: "back" });
+    return false;
+  };
+
+  if (!form) {
+    return (
+      <AppLayout title="フォーム" fallbackPath="/">
+        <p className="nf-text-subtle">フォームが見つかりません。メイン画面からやり直してください。</p>
+      </AppLayout>
+    );
+  }
+
   const navigateToEntry = (targetEntryId) => {
     if (isDirty) {
       setConfirmState({ open: true, intent: `navigate:${targetEntryId}` });
@@ -287,10 +286,10 @@ export default function FormPage() {
     }
     navigateToEntryById(targetEntryId);
   };
-
-  const handleConfirmAction = async (action) => {
-    const intent = confirmState.intent;
-    setConfirmState({ open: false, intent: null });
+
+  const handleConfirmAction = async (action) => {
+    const intent = confirmState.intent;
+    setConfirmState({ open: false, intent: null });
     if (action === "discard") {
       if (intent && intent.startsWith("navigate:")) {
         const targetEntryId = intent.slice("navigate:".length);
@@ -308,78 +307,78 @@ export default function FormPage() {
       } else {
         await triggerSave({ redirect: true });
       }
-    }
-  };
-
-  const confirmOptions = [
-    {
-      label: "保存して続行",
-      value: "save",
-      variant: "primary",
-      onSelect: () => handleConfirmAction("save"),
-    },
-    {
-      label: "保存せずに戻る",
-      value: "discard",
-      onSelect: () => handleConfirmAction("discard"),
-    },
-    {
-      label: "キャンセル",
-      value: "cancel",
-      onSelect: () => setConfirmState({ open: false, intent: null }),
-    },
-  ];
-
-  const confirmMessage = "保存せずに前の画面へ戻りますか？";
-
-  return (
-    <AppLayout
-      title={`${form.settings?.formTitle || "(無題)"} - フォーム入力`}
-      fallbackPath={fallbackPath}
-      onBack={handleBack}
-      backHidden={true}
-      badge={{
-        label: (loading || isReloading) ? "読み取り中..." : (isViewMode ? "閲覧モード" : "編集モード"),
-        variant: (loading || isReloading) ? "loading" : (isViewMode ? "view" : "edit")
-      }}
-      sidebarActions={
-        <>
-          {isViewMode ? (
-            <>
-              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={handleEditMode}>
-                編集
-              </button>
-              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={() => navigateBack()}>
-                戻る
-              </button>
-            </>
-          ) : (
-            <>
-              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={isSaving || isReloading} onClick={() => triggerSave({ redirect: true })}>
-                保存
-              </button>
-              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={() => attemptLeave("cancel")}>
-                キャンセル
-              </button>
-            </>
-          )}
-          {entryIds.length > 0 && (
-            <>
-              <hr className="nf-sidebar-divider" />
-              <div className="nf-flex nf-gap-8 nf-items-center">
-                <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={!hasPrev} onClick={() => navigateToEntry(entryIds[currentIndex - 1])}>
-                  ← 前へ
-                </button>
-                <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={!hasNext} onClick={() => navigateToEntry(entryIds[currentIndex + 1])}>
-                  次へ →
-                </button>
-              </div>
-              <span className="nf-text-11 nf-text-muted">{currentIndex + 1} / {entryIds.length}</span>
-            </>
-          )}
-        </>
-      }
-    >
+    }
+  };
+
+  const confirmOptions = [
+    {
+      label: "保存して続行",
+      value: "save",
+      variant: "primary",
+      onSelect: () => handleConfirmAction("save"),
+    },
+    {
+      label: "保存せずに戻る",
+      value: "discard",
+      onSelect: () => handleConfirmAction("discard"),
+    },
+    {
+      label: "キャンセル",
+      value: "cancel",
+      onSelect: () => setConfirmState({ open: false, intent: null }),
+    },
+  ];
+
+  const confirmMessage = "保存せずに前の画面へ戻りますか？";
+
+  return (
+    <AppLayout
+      title={`${form.settings?.formTitle || "(無題)"} - フォーム入力`}
+      fallbackPath={fallbackPath}
+      onBack={handleBack}
+      backHidden={true}
+      badge={{
+        label: (loading || isReloading) ? "読み取り中..." : (isViewMode ? "閲覧モード" : "編集モード"),
+        variant: (loading || isReloading) ? "loading" : (isViewMode ? "view" : "edit")
+      }}
+      sidebarActions={
+        <>
+          {isViewMode ? (
+            <>
+              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={handleEditMode}>
+                編集
+              </button>
+              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={() => navigateBack()}>
+                戻る
+              </button>
+            </>
+          ) : (
+            <>
+              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={isSaving || isReloading} onClick={() => triggerSave({ redirect: true })}>
+                保存
+              </button>
+              <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" onClick={() => attemptLeave("cancel")}>
+                キャンセル
+              </button>
+            </>
+          )}
+          {entryIds.length > 0 && (
+            <>
+              <hr className="nf-sidebar-divider" />
+              <div className="nf-flex nf-gap-8 nf-items-center">
+                <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={!hasPrev} onClick={() => navigateToEntry(entryIds[currentIndex - 1])}>
+                  ← 前へ
+                </button>
+                <button type="button" className="nf-btn-outline nf-btn-sidebar nf-text-14" disabled={!hasNext} onClick={() => navigateToEntry(entryIds[currentIndex + 1])}>
+                  次へ →
+                </button>
+              </div>
+              <span className="nf-text-11 nf-text-muted">{currentIndex + 1} / {entryIds.length}</span>
+            </>
+          )}
+        </>
+      }
+    >
       {loading ? (
         <p className="nf-text-subtle">読み込み中...</p>
       ) : (
@@ -395,15 +394,14 @@ export default function FormPage() {
           readOnly={isViewMode || isReloading}
         />
       )}
-
-      <ConfirmDialog
-        open={confirmState.open}
-        title="未保存の変更があります"
-        message={confirmMessage}
-        options={confirmOptions}
-      />
-
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
-  );
-}
+
+      <ConfirmDialog
+        open={confirmState.open}
+        title="未保存の変更があります"
+        message={confirmMessage}
+        options={confirmOptions}
+      />
+
+</AppLayout>
+  );
+}
diff --git a/builder/src/pages/SearchPage.jsx b/builder/src/pages/SearchPage.jsx
index fa1c806..9be1f78 100644
--- a/builder/src/pages/SearchPage.jsx
+++ b/builder/src/pages/SearchPage.jsx
@@ -1,13 +1,12 @@
 import React, { useMemo, useState, useCallback, useEffect } from "react";
-import { useLocation, useNavigate, useSearchParams } from "react-router-dom";
-import AppLayout from "../app/components/AppLayout.jsx";
-import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
-import AlertDialog from "../app/components/AlertDialog.jsx";
-import { useAppData } from "../app/state/AppDataProvider.jsx";
-import { useAuth } from "../app/state/authContext.jsx";
-import { dataStore } from "../app/state/dataStore.js";
-import { useBuilderSettings } from "../features/settings/settingsStore.js";
-import { useAlert } from "../app/hooks/useAlert.js";
+import { useLocation, useNavigate, useSearchParams } from "react-router-dom";
+import AppLayout from "../app/components/AppLayout.jsx";
+import ConfirmDialog from "../app/components/ConfirmDialog.jsx";
+import { useAppData } from "../app/state/AppDataProvider.jsx";
+import { useAuth } from "../app/state/authContext.jsx";
+import { dataStore } from "../app/state/dataStore.js";
+import { useBuilderSettings } from "../features/settings/settingsStore.js";
+import { useAlert } from "../app/hooks/useAlert.js";
 import {
   buildSearchTableLayout,
   computeRowValues,
@@ -15,24 +14,24 @@ import {
   matchesKeyword,
   parseSearchCellDisplayLimit,
 } from "../features/search/searchTable.js";
-import { useEntriesWithCache } from "../features/search/useEntriesWithCache.js";
+import { useEntriesWithCache } from "../features/search/useEntriesWithCache.js";
 import SearchToolbar from "../features/search/components/SearchToolbar.jsx";
 import SearchSidebar from "../features/search/components/SearchSidebar.jsx";
 import SearchTable from "../features/search/components/SearchTable.jsx";
 import SearchPagination from "../features/search/components/SearchPagination.jsx";
 import { DEFAULT_THEME, applyThemeWithFallback } from "../app/theme/theme.js";
 import { DEFAULT_PAGE_SIZE } from "../core/constants.js";
-
-const buildInitialSort = (params) => {
-  const raw = params.get("sort");
-  if (!raw) return { key: "No.", order: "desc" };
-  const lastColonIndex = raw.lastIndexOf(":");
-  if (lastColonIndex === -1) return { key: raw, order: "desc" };
-  const key = raw.slice(0, lastColonIndex);
-  const order = raw.slice(lastColonIndex + 1);
-  return { key: key || "No.", order: order === "asc" ? "asc" : "desc" };
-};
-
+
+const buildInitialSort = (params) => {
+  const raw = params.get("sort");
+  if (!raw) return { key: "No.", order: "desc" };
+  const lastColonIndex = raw.lastIndexOf(":");
+  if (lastColonIndex === -1) return { key: raw, order: "desc" };
+  const key = raw.slice(0, lastColonIndex);
+  const order = raw.slice(lastColonIndex + 1);
+  return { key: key || "No.", order: order === "asc" ? "asc" : "desc" };
+};
+
 export default function SearchPage() {
   const { getFormById } = useAppData();
   const { settings } = useBuilderSettings();
@@ -40,58 +39,58 @@ export default function SearchPage() {
   const [searchParams, setSearchParams] = useSearchParams();
   const location = useLocation();
   const navigate = useNavigate();
-  const { alertState, showAlert, closeAlert } = useAlert();
-  const formId = (searchParams.get("form") || "").trim();
+  const { showAlert } = useAlert();
+const formId = (searchParams.get("form") || "").trim();
   const isScopedByQuery = scopedFormId !== "";
   const [showDeleteConfirm, setShowDeleteConfirm] = useState({ open: false, entryIds: [] });
   const [selectedEntries, setSelectedEntries] = useState(new Set());
-
-  const form = useMemo(() => (formId ? getFormById(formId) : null), [formId, getFormById]);
-  const activeSort = useMemo(() => buildInitialSort(searchParams), [searchParams]);
-  const query = searchParams.get("q") || "";
-  const page = Math.max(1, Number(searchParams.get("page") || 1));
-  const PAGE_SIZE = Number(settings?.pageSize) || DEFAULT_PAGE_SIZE;
-  const TABLE_MAX_WIDTH = settings?.searchTableMaxWidth ? Number(settings.searchTableMaxWidth) : null;
-  const cellDisplayLimit = parseSearchCellDisplayLimit(form?.settings?.searchCellMaxChars);
-
-  const {
-    entries,
-    headerMatrix,
-    loading,
-    backgroundLoading,
-    useCache,
-    lastSyncedAt,
-    cacheDisabled,
-    fetchAndCacheData,
-  } = useEntriesWithCache({
-    formId,
-    form,
-    locationKey: location.key,
-    locationState: location.state,
-    showAlert,
-  });
-
+
+  const form = useMemo(() => (formId ? getFormById(formId) : null), [formId, getFormById]);
+  const activeSort = useMemo(() => buildInitialSort(searchParams), [searchParams]);
+  const query = searchParams.get("q") || "";
+  const page = Math.max(1, Number(searchParams.get("page") || 1));
+  const PAGE_SIZE = Number(settings?.pageSize) || DEFAULT_PAGE_SIZE;
+  const TABLE_MAX_WIDTH = settings?.searchTableMaxWidth ? Number(settings.searchTableMaxWidth) : null;
+  const cellDisplayLimit = parseSearchCellDisplayLimit(form?.settings?.searchCellMaxChars);
+
+  const {
+    entries,
+    headerMatrix,
+    loading,
+    backgroundLoading,
+    useCache,
+    lastSyncedAt,
+    cacheDisabled,
+    fetchAndCacheData,
+  } = useEntriesWithCache({
+    formId,
+    form,
+    locationKey: location.key,
+    locationState: location.state,
+    showAlert,
+  });
+
   const { columns, headerRows } = useMemo(
     () => buildSearchTableLayout(form, { headerMatrix, includeOperations: false }),
     [form, headerMatrix],
   );
-
-  const handleSearchChange = (value) => {
-    const next = new URLSearchParams(searchParams);
-    if (value) next.set("q", value);
-    else next.delete("q");
-    next.set("page", "1");
-    setSearchParams(next);
-  };
-
-  const handleSortToggle = (key) => {
-    const next = new URLSearchParams(searchParams);
-    const current = buildInitialSort(next);
-    const order = current.key === key ? (current.order === "desc" ? "asc" : "desc") : "desc";
-    next.set("sort", `${key}:${order}`);
-    setSearchParams(next);
-  };
-
+
+  const handleSearchChange = (value) => {
+    const next = new URLSearchParams(searchParams);
+    if (value) next.set("q", value);
+    else next.delete("q");
+    next.set("page", "1");
+    setSearchParams(next);
+  };
+
+  const handleSortToggle = (key) => {
+    const next = new URLSearchParams(searchParams);
+    const current = buildInitialSort(next);
+    const order = current.key === key ? (current.order === "desc" ? "asc" : "desc") : "desc";
+    next.set("sort", `${key}:${order}`);
+    setSearchParams(next);
+  };
+
   const handlePageChange = (nextPage) => {
     const next = new URLSearchParams(searchParams);
     next.set("page", String(nextPage));
@@ -103,54 +102,54 @@ export default function SearchPage() {
     const theme = form?.settings?.theme || DEFAULT_THEME;
     void applyThemeWithFallback(theme, { persist: false });
   }, [form?.id, form?.settings?.theme, settings?.theme]);
-
-  const processedEntries = useMemo(() => entries.map((entry) => ({ entry, values: computeRowValues(entry, columns) })), [entries, columns]);
-
+
+  const processedEntries = useMemo(() => entries.map((entry) => ({ entry, values: computeRowValues(entry, columns) })), [entries, columns]);
+
   const ownerFilteredEntries = useMemo(() => {
     if (isAdmin) return processedEntries;
     if (!form?.settings?.showOwnRecordsOnly) return processedEntries;
     if (!userEmail) return processedEntries;
     return processedEntries.filter((row) => (row.entry?.createdBy || row.entry?.modifiedBy) === userEmail);
   }, [processedEntries, isAdmin, userEmail, form?.settings?.showOwnRecordsOnly]);
-
-  const filteredEntries = useMemo(() => {
-    const keyword = query.trim();
-    if (!keyword) return ownerFilteredEntries;
-    return ownerFilteredEntries.filter((row) => matchesKeyword(row, columns, keyword));
-  }, [ownerFilteredEntries, columns, query]);
-
-  const sortedEntries = useMemo(() => {
-    const list = filteredEntries.slice();
-    const targetColumn = columns.find((column) => column.key === activeSort.key && column.sortable !== false);
-    if (targetColumn) {
-      list.sort((a, b) => compareByColumn(a, b, targetColumn, activeSort.order));
-    }
-    return list;
-  }, [filteredEntries, columns, activeSort]);
-
-  const pagedEntries = useMemo(() => {
-    const start = (page - 1) * PAGE_SIZE;
-    return sortedEntries.slice(start, start + PAGE_SIZE);
-  }, [sortedEntries, page, PAGE_SIZE]);
-
-  const totalPages = Math.max(1, Math.ceil(sortedEntries.length / PAGE_SIZE));
-  const totalEntries = sortedEntries.length;
-  const startIndex = totalEntries === 0 ? 0 : (page - 1) * PAGE_SIZE + 1;
-  const endIndex = totalEntries === 0 ? 0 : Math.min(page * PAGE_SIZE, totalEntries);
-
-  const badge = useMemo(() => {
-    if (loading || backgroundLoading) return { label: "読み取り中...", variant: "loading" };
-    return { label: "検索画面", variant: "view" };
-  }, [loading, backgroundLoading]);
-
-  const handleRowClick = (entryId) => {
-    if (!formId) return;
-    const entryIds = sortedEntries.map((row) => row.entry.id);
-    navigate(`/form/${formId}/entry/${entryId}`, {
-      state: { from: `${location.pathname}${location.search}`, entryIds },
-    });
-  };
-
+
+  const filteredEntries = useMemo(() => {
+    const keyword = query.trim();
+    if (!keyword) return ownerFilteredEntries;
+    return ownerFilteredEntries.filter((row) => matchesKeyword(row, columns, keyword));
+  }, [ownerFilteredEntries, columns, query]);
+
+  const sortedEntries = useMemo(() => {
+    const list = filteredEntries.slice();
+    const targetColumn = columns.find((column) => column.key === activeSort.key && column.sortable !== false);
+    if (targetColumn) {
+      list.sort((a, b) => compareByColumn(a, b, targetColumn, activeSort.order));
+    }
+    return list;
+  }, [filteredEntries, columns, activeSort]);
+
+  const pagedEntries = useMemo(() => {
+    const start = (page - 1) * PAGE_SIZE;
+    return sortedEntries.slice(start, start + PAGE_SIZE);
+  }, [sortedEntries, page, PAGE_SIZE]);
+
+  const totalPages = Math.max(1, Math.ceil(sortedEntries.length / PAGE_SIZE));
+  const totalEntries = sortedEntries.length;
+  const startIndex = totalEntries === 0 ? 0 : (page - 1) * PAGE_SIZE + 1;
+  const endIndex = totalEntries === 0 ? 0 : Math.min(page * PAGE_SIZE, totalEntries);
+
+  const badge = useMemo(() => {
+    if (loading || backgroundLoading) return { label: "読み取り中...", variant: "loading" };
+    return { label: "検索画面", variant: "view" };
+  }, [loading, backgroundLoading]);
+
+  const handleRowClick = (entryId) => {
+    if (!formId) return;
+    const entryIds = sortedEntries.map((row) => row.entry.id);
+    navigate(`/form/${formId}/entry/${entryId}`, {
+      state: { from: `${location.pathname}${location.search}`, entryIds },
+    });
+  };
+
   const handleCreateNew = () => {
     if (!formId) return;
     navigate(`/form/${formId}/new`, {
@@ -168,51 +167,51 @@ export default function SearchPage() {
   const handleBackToMain = () => {
     navigate("/");
   };
-
-  const toggleSelectEntry = (entryId) => {
-    setSelectedEntries((prev) => {
-      const next = new Set(prev);
-      if (next.has(entryId)) next.delete(entryId);
-      else next.add(entryId);
-      return next;
-    });
-  };
-
-  const selectAllEntries = (checked) => {
-    if (checked) setSelectedEntries(new Set(pagedEntries.map((item) => item.entry.id)));
-    else setSelectedEntries(new Set());
-  };
-
-  const handleDeleteSelected = () => {
-    if (selectedEntries.size === 0) {
-      showAlert("削除する項目を選択してください。");
-      return;
-    }
-    setShowDeleteConfirm({ open: true, entryIds: Array.from(selectedEntries) });
-  };
-
-  const confirmDelete = useCallback(async () => {
-    if (!formId || showDeleteConfirm.entryIds.length === 0) return;
-    for (const entryId of showDeleteConfirm.entryIds) {
-      await dataStore.deleteEntry(formId, entryId);
-    }
-    await fetchAndCacheData();
-    setSelectedEntries(new Set());
-    setShowDeleteConfirm({ open: false, entryIds: [] });
-  }, [formId, showDeleteConfirm.entryIds, fetchAndCacheData]);
-
+
+  const toggleSelectEntry = (entryId) => {
+    setSelectedEntries((prev) => {
+      const next = new Set(prev);
+      if (next.has(entryId)) next.delete(entryId);
+      else next.add(entryId);
+      return next;
+    });
+  };
+
+  const selectAllEntries = (checked) => {
+    if (checked) setSelectedEntries(new Set(pagedEntries.map((item) => item.entry.id)));
+    else setSelectedEntries(new Set());
+  };
+
+  const handleDeleteSelected = () => {
+    if (selectedEntries.size === 0) {
+      showAlert("削除する項目を選択してください。");
+      return;
+    }
+    setShowDeleteConfirm({ open: true, entryIds: Array.from(selectedEntries) });
+  };
+
+  const confirmDelete = useCallback(async () => {
+    if (!formId || showDeleteConfirm.entryIds.length === 0) return;
+    for (const entryId of showDeleteConfirm.entryIds) {
+      await dataStore.deleteEntry(formId, entryId);
+    }
+    await fetchAndCacheData();
+    setSelectedEntries(new Set());
+    setShowDeleteConfirm({ open: false, entryIds: [] });
+  }, [formId, showDeleteConfirm.entryIds, fetchAndCacheData]);
+
   if (!formId || !form) {
     return (
       <AppLayout title="検索" fallbackPath="/" backHidden={false}>
         <p className="search-empty">
           {isAdmin
             ? "フォームが選択されていません。メイン画面からフォームを選択してください。"
-            : "フォームが見つかりません。正しいURLでアクセスしているか確認してください。"}
-        </p>
-      </AppLayout>
-    );
-  }
-
+            : "フォームが見つかりません。正しいURLでアクセスしているか確認してください。"}
+        </p>
+      </AppLayout>
+    );
+  }
+
   return (
     <AppLayout
       title={`検索 - ${form.settings?.formTitle || "(無題)"}`}
@@ -228,57 +227,56 @@ export default function SearchPage() {
           onDelete={handleDeleteSelected}
           onRefresh={fetchAndCacheData}
           useCache={useCache}
-          loading={loading}
-          selectedCount={selectedEntries.size}
-        />
-      )}
-    >
-      <SearchToolbar
-        query={query}
-        onChange={handleSearchChange}
-        lastSyncedAt={lastSyncedAt}
-        useCache={useCache}
-        cacheDisabled={cacheDisabled}
-      />
-
-      {loading ? (
-        <p className="search-loading">読み込み中...</p>
-      ) : (
-        <SearchTable
-          columns={columns}
-          headerRows={headerRows}
-          pagedEntries={pagedEntries}
-          selectedEntries={selectedEntries}
-          activeSort={activeSort}
-          cellDisplayLimit={cellDisplayLimit}
-          tableMaxWidth={TABLE_MAX_WIDTH}
-          onSortToggle={handleSortToggle}
-          onSelectAll={selectAllEntries}
-          onToggleSelect={toggleSelectEntry}
-          onRowClick={handleRowClick}
-        />
-      )}
-
-      <SearchPagination
-        page={page}
-        totalPages={totalPages}
-        totalEntries={totalEntries}
-        startIndex={startIndex}
-        endIndex={endIndex}
-        onChange={handlePageChange}
-      />
-
-      <ConfirmDialog
-        open={showDeleteConfirm.open}
-        title="レコードを削除"
-        message={`選択した${showDeleteConfirm.entryIds.length}件の回答を削除します。よろしいですか？`}
-        options={[
-          { label: "キャンセル", value: "cancel", onSelect: () => setShowDeleteConfirm({ open: false, entryIds: [] }) },
-          { label: "削除", value: "delete", variant: "danger", onSelect: confirmDelete },
-        ]}
-      />
-
-      <AlertDialog open={alertState.open} title={alertState.title} message={alertState.message} onClose={closeAlert} />
-    </AppLayout>
-  );
-}
+          loading={loading}
+          selectedCount={selectedEntries.size}
+        />
+      )}
+    >
+      <SearchToolbar
+        query={query}
+        onChange={handleSearchChange}
+        lastSyncedAt={lastSyncedAt}
+        useCache={useCache}
+        cacheDisabled={cacheDisabled}
+      />
+
+      {loading ? (
+        <p className="search-loading">読み込み中...</p>
+      ) : (
+        <SearchTable
+          columns={columns}
+          headerRows={headerRows}
+          pagedEntries={pagedEntries}
+          selectedEntries={selectedEntries}
+          activeSort={activeSort}
+          cellDisplayLimit={cellDisplayLimit}
+          tableMaxWidth={TABLE_MAX_WIDTH}
+          onSortToggle={handleSortToggle}
+          onSelectAll={selectAllEntries}
+          onToggleSelect={toggleSelectEntry}
+          onRowClick={handleRowClick}
+        />
+      )}
+
+      <SearchPagination
+        page={page}
+        totalPages={totalPages}
+        totalEntries={totalEntries}
+        startIndex={startIndex}
+        endIndex={endIndex}
+        onChange={handlePageChange}
+      />
+
+      <ConfirmDialog
+        open={showDeleteConfirm.open}
+        title="レコードを削除"
+        message={`選択した${showDeleteConfirm.entryIds.length}件の回答を削除します。よろしいですか？`}
+        options={[
+          { label: "キャンセル", value: "cancel", onSelect: () => setShowDeleteConfirm({ open: false, entryIds: [] }) },
+          { label: "削除", value: "delete", variant: "danger", onSelect: confirmDelete },
+        ]}
+      />
+
+</AppLayout>
+  );
+}
