# Nested Form Builder ユーザーマニュアル

**バージョン**: 2.0
**最終更新**: 2025年11月29日

---

## 目次

1. [はじめに](#はじめに)
2. [基本的な使い方](#基本的な使い方)
3. [フォームエディタの使い方](#フォームエディタの使い方)
4. [高度な機能](#高度な機能)
5. [回答の管理](#回答の管理)
6. [よくある質問](#よくある質問)
7. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### Nested Form Builderとは

Nested Form Builderは、階層構造を持つアンケートフォームを視覚的に作成できるWebアプリケーションです。プログラミングの知識がなくても、直感的な操作でフォームを作成し、回答をGoogle Sheetsに自動保存できます。

### 主な機能

- ✅ **ビジュアルエディタ**: 直感的な操作で簡単にフォームを作成
- ✅ **ネスト構造**: 条件に応じて次の質問を表示（最大6階層）
- ✅ **多様な質問タイプ**: テキスト、数値、日付、選択肢、チェックボックス、メッセージなど
- ✅ **Google Sheets連携**: 回答を自動的にスプレッドシートに保存
- ✅ **スタンドアロンHTML出力**: 生成されたフォームは単一のHTMLファイルとして配布可能
- ✅ **高度な検索機能**: AND/OR検索、比較演算、正規表現をサポート
- ✅ **データ管理**: インポート・エクスポート、アーカイブ機能
- ✅ **スタイル設定**: フィールドごとに文字サイズ・色をカスタマイズ可能
- ✅ **表示モード**: 通常/コンパクト/非表示の3種類のモード
- ✅ **パフォーマンス最適化**: IndexedDBキャッシュによる高速データ取得

### システム要件

- **ブラウザ**: Google Chrome、Firefox、Safari、Edge（最新版推奨）
- **Googleアカウント**: Google Sheetsにデータを保存するために必要
- **インターネット接続**: フォームの保存・取得時に必要

---

## 基本的な使い方

### 1. アプリケーションへのアクセス

Nested Form Builderは、Google Apps ScriptでデプロイされたWebアプリケーションです。

**アクセス方法**:
1. 管理者から提供されたWebアプリURLにアクセス
   - 例: `https://script.google.com/macros/s/AKfycbz_Efghn21JVp7WU8MuMZrdqEl1ylS9po1Se1UUtz_NDRdFDNVqwzgsayMx7ig5Mezg/exec`
2. または、プロジェクトルートの `.gas-deployment.json` ファイルで確認できます

> **💡 ヒント**: URLをブックマークしておくと、次回から簡単にアクセスできます。

### 2. 初回起動

ブラウザでNested Form Builderにアクセスすると、以下のようなメイン画面が表示されます。

![メイン画面](../.playwright-mcp/01_main_page.png)

- 「管理画面へ」ボタンをクリックすると、フォーム管理画面に移動します
- 作成済みのフォームがある場合は、カード形式で一覧表示されます
- 各フォームカードをクリックすると、検索画面に移動します

### 3. 管理画面

「管理画面へ」ボタンをクリックすると、フォーム管理画面が表示されます。

![管理ダッシュボード](../.playwright-mcp/02_admin_dashboard.png)

**管理画面でできること**:
- 新規フォームの作成
- フォームのインポート/エクスポート
- フォームのアーカイブ/削除
- フォームの編集
- 一覧の更新

### 4. 新しいフォームを作成する

#### Step 1: フォームの基本情報を設定

1. 管理画面で **「新規作成」** ボタンをクリック
2. 以下の情報を入力します：
   - **フォーム名**: フォームの識別名（例: 「顧客満足度調査」）
   - **説明**: フォームの目的や概要（任意）
   - **Google Drive保存先URL**: フォームデータを保存するGoogle DriveのフォルダまたはファイルURL（オプション）
     - 例: `https://drive.google.com/drive/folders/1prBDiRinhAw2mRJir_1BwGv4tSINJc28`

#### Step 2: Google Sheetsと連携

フォームの回答を保存するGoogle Sheetsを設定します。

![フォームエディタ](../.playwright-mcp/03_form_editor.png)

1. Google Sheetsで新しいスプレッドシートを作成
2. **Spreadsheet ID / URL** フィールドに以下のいずれかの形式で貼り付けます：
   - フルURL: `https://docs.google.com/spreadsheets/d/1Lj48NIuhyyc85MmrkxDjGnmTNQbxcAjUJf6Gu3faH-M/edit`
   - スプレッドシートID: `1Lj48NIuhyyc85MmrkxDjGnmTNQbxcAjUJf6Gu3faH-M`
3. **Sheet Name** を指定（デフォルト: `Responses`）

> **💡 ヒント**: スプレッドシートIDは、Google SheetsのURLの `/d/` と `/edit` の間にある長い文字列です（例: `1Lj48NIuhyyc85MmrkxDjGnmTNQbxcAjUJf6Gu3faH-M`）。

#### Step 3: 検索画面の設定

- **1画面あたりの表示件数**: 検索結果の1ページあたりの表示件数（デフォルト: 20）
- **検索結果テーブルの最大幅（px）**: テーブルの最大幅を指定（任意）
- **検索結果セルの表示文字数上限**: セル内の文字数上限を指定（任意）

### 5. 質問を追加する

#### 基本的な質問の追加

1. フォームエディタ画面で **「質問を追加」** ボタンをクリック
2. 質問の設定項目が表示されます：
   - **項目名**: 質問文（例: 「お名前を教えてください」）
   - **タイプ**: 質問の種類を選択（下記参照）
   - **必須**: チェックを入れると回答必須になります
   - **表示**: 検索結果に表示するかどうか
   - **スタイル設定**: 文字サイズ・色のカスタマイズ
   - **プレースホルダー**: 入力欄に表示されるヒントテキスト

#### 質問タイプの種類

![質問タイプドロップダウン](../.playwright-mcp/07_question_type_dropdown.png)

| タイプ | 説明 | 使用例 |
|--------|------|--------|
| **テキスト** | 1行の短いテキスト入力 | 名前、メールアドレス |
| **テキスト（複数行）** | 複数行の長文入力 | 意見、コメント |
| **数値** | 数字のみ入力可能 | 年齢、個数 |
| **日付** | 日付選択 | 誕生日、イベント日 |
| **時間** | 時刻選択 | 予約時間 |
| **ラジオ** | 単一選択 | 性別、満足度 |
| **チェックボックス** | 複数選択可能 | 趣味、興味のある分野 |
| **ドロップダウン** | ドロップダウンから選択 | 都道府県 |
| **正規表現** | カスタムバリデーション | 電話番号、郵便番号 |
| **メッセージ** | 説明文の表示（入力不要） | 注意事項、セクション見出し |

#### スタイル設定機能

各質問に対して、以下のスタイルをカスタマイズできます：

![スタイル設定の詳細](../.playwright-mcp/08_style_settings_expanded.png)

- **文字サイズ**: 小 (12px) / 通常 (14px) / 大 (18px) / 特大 (24px)
- **文字色**: 黒（デフォルト）/ 赤 / 青 / 緑 / グレー

### 6. フォームをプレビューする

「プレビュー」ボタンをクリックすると、実際のフォームの見た目を確認できます。

![プレビュー画面](../.playwright-mcp/04_preview.png)

プレビュー画面では：
- フォームの見た目を確認
- テスト入力して動作確認
- 検索プレビューで表示項目を確認

### 7. フォームを保存する

1. すべての設定が完了したら **「保存」** ボタンをクリック
2. 確認メッセージが表示されます
3. 管理画面に戻り、フォーム一覧に追加されます

### 8. フォームを公開する

#### HTMLファイルとしてエクスポート

1. フォーム一覧でフォームのチェックボックスを選択
2. **「エクスポート」** ボタンをクリック
3. JSON形式のフォーム定義ファイルがダウンロードされます

#### 特徴
- フォーム設定をJSON形式で保存
- 他の環境にインポート可能
- バックアップとして利用可能

---

## 回答の管理

### 検索画面

メイン画面でフォームカードをクリックすると、検索画面が表示されます。

![検索画面](../.playwright-mcp/05_search.png)

**検索画面でできること**:
- 回答データの一覧表示
- キーワード検索
- 新規入力
- レコードの削除
- データの更新

### 新規入力

「新規入力」ボタンをクリックすると、フォーム入力画面が表示されます。

![フォーム入力画面](../.playwright-mcp/06_form_input.png)

**フォーム入力画面の特徴**:
- 自動生成された回答ID
- 設定したスタイル（文字色、サイズ）が適用
- メッセージタイプのフィールドは入力不要

### 検索機能の使い方

#### 基本的なキーワード検索

検索ボックスにキーワードを入力すると、すべての列から一致するデータを検索します。

```
田中
```

#### 列を指定した検索

特定の列だけを検索するには、`列名:キーワード` の形式で入力します。

```
名前:田中
```

#### 比較演算子を使った検索

数値や日付の範囲を指定できます。

| 演算子 | 意味 | 例 |
|--------|------|-----|
| `=` | 等しい | `年齢=25` |
| `!=` | 等しくない | `性別!=男性` |
| `>` | より大きい | `年齢>30` |
| `>=` | 以上 | `年齢>=18` |
| `<` | より小さい | `年齢<65` |
| `<=` | 以下 | `年齢<=20` |

#### AND/OR検索

複数の条件を組み合わせることができます。

```
年齢>=18 AND 年齢<=65
```

```
性別=男性 OR 性別=女性
```

#### 正規表現検索

パターンマッチングが可能です。

```
電話番号 ~ /^090/
```

> **詳細**: より高度な検索方法は `docs/検索機能の使い方.md` を参照してください。

### ソートとページネーション

- **ソート**: 列名をクリックして昇順/降順を切り替え
- **ページネーション**: 画面下部のページ番号で移動
- **表示件数**: 1ページあたりの表示件数を設定で変更可能

### レコードの削除

#### 単一レコードの削除

1. 検索結果から削除したいレコードのチェックボックスを選択
2. 画面上部の **「削除」** ボタンをクリック
3. 確認ダイアログで **「削除」** を選択

#### 複数レコードの一括削除

1. 削除したいレコードのチェックボックスを複数選択
2. 画面上部の **「削除」** ボタンをクリック
3. 確認ダイアログで **「削除」** を選択

> ⚠️ **注意**: 削除したデータは復元できません。

---

## フォームエディタの使い方

### 質問の編集

既存の質問を編集するには：

1. 質問カードで設定を変更
2. **「保存」** をクリック

### 質問の削除

1. 質問カードの **「削除」** ボタンをクリック
2. 確認ダイアログで確認（実装されている場合）

> ⚠️ **注意**: 削除した質問は復元できません。子質問（ネストされた質問）も一緒に削除されます。

### 次の質問を追加（ネスト構造）

特定の質問の後に、条件付きで表示される子質問を追加できます。

![ネスト構造の例](../.playwright-mcp/10_nested_question_added.png)

1. 親質問の **「次の質問を追加」** ボタンをクリック
2. 子質問の設定を入力
3. 条件を設定（値による分岐を使用する場合）

#### ネストの特徴

- **最大6階層**まで質問をネスト可能
- 各階層で条件分岐を設定できます
- 条件に合わない場合、子質問は表示されません

### スタイル設定

「スタイル設定」チェックボックスをオンにすると、以下の設定が可能になります：

- **文字サイズ**: 小 (12px) / 通常 (14px) / 大 (18px) / 特大 (24px)
- **文字色**: 黒（デフォルト）/ 赤 / 青 / 緑 / グレー

例：年齢フィールドを赤色・通常サイズで表示

### プレースホルダー設定

「プレースホルダー」チェックボックスをオンにすると、入力欄にヒントテキストを表示できます。

![プレースホルダー設定](../.playwright-mcp/09_placeholder_settings.png)

### 選択肢の設定

ラジオボタン、チェックボックス、ドロップダウンの質問タイプでは、選択肢を設定できます。

![選択肢設定](../.playwright-mcp/11_radio_options_settings.png)

**選択肢設定の手順**:
1. 質問タイプで「ラジオ」「チェックボックス」「ドロップダウン」のいずれかを選択
2. 「選択肢」セクションが表示されます
3. **「選択肢を追加」** ボタンをクリックして選択肢を入力
4. 各選択肢に **「子質問追加」** ボタンが表示され、選択肢ごとに異なる子質問を追加可能
5. 不要な選択肢は **「削除」** ボタンで削除できます

---

## 高度な機能

### 表示モード

質問の「表示」チェックボックスで、検索結果への表示を制御できます。

- **表示ON**: 検索結果テーブルに表示される
- **表示OFF**: フォーム入力は可能だが、検索結果には表示されない

> **💡 用途**: 「表示OFF」は、自動計算される値やタイムスタンプなど、一覧表示が不要な項目に便利です。

### メッセージタイプ

「メッセージ」タイプを使用すると、入力不要の説明文やセクション見出しを表示できます。

**使用例**:
- セクションの区切り
- 注意事項の表示
- 説明文の挿入

### Google Drive連携

フォーム設定で「Google Drive保存先URL」を指定すると、回答データをGoogle Driveに保存できます。

**設定方法**:
- **空白**: ルートディレクトリに保存
- **フォルダURL**: そのフォルダにランダム名で保存
  - 例: `https://drive.google.com/drive/folders/1prBDiRinhAw2mRJir_1BwGv4tSINJc28`
- **ファイルURL**: 特定のファイルに保存
  - 例: `https://docs.google.com/spreadsheets/d/1Lj48NIuhyyc85MmrkxDjGnmTNQbxcAjUJf6Gu3faH-M/edit`

> **注意**: URLを変更すると新しい場所に保存され、元のファイルはそのまま残ります。

### スプレッドシートを開く

フォームエディタ画面の「📊 スプレッドシートを開く」ボタンをクリックすると、設定したGoogle Sheetsを直接開くことができます。

---

## フォームの管理

### フォームのエクスポート

1. フォーム一覧でエクスポートしたいフォームのチェックボックスを選択
2. **「エクスポート」** ボタンをクリック
3. JSON形式のファイルがダウンロードされます

### フォームのインポート

1. 管理画面で **「インポート」** ボタンをクリック
2. JSON形式のフォームファイルを選択
3. 既存のフォームと同じIDの場合、上書き確認が表示されます

### フォームのアーカイブ

使用しなくなったフォームをアーカイブできます。

1. フォーム一覧でアーカイブしたいフォームのチェックボックスを選択
2. **「アーカイブ」** ボタンをクリック
3. フォーム一覧から非表示になります

### フォームの削除

1. フォーム一覧で削除したいフォームのチェックボックスを選択
2. **「削除」** ボタンをクリック
3. 確認ダイアログで確認

> ⚠️ **注意**: 削除したフォームは復元できません。

---

## よくある質問

### Q1. フォームの回答はどこに保存されますか？

A: 設定したGoogle Sheetsに自動的に保存されます。スプレッドシートを開くと、以下の形式でデータが記録されています：

- **固定列**: `id`, `No.`, `createdAt`, `modifiedAt`
- **質問列**: 各質問の回答（ネストされた質問は `親質問|子質問` の形式）

### Q2. フォームの階層は何段階まで作成できますか？

A: 最大6階層までネスト可能です。それ以上の階層は作成できません。

### Q3. 回答者がインターネット接続なしでフォームに回答できますか？

A: いいえ、回答の送信にはインターネット接続が必要です。ただし、HTMLファイル自体はオフラインで開くことができます。

### Q4. 複数のフォームで同じGoogle Sheetsを使えますか？

A: 技術的には可能ですが、推奨しません。各フォームごとに専用のスプレッドシートを作成することをお勧めします。

### Q5. フォームのデザインをカスタマイズできますか？

A: スタイル設定機能で、フィールドごとに文字サイズと色をカスタマイズできます。より高度なカスタマイズは将来のバージョンで追加予定です。

### Q6. データをExcelにエクスポートできますか？

A: Google Sheetsから直接Excelファイル（.xlsx）をダウンロードできます：
1. Google Sheetsを開く
2. **ファイル** → **ダウンロード** → **Microsoft Excel (.xlsx)**

### Q7. パフォーマンスが遅いと感じたら？

A: 以下の最適化機能が実装されています：
- **IndexedDBキャッシュ**: フォームデータとレコードをローカルにキャッシュ
- **バックグラウンド更新**: キャッシュを使用しつつ、バックグラウンドで最新データを取得
- **パフォーマンスログ**: コンソールで `window.showPerfSummary()` を実行すると詳細を確認可能

---

## トラブルシューティング

### 問題: フォームが保存できない

**原因と解決方法**:
1. **フォーム名が空**: フォーム名を入力してください
2. **スプレッドシートIDが無効**: Google SheetsのURLを正しくコピーしているか確認
3. **ブラウザのストレージが満杯**: ブラウザのキャッシュをクリア

### 問題: 回答が Google Sheets に保存されない

**原因と解決方法**:
1. **スプレッドシートのアクセス権限がない**: スプレッドシートの共有設定を確認
2. **GAS Webアプリがデプロイされていない**: Google Apps Scriptをデプロイ
3. **スプレッドシートIDが正しくない**: 設定を再確認

### 問題: 検索結果が表示されない

**原因と解決方法**:
1. **スプレッドシートにデータがない**: 実際に回答が保存されているか確認
2. **検索クエリの構文エラー**: シンプルなキーワード検索で試してみる
3. **キャッシュが古い**: **「更新」** ボタンをクリック

### 問題: インポートしたフォームが正しく動作しない

**原因と解決方法**:
1. **JSONファイルが破損**: 元のファイルを再度エクスポート
2. **古いバージョンのフォーム**: 互換性の問題がある可能性があります
3. **必須フィールドが不足**: 少なくとも `schema` と `settings` が必要

### 問題: ブラウザが遅い・固まる

**原因と解決方法**:
1. **大量のフォームデータ**: 不要なフォームをアーカイブまたは削除
2. **ブラウザのメモリ不足**: ブラウザを再起動
3. **大量のレコード**: ページネーション設定を小さくする（10件/ページ）
4. **キャッシュのクリア**: ブラウザのIndexedDBをクリア

### 問題: デプロイ後にアクセスできない

**原因と解決方法**:
1. **デプロイ設定の確認**: Google Apps Script管理画面で「アクセスできるユーザー」を「全員」に設定
2. **ブラウザキャッシュのクリア**: 強制リロード（Ctrl+Shift+R または Cmd+Shift+R）
3. **デプロイURLの確認**: プロジェクトルートの `.gas-deployment.json` ファイルで最新のWebアプリURLを確認
   ```json
   {
     "deploymentId": "...",
     "webAppUrl": "https://script.google.com/macros/s/.../exec"
   }
   ```

---

## さらに詳しい情報

- **技術仕様書**: `docs/SPECIFICATIONS.md`（存在する場合）
- **検索機能の詳細**: `docs/検索機能の使い方.md`
- **開発者向けガイド**: `CLAUDE.md`

---

## サポート

問題が解決しない場合は、以下の情報を含めて開発チームにお問い合わせください：

- 使用しているブラウザとバージョン
- 発生している問題の詳細な説明
- エラーメッセージ（あれば）
- 問題が発生する手順

---

**最終更新**: 2025年11月29日
**作成**: Nested Form Builder Development Team
